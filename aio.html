<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en" data-bs-theme="auto">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Introduction to Geospatial Raster and Vector Data with R: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="assets/themetoggle.js"></script><link rel="stylesheet" type="text/css" href="assets/styles.css">
<script src="assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="favicons/dc/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicons/dc/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicons/dc/favicon-16x16.png">
<link rel="manifest" href="favicons/dc/site.webmanifest">
<link rel="mask-icon" href="favicons/dc/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="white">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="black">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md top-nav data"><svg xmlns="http://www.w3.org/2000/svg" class="d-none"><symbol id="check2" viewbox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"></path></symbol><symbol id="circle-half" viewbox="0 0 16 16"><path d="M8 15A7 7 0 1 0 8 1v14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"></path></symbol><symbol id="moon-stars-fill" viewbox="0 0 16 16"><path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"></path><path d="M10.794 3.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387a1.734 1.734 0 0 0-1.097 1.097l-.387 1.162a.217.217 0 0 1-.412 0l-.387-1.162A1.734 1.734 0 0 0 9.31 6.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387a1.734 1.734 0 0 0 1.097-1.097l.387-1.162zM13.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.156 1.156 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.156 1.156 0 0 0-.732-.732l-.774-.258a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"></path></symbol><symbol id="sun-fill" viewbox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"></path></symbol></svg><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-8">
      <div class="large-logo">
        <img id="dc-logo" alt="Data Carpentry" src="assets/images/data-logo.svg">
</div>
    </div>
    <div class="selector-container">
      <div id="theme-selector">
        <li class="nav-item dropdown" id="theme-button-list">
          <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
            <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="bd-theme-text">
<li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                Light
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                Dark
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
            <li>
              <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                Auto
                <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
            </li>
          </ul>
</li>
      </div>

      <div class="dropdown" id="instructor-dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Learner View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='instructor/aio.html';">Instructor View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl bottom-nav data" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Data Carpentry" src="assets/images/data-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Introduction to Geospatial Raster and Vector Data with R
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
        <i role="img" aria-label="Search the All In One page" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Introduction to Geospatial Raster and Vector Data with R
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="reference.html#glossary">Glossary</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="profiles.html">Learner Profiles</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
<li><a class="dropdown-item" href="discuss.html">Discussion</a></li>
<li><a class="dropdown-item" href="reference.html"></a></li>
          </ul>
</li>
      </ul>
</div>
    <!--
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
      <input class="form-control me-2 searchbox" type="search" placeholder="" aria-label="">
        <button class="btn btn-outline-success tablet-search-button"  type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="Search the All In One page"></i>
        </button>
      </fieldset>
    </form>
    -->
    <a id="search-button" class="btn btn-primary" href="aio.html" role="button" aria-label="Search the All In One page">Search the All In One page</a>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to Geospatial Raster and Vector Data with R
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress data">
    <div class="progress-bar data" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
<div id="sidebar-col" class="col-lg-4">
  <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle" data-collapse="Collapse " data-episodes="Episodes ">
          <i class="search-icon" data-feather="x" role="img"></i>
        </button>
        <div class="sidebar-inner">
          <div class="row mobile-row" id="theme-row-mobile">
            <div class="col" id="theme-selector">
              <li class="nav-item dropdown" id="theme-button-list">
                <button class="btn btn-link nav-link px-0 px-lg-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme (auto)">
                  <svg class="bi my-1 theme-icon-active"><use href="#circle-half"></use></svg><span class="d-lg-none ms-1" id="bd-theme-text">Toggle Theme</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-theme-text">
<li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#sun-fill"></use></svg>
                      Light
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
                      <svg class="bi me-2 theme-icon"><use href="#moon-stars-fill"></use></svg>
                      Dark
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                  <li>
                    <button type="button" class="btn dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
                      <svg class="bi me-2 theme-icon"><use href="#circle-half"></use></svg>
                      Auto
                      <svg class="bi ms-auto d-none"><use href="#check2"></use></svg></button>
                  </li>
                </ul>
</li>
            </div>
          </div>
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Learner View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="instructor/aio.html">Instructor View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->

            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Setup</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="01-raster-structure.html">1. Intro to Raster Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="02-raster-plot.html">2. Plot Raster Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="03-raster-reproject-in-r.html">3. Reproject Raster Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="04-raster-calculations-in-r.html">4. Raster Calculations</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="05-raster-multi-band-in-r.html">5. Work with Multi-Band Rasters</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="06-vector-open-shapefile-in-r.html">6. Open and Plot Vector Layers</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="07-vector-shapefile-attributes-in-r.html">7. Explore and Plot by Vector Layer Attributes</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="08-vector-plot-shapefiles-custom-legend.html">8. Plot Multiple Vector Layers</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="09-vector-when-data-dont-line-up-crs.html">9. Handling Spatial Projection &amp; CRS</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="10-vector-csv-to-shapefile-in-r.html">10. Convert from .csv to a Vector Layer</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush12">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading12">
        <a href="11-vector-raster-integration.html">11. Manipulate Raster Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush13">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading13">
        <a href="12-time-series-raster.html">12. Raster Time Series Data</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush14">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading14">
        <a href="13-plot-time-series-rasters-in-r.html">13. Create Publication-quality Graphics</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush15">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading15">
        <a href="14-extract-ndvi-from-rasters-in-r.html">14. Derive Values from Raster Time Series</a>
    </div>
<!--/div.accordion-header-->

  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush lesson-resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="lesson-resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="reference.html#glossary">Glossary</a>
                      </li>
                      <li>
                        <a href="profiles.html">Learner Profiles</a>
                      </li>
                      <li><a href="discuss.html">Discussion</a></li>
<li><a href="reference.html"></a></li>
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width lesson-resources">
<a href="aio.html">See all in one page</a>


            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">

            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-01-raster-structure"><p>Content from <a href="01-raster-structure.html">Intro to Raster Data</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/01-raster-structure.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What is a raster dataset?</li>
<li>How do I work with and plot raster data in R?</li>
<li>How can I handle missing or bad data values for a raster?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Describe the fundamental attributes of a raster dataset.</li>
<li>Explore raster attributes and metadata using R.</li>
<li>Import rasters into R using the <code>terra</code> package.</li>
<li>Plot a raster file in R using the <code>ggplot2</code> package.</li>
<li>Describe the difference between single- and multi-band rasters.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>In this episode, we will introduce the fundamental principles,
packages and metadata/raster attributes that are needed to work with
raster data in R. We will discuss some of the core metadata elements
that we need to understand to work with rasters in R, including CRS and
resolution. We will also explore missing and bad data values as stored
in a raster and how R handles these elements.</p>
<p>We will continue to work with the <code>dplyr</code> and
<code>ggplot2</code> packages that were introduced in the <a href="https://datacarpentry.org/r-intro-geospatial/" class="external-link">Introduction to R
for Geospatial Data</a> lesson. We will use two additional packages in
this episode to work with raster data - the <code>terra</code> and
<code>sf</code> packages. Make sure that you have these packages
loaded.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">dplyr</span><span class="op">)</span></span></code></pre>
</div>
<div id="introduce-the-data" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="introduce-the-data" class="callout-inner">
<h3 class="callout-title">Introduce the Data</h3>
<div class="callout-content">
<p>If not already discussed, introduce the datasets that will be used in
this lesson. A brief introduction to the datasets can be found on the <a href="https://datacarpentry.org/geospatial-workshop/#data" class="external-link">Geospatial
workshop homepage</a>.</p>
<p>For more detailed information about the datasets, check out the <a href="https://datacarpentry.org/geospatial-workshop/data/" class="external-link">Geospatial
workshop data page</a>.</p>
</div>
</div>
</div>
<section><h2 class="section-heading" id="view-raster-file-attributes">View Raster File Attributes<a class="anchor" aria-label="anchor" href="#view-raster-file-attributes"></a>
</h2>
<hr class="half-width">
<p>We will be working with a series of GeoTIFF files in this lesson. The
GeoTIFF format contains a set of embedded tags with metadata about the
raster data. We can use the function <code>describe()</code> to get
information about our raster data before we read that data into R. It is
ideal to do this before importing your data.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"
 [3] "Size is 1697, 1367"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731453.000000000000000,4713838.000000000000000)"
[45] "Pixel Size = (1.000000000000000,-1.000000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=BAND"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731453.000, 4713838.000) ( 72d10'52.71\"W, 42d32'32.18\"N)"
[53] "Lower Left  (  731453.000, 4712471.000) ( 72d10'54.71\"W, 42d31'47.92\"N)"
[54] "Upper Right (  733150.000, 4713838.000) ( 72d 9'38.40\"W, 42d32'30.35\"N)"
[55] "Lower Right (  733150.000, 4712471.000) ( 72d 9'40.41\"W, 42d31'46.08\"N)"
[56] "Center      (  732301.500, 4713154.500) ( 72d10'16.56\"W, 42d32' 9.13\"N)"
[57] "Band 1 Block=1697x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=305.070 Max=416.070 "
[59] "  Minimum=305.070, Maximum=416.070, Mean=359.853, StdDev=17.832"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=416.06997680664"
[63] "    STATISTICS_MEAN=359.85311802914"
[64] "    STATISTICS_MINIMUM=305.07000732422"
[65] "    STATISTICS_STDDEV=17.83169335933"                                                                                                                                                                                                                                          </code></pre>
</div>
<p>If you wish to store this information in R, you can do the
following:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HARV_dsmCrop_info</span> <span class="op">&lt;-</span> <span class="fu">capture.output</span><span class="op">(</span></span>
<span>  <span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Each line of text that was printed to the console is now stored as an
element of the character vector <code>HARV_dsmCrop_info</code>. We will
be exploring this data throughout this episode. By the end of this
episode, you will be able to explain and understand the output
above.</p>
</section><section><h2 class="section-heading" id="open-a-raster-in-r">Open a Raster in R<a class="anchor" aria-label="anchor" href="#open-a-raster-in-r"></a>
</h2>
<hr class="half-width">
<p>Now that we’ve previewed the metadata for our GeoTIFF, let’s import
this raster dataset into R and explore its metadata more closely. We can
use the <code>rast()</code> function to open a raster in R.</p>
<div id="data-tip---object-names" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip---object-names" class="callout-inner">
<h3 class="callout-title">Data Tip - Object names</h3>
<div class="callout-content">
<p>To improve code readability, file and object names should be used
that make it clear what is in the file. The data for this episode were
collected from Harvard Forest so we’ll use a naming convention of
<code>datatype_HARV</code>.</p>
</div>
</div>
</div>
<p>First we will load our raster file into R and view the data
structure.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DSM_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 1367, 1697, 1  (nrow, ncol, nlyr)
resolution  : 1, 1  (x, y)
extent      : 731453, 733150, 4712471, 4713838  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_dsmCrop.tif
name        : HARV_dsmCrop
min value   :       305.07
max value   :       416.07 </code></pre>
</div>
<p>The information above includes a report of min and max values, but no
other data range statistics. Similar to other R data structures like
vectors and data frame columns, descriptive statistics for raster data
can be retrieved like</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: [summary] used a sample</code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  HARV_dsmCrop
 Min.   :305.6
 1st Qu.:345.6
 Median :359.6
 Mean   :359.8
 3rd Qu.:374.3
 Max.   :414.7  </code></pre>
</div>
<p>but note the warning - unless you force R to calculate these
statistics using every cell in the raster, it will take a random sample
of 100,000 cells and calculate from that instead. To force calculation
all the values, you can use the function <code>values</code>:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  HARV_dsmCrop
 Min.   :305.1
 1st Qu.:345.6
 Median :359.7
 Mean   :359.9
 3rd Qu.:374.3
 Max.   :416.1  </code></pre>
</div>
<p>To visualise this data in R using <code>ggplot2</code>, we need to
convert it to a dataframe. We learned about dataframes in <a href="https://datacarpentry.org/r-intro-geospatial/04-data-structures-part2/index.html" class="external-link">an
earlier lesson</a>. The <code>terra</code> package has an built-in
function for conversion to a plotable dataframe.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Now when we view the structure of our data, we will see a standard
dataframe format.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">str</span><span class="op">(</span><span class="va">DSM_HARV_df</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	2319799 obs. of  3 variables:
 $ x           : num  731454 731454 731456 731456 731458 ...
 $ y           : num  4713838 4713838 4713838 4713838 4713838 ...
 $ HARV_dsmCrop: num  409 408 407 407 409 ...</code></pre>
</div>
<p>We can use <code>ggplot()</code> to plot this data. We will set the
color scale to <code>scale_fill_viridis_c</code> which is a
color-blindness friendly color scale. We will also use the
<code>coord_quickmap()</code> function to use an approximate Mercator
projection for our plots. This approximation is suitable for small areas
that are not too close to the poles. Other coordinate systems are
available in ggplot2 if needed, you can learn about them at their help
page <code>?coord_map</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/01-raster-structure-rendered-ggplot-raster-1.png" alt="Raster plot with ggplot2 using the viridis color scale" class="figure mx-auto d-block"><figcaption>
Raster plot with ggplot2 using the viridis color scale
</figcaption></figure><div id="plotting-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="plotting-tip" class="callout-inner">
<h3 class="callout-title">Plotting Tip</h3>
<div class="callout-content">
<p>More information about the Viridis palette used above at <a href="https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html" class="external-link">R
Viridis package documentation</a>.</p>
</div>
</div>
</div>
<div id="plotting-tip-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="plotting-tip-1" class="callout-inner">
<h3 class="callout-title">Plotting Tip</h3>
<div class="callout-content">
<p>For faster, simpler plots, you can use the <code>plot</code> function
from the <code>terra</code> package.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show plot
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>See <code>?plot</code> for more arguments to customize the plot</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-unnamed-chunk-7-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<p>This map shows the elevation of our study site in Harvard Forest.
From the legend, we can see that the maximum elevation is ~400, but we
can’t tell whether this is 400 feet or 400 meters because the legend
doesn’t show us the units.</p>
<p>Unfortunately, nothing in the technical metadata (that which is built
into the file format) tells us what the <em>vertical</em> resolution is.
For now you will have to trust us that it is meters.</p>
<p>However, we can look at the metadata of our object to see what the
horizontal units are: in other words how many meters from the origin are
the x and y points. That metadata, is part of the CRS. We introduced the
concept of a CRS in <a href="https://datacarpentry.org/organization-geospatial/03-crs" class="external-link">an
earlier lesson</a>.</p>
<p>Now we will see how features of the CRS appear in our data file and
what meanings they have.</p>
<div class="section level3">
<h3 id="view-raster-coordinate-reference-system-crs-in-r">View Raster Coordinate Reference System (CRS) in R<a class="anchor" aria-label="anchor" href="#view-raster-coordinate-reference-system-crs-in-r"></a>
</h3>
<p>We can view the CRS string associated with our R object using
the<code>crs()</code> function.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">DSM_HARV</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs"</code></pre>
</div>
<div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>What units are our horizontal data in?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p><code>+units=m</code> tells us that our data is in meters.</p>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="understanding-crs-in-proj4-format">Understanding CRS in Proj4 Format<a class="anchor" aria-label="anchor" href="#understanding-crs-in-proj4-format"></a>
</h2>
<hr class="half-width">
<p>The CRS for our data is given to us by R in <code>proj4</code>
format. Let’s break down the pieces of <code>proj4</code> string. The
string contains all of the individual CRS elements that R or another GIS
might need. Each element is specified with a <code>+</code> sign,
similar to how a <code>.csv</code> file is delimited or broken up by a
<code>,</code>. After each <code>+</code> we see the CRS element being
defined. For example projection (<code>proj=</code>) and datum
(<code>datum=</code>).</p>
<div class="section level3">
<h3 id="utm-proj4-string">UTM Proj4 String<a class="anchor" aria-label="anchor" href="#utm-proj4-string"></a>
</h3>
<p>A projection string (like the one of <code>DSM_HARV</code>) specifies
the UTM projection as follows:</p>
<p><code>+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0</code></p>
<ul>
<li>
<strong>proj=utm:</strong> the projection is UTM, UTM has several
zones.</li>
<li>
<strong>zone=18:</strong> the zone is 18</li>
<li>
<strong>datum=WGS84:</strong> the datum is WGS84 (the datum refers
to the 0,0 reference for the coordinate system used in the
projection)</li>
<li>
<strong>units=m:</strong> the units for the coordinates are in
meters</li>
<li>
<strong>ellps=WGS84:</strong> the ellipsoid (how the earth’s
roundness is calculated) for the data is WGS84</li>
</ul>
<p>Note that the zone is unique to the UTM projection. Not all CRSs will
have a zone. Image source: Chrismurf at English Wikipedia, via <a href="https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system#/media/File:Utm-zones-USA.svg" class="external-link">Wikimedia
Commons</a> (CC-BY).</p>
<figure><img src="fig/Utm-zones-USA.svg" alt="UTM zones in the USA." class="figure mx-auto d-block"><div class="figcaption">The UTM zones across the continental United
States. From: <a href="https://upload.wikimedia.org/wikipedia/commons/8/8d/Utm-zones-USA.svg" class="external-link uri">https://upload.wikimedia.org/wikipedia/commons/8/8d/Utm-zones-USA.svg</a>
</div>
</figure>
</div>
</section><section><h2 class="section-heading" id="calculate-raster-min-and-max-values">Calculate Raster Min and Max Values<a class="anchor" aria-label="anchor" href="#calculate-raster-min-and-max-values"></a>
</h2>
<hr class="half-width">
<p>It is useful to know the minimum or maximum values of a raster
dataset. In this case, given we are working with elevation data, these
values represent the min/max elevation range at our site.</p>
<p>Raster statistics are often calculated and embedded in a GeoTIFF for
us. We can view these values:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">minmax</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>    HARV_dsmCrop
min       305.07
max       416.07</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">min</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 305.07</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">max</span><span class="op">(</span><span class="fu">values</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 416.07</code></pre>
</div>
<div id="data-tip---set-min-and-max-values" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip---set-min-and-max-values" class="callout-inner">
<h3 class="callout-title">Data Tip - Set min and max values</h3>
<div class="callout-content">
<p>If the minimum and maximum values haven’t already been calculated, we
can calculate them using the <code>setMinMax()</code> function.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV</span> <span class="op">&lt;-</span> <span class="fu">setMinMax</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
<p>We can see that the elevation at our site ranges from 305.0700073m to
416.0699768m.</p>
</section><section><h2 class="section-heading" id="raster-bands">Raster Bands<a class="anchor" aria-label="anchor" href="#raster-bands"></a>
</h2>
<hr class="half-width">
<p>The Digital Surface Model object (<code>DSM_HARV</code>) that we’ve
been working with is a single band raster. This means that there is only
one dataset stored in the raster: surface elevation in meters for one
time period.</p>
<figure><img src="fig/dc-spatial-raster/single_multi_raster.png" alt="Multi-band raster image" class="figure mx-auto d-block"></figure><p>A raster dataset can contain one or more bands. We can use the
<code>rast()</code> function to import one single band from a single or
multi-band raster. We can view the number of bands in a raster using the
<code>nlyr()</code> function.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">nlyr</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1</code></pre>
</div>
<p>However, raster data can also be multi-band, meaning that one raster
file contains data for more than one variable or time period for each
cell. Jump to a later episode in this series for information on working
with multi-band rasters: <a href="05-raster-multi-band-in-r/">Work with
Multi-band Rasters in R</a>.</p>
</section><section><h2 class="section-heading" id="dealing-with-missing-data">Dealing with Missing Data<a class="anchor" aria-label="anchor" href="#dealing-with-missing-data"></a>
</h2>
<hr class="half-width">
<p>Raster data often has a <code>NoDataValue</code> associated with it.
This is a value assigned to pixels where data is missing or no data were
collected.</p>
<p>By default the shape of a raster is always rectangular. So if we have
a dataset that has a shape that isn’t rectangular, some pixels at the
edge of the raster will have <code>NoDataValue</code>s. This often
happens when the data were collected by an airplane which only flew over
some part of a defined region.</p>
<p>In the image below, the pixels that are black have
<code>NoDataValue</code>s. The camera did not collect data in these
areas.</p>
<figure><img src="fig/01-raster-structure-rendered-demonstrate-no-data-black-ggplot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>In the next image, the black edges have been assigned
<code>NoDataValue</code>. R doesn’t render pixels that contain a
specified <code>NoDataValue</code>. R assigns missing data with the
<code>NoDataValue</code> as <code>NA</code>.</p>
<p>The difference here shows up as ragged edges on the plot, rather than
black spaces where there is no data.</p>
<figure><img src="fig/01-raster-structure-rendered-demonstrate-no-data-ggplot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If your raster already has <code>NA</code> values set correctly but
you aren’t sure where they are, you can deliberately plot them in a
particular colour. This can be useful when checking a dataset’s
coverage. For instance, sometimes data can be missing where a sensor
could not ‘see’ its target data, and you may wish to locate that missing
data and fill it in.</p>
<p>To highlight <code>NA</code> values in ggplot, alter the
<code>scale_fill_*()</code> layer to contain a colour instruction for
<code>NA</code> values, like
<code>scale_fill_viridis_c(na.value = 'deeppink')</code></p>
<figure><img src="fig/01-raster-structure-rendered-unnamed-chunk-9-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The value that is conventionally used to take note of missing data
(the <code>NoDataValue</code> value) varies by the raster data type. For
floating-point rasters, the figure <code>-3.4e+38</code> is a common
default, and for integers, <code>-9999</code> is common. Some
disciplines have specific conventions that vary from these common
values.</p>
<p>In some cases, other <code>NA</code> values may be more appropriate.
An <code>NA</code> value should be a) outside the range of valid values,
and b) a value that fits the data type in use. For instance, if your
data ranges continuously from -20 to 100, 0 is not an acceptable
<code>NA</code> value! Or, for categories that number 1-15, 0 might be
fine for <code>NA</code>, but using -.000003 will force you to save the
GeoTIFF on disk as a floating point raster, resulting in a bigger
file.</p>
<p>If we are lucky, our GeoTIFF file has a tag that tells us what is the
<code>NoDataValue</code>. If we are less lucky, we can find that
information in the raster’s metadata. If a <code>NoDataValue</code> was
stored in the GeoTIFF tag, when R opens up the raster, it will assign
each instance of the value to <code>NA</code>. Values of <code>NA</code>
will be ignored by R as demonstrated above.</p>
<div id="challenge-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-1" class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Use the output from the <code>describe()</code> and
<code>sources()</code> functions to find out what
<code>NoDataValue</code> is used for our <code>DSM_HARV</code>
dataset.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Answers
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="fu">sources</span><span class="op">(</span><span class="va">DSM_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: /home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"
 [3] "Size is 1697, 1367"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731453.000000000000000,4713838.000000000000000)"
[45] "Pixel Size = (1.000000000000000,-1.000000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=BAND"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731453.000, 4713838.000) ( 72d10'52.71\"W, 42d32'32.18\"N)"
[53] "Lower Left  (  731453.000, 4712471.000) ( 72d10'54.71\"W, 42d31'47.92\"N)"
[54] "Upper Right (  733150.000, 4713838.000) ( 72d 9'38.40\"W, 42d32'30.35\"N)"
[55] "Lower Right (  733150.000, 4712471.000) ( 72d 9'40.41\"W, 42d31'46.08\"N)"
[56] "Center      (  732301.500, 4713154.500) ( 72d10'16.56\"W, 42d32' 9.13\"N)"
[57] "Band 1 Block=1697x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=305.070 Max=416.070 "
[59] "  Minimum=305.070, Maximum=416.070, Mean=359.853, StdDev=17.832"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=416.06997680664"
[63] "    STATISTICS_MEAN=359.85311802914"
[64] "    STATISTICS_MINIMUM=305.07000732422"
[65] "    STATISTICS_STDDEV=17.83169335933"                                                                                                                                                                                                                                          </code></pre>
</div>
<p><code>NoDataValue</code> are encoded as -9999.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="bad-data-values-in-rasters">Bad Data Values in Rasters<a class="anchor" aria-label="anchor" href="#bad-data-values-in-rasters"></a>
</h2>
<hr class="half-width">
<p>Bad data values are different from <code>NoDataValue</code>s. Bad
data values are values that fall outside of the applicable range of a
dataset.</p>
<p>Examples of Bad Data Values:</p>
<ul>
<li>The normalized difference vegetation index (NDVI), which is a
measure of greenness, has a valid range of -1 to 1. Any value outside of
that range would be considered a “bad” or miscalculated value.</li>
<li>Reflectance data in an image will often range from 0-1 or 0-10,000
depending upon how the data are scaled. Thus a value greater than 1 or
greater than 10,000 is likely caused by an error in either data
collection or processing.</li>
</ul>
<div class="section level3">
<h3 id="find-bad-data-values">Find Bad Data Values<a class="anchor" aria-label="anchor" href="#find-bad-data-values"></a>
</h3>
<p>Sometimes a raster’s metadata will tell us the range of expected
values for a raster. Values outside of this range are suspect and we
need to consider that when we analyze the data. Sometimes, we need to
use some common sense and scientific insight as we examine the data -
just as we would for field data to identify questionable values.</p>
<p>Plotting data with appropriate highlighting can help reveal patterns
in bad values and may suggest a solution. Below, reclassification is
used to highlight elevation values over 400m with a contrasting
colour.</p>
<figure><img src="fig/01-raster-structure-rendered-demo-bad-data-highlighting-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</section><section><h2 class="section-heading" id="create-a-histogram-of-raster-values">Create A Histogram of Raster Values<a class="anchor" aria-label="anchor" href="#create-a-histogram-of-raster-values"></a>
</h2>
<hr class="half-width">
<p>We can explore the distribution of values contained within our raster
using the <code>geom_histogram()</code> function which produces a
histogram. Histograms are often useful in identifying outliers and bad
data values in our raster data.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-view-raster-histogram-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Notice that a warning message is thrown when R creates the
histogram.</p>
<p><code>stat_bin()</code> using <code>bins = 30</code>. Pick better
value with <code>binwidth</code>.</p>
<p>This warning is caused by a default setting in
<code>geom_histogram</code> enforcing that there are 30 bins for the
data. We can define the number of bins we want in the histogram by using
the <code>bins</code> value in the <code>geom_histogram()</code>
function.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span>, bins <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/01-raster-structure-rendered-view-raster-histogram2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Note that the shape of this histogram looks similar to the previous
one that was created using the default of 30 bins. The distribution of
elevation values for our <code>Digital Surface Model (DSM)</code> looks
reasonable. It is likely there are no bad data values in this particular
raster.</p>
<div id="challenge-explore-raster-metadata" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-raster-metadata" class="callout-inner">
<h3 class="callout-title">Challenge: Explore Raster Metadata</h3>
<div class="callout-content">
<p>Use <code>describe()</code> to determine the following about the
<code>NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_DSMhill.tif</code>
file:</p>
<ol style="list-style-type: decimal">
<li>Does this file have the same CRS as <code>DSM_HARV</code>?</li>
<li>What is the <code>NoDataValue</code>?</li>
<li>What is resolution of the raster data?</li>
<li>How large would a 5x5 pixel area be on the Earth’s surface?</li>
<li>Is the file a multi- or single-band raster?</li>
</ol>
<p>Notice: this file is a hillshade. We will learn about hillshades in
the <a href="05-raster-multi-band-in-r/">Working with Multi-band Rasters
in R</a> episode.</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Answers
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_DSMhill.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_DSMhill.tif"
 [3] "Size is 1697, 1367"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731453.000000000000000,4713838.000000000000000)"
[45] "Pixel Size = (1.000000000000000,-1.000000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=BAND"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731453.000, 4713838.000) ( 72d10'52.71\"W, 42d32'32.18\"N)"
[53] "Lower Left  (  731453.000, 4712471.000) ( 72d10'54.71\"W, 42d31'47.92\"N)"
[54] "Upper Right (  733150.000, 4713838.000) ( 72d 9'38.40\"W, 42d32'30.35\"N)"
[55] "Lower Right (  733150.000, 4712471.000) ( 72d 9'40.41\"W, 42d31'46.08\"N)"
[56] "Center      (  732301.500, 4713154.500) ( 72d10'16.56\"W, 42d32' 9.13\"N)"
[57] "Band 1 Block=1697x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=-0.714 Max=1.000 "
[59] "  Minimum=-0.714, Maximum=1.000, Mean=0.313, StdDev=0.481"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=0.99999973665016"
[63] "    STATISTICS_MEAN=0.31255246777216"
[64] "    STATISTICS_MINIMUM=-0.71362979358008"
[65] "    STATISTICS_STDDEV=0.48129385401108"                                                                                                                                                                                                                                        </code></pre>
</div>
<ol style="list-style-type: decimal">
<li>If this file has the same CRS as DSM_HARV? Yes: UTM Zone 18, WGS84,
meters.</li>
<li>What format <code>NoDataValues</code> take? -9999</li>
<li>The resolution of the raster data? 1x1</li>
<li>How large a 5x5 pixel area would be? 5mx5m How? We are given
resolution of 1x1 and units in meters, therefore resolution of 5x5 means
5x5m.</li>
<li>Is the file a multi- or single-band raster? Single.</li>
</ol>
</div>
</div>
</div>
</div>
<div id="more-resources" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources</h3>
<div class="callout-content">
<ul>
<li><a href="https://cran.r-project.org/package=terra" class="external-link">Read more about
the <code>terra</code> package in R.</a></li>
</ul>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>The GeoTIFF file format includes metadata about the raster
data.</li>
<li>To plot raster data with the <code>ggplot2</code> package, we need
to convert it to a dataframe.</li>
<li>R stores CRS information in the Proj4 format.</li>
<li>Be careful when dealing with missing or bad data values.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-02-raster-plot"><p>Content from <a href="02-raster-plot.html">Plot Raster Data</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/02-raster-plot.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create categorized or customized maps of raster data?</li>
<li>How can I customize the color scheme of a raster image?</li>
<li>How can I layer raster data in a single image?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Build customized plots for a single band raster using the
<code>ggplot2</code> package.</li>
<li>Layer a raster dataset on top of a hillshade to create an elegant
basemap.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<section><h2 class="section-heading" id="plot-raster-data-in-r">Plot Raster Data in R<a class="anchor" aria-label="anchor" href="#plot-raster-data-in-r"></a>
</h2>
<hr class="half-width">
<p>This episode covers how to plot a raster in R using the
<code>ggplot2</code> package with customized coloring schemes. It also
covers how to layer a raster on top of a hillshade to produce an
eloquent map. We will continue working with the Digital Surface Model
(DSM) raster for the NEON Harvard Forest Field Site.</p>
</section><section><h2 class="section-heading" id="plotting-data-using-breaks">Plotting Data Using Breaks<a class="anchor" aria-label="anchor" href="#plotting-data-using-breaks"></a>
</h2>
<hr class="half-width">
<p>In the previous episode, we viewed our data using a continuous color
ramp. For clarity and visibility of the plot, we may prefer to view the
data “symbolized” or colored according to ranges of values. This is
comparable to a “classified” map. To do this, we need to tell
<code>ggplot</code> how many groups to break our data into, and where
those breaks should be. To make these decisions, it is useful to first
explore the distribution of the data using a bar plot. To begin with, we
will use <code>dplyr</code>’s <code>mutate()</code> function combined
with <code>cut()</code> to split the data into 3 bins.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV_df</span> <span class="op">&lt;-</span> <span class="va">DSM_HARV_df</span> <span class="op">%&gt;%</span></span>
<span>                <span class="fu">mutate</span><span class="op">(</span>fct_elevation <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">HARV_dsmCrop</span>, breaks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_bar</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">fct_elevation</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-histogram-breaks-ggplot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If we want to know the cutoff values for the groups, we can ask for
the unique values of <code>fct_elevation</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">DSM_HARV_df</span><span class="op">$</span><span class="va">fct_elevation</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] (379,416] (342,379] (305,342]
Levels: (305,342] (342,379] (379,416]</code></pre>
</div>
<p>And we can get the count of values in each group using
<code>dplyr</code>’s <code>count()</code> function:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV_df</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">count</span><span class="op">(</span><span class="va">fct_elevation</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  fct_elevation       n
1     (305,342]  418891
2     (342,379] 1530073
3     (379,416]  370835</code></pre>
</div>
<p>We might prefer to customize the cutoff values for these groups. Lets
round the cutoff values so that we have groups for the ranges of 301–350
m, 351–400 m, and 401–450 m. To implement this we will give
<code>mutate()</code> a numeric vector of break points instead of the
number of breaks we want.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_bins</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">300</span>, <span class="fl">350</span>, <span class="fl">400</span>, <span class="fl">450</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DSM_HARV_df</span> <span class="op">&lt;-</span> <span class="va">DSM_HARV_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>fct_elevation_2 <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">HARV_dsmCrop</span>, breaks <span class="op">=</span> <span class="va">custom_bins</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">unique</span><span class="op">(</span><span class="va">DSM_HARV_df</span><span class="op">$</span><span class="va">fct_elevation_2</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] (400,450] (350,400] (300,350]
Levels: (300,350] (350,400] (400,450]</code></pre>
</div>
<div id="data-tips" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tips" class="callout-inner">
<h3 class="callout-title">Data Tips</h3>
<div class="callout-content">
<p>Note that when we assign break values a set of 4 values will result
in 3 bins of data.</p>
<p>The bin intervals are shown using <code>(</code> to mean exclusive
and <code>]</code> to mean inclusive. For example:
<code>(305, 342]</code> means “from 306 through 342”.</p>
</div>
</div>
</div>
<p>And now we can plot our bar plot again, using the new groups:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_bar</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">fct_elevation_2</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-histogram-custom-breaks-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>And we can get the count of values in each group in the same way we
did before:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV_df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">count</span><span class="op">(</span><span class="va">fct_elevation_2</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  fct_elevation_2       n
1       (300,350]  741815
2       (350,400] 1567316
3       (400,450]   10668</code></pre>
</div>
<p>We can use those groups to plot our raster data, with each group
being a different color:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">fct_elevation_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-raster-with-breaks-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The plot above uses the default colors inside <code>ggplot</code> for
raster objects. We can specify our own colors to make the plot look a
little nicer. R has a built in set of colors for plotting terrain, which
are built in to the <code>terrain.colors()</code> function. Since we
have three bins, we want to create a 3-color palette:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "#00A600" "#ECB176" "#F2F2F2"</code></pre>
</div>
<p>The <code>terrain.colors()</code> function returns <em>hex
colors</em> - each of these character strings represents a color. To use
these in our map, we pass them across using the
<code>scale_fill_manual()</code> function.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span> <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                      fill <span class="op">=</span> <span class="va">fct_elevation_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-ggplot-breaks-customcolors-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div class="section level3">
<h3 id="more-plot-formatting">More Plot Formatting<a class="anchor" aria-label="anchor" href="#more-plot-formatting"></a>
</h3>
<p>If we need to create multiple plots using the same color palette, we
can create an R object (<code>my_col</code>) for the set of colors that
we want to use. We can then quickly change the palette across all plots
by modifying the <code>my_col</code> object, rather than each individual
plot.</p>
<p>We can label the x- and y-axes of our plot too using
<code>xlab</code> and <code>ylab</code>. We can also give the legend a
more meaningful title by passing a value to the <code>name</code>
argument of the <code>scale_fill_manual()</code> function.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_col</span> <span class="op">&lt;-</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span> <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                      fill <span class="op">=</span> <span class="va">fct_elevation_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">my_col</span>, name <span class="op">=</span> <span class="st">"Elevation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-add-ggplot-labels-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Or we can also turn off the labels of both axes by passing
<code>element_blank()</code> to the relevant part of the
<code>theme()</code> function.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span> <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                      fill <span class="op">=</span> <span class="va">fct_elevation_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">my_col</span>, name <span class="op">=</span> <span class="st">"Elevation"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-turn-off-axes-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-plot-using-custom-breaks" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-using-custom-breaks" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Using Custom Breaks</h3>
<div class="callout-content">
<p>Create a plot of the Harvard Forest Digital Surface Model (DSM) that
has:</p>
<ol style="list-style-type: decimal">
<li>Six classified ranges of values (break points) that are evenly
divided among the range of pixel values.</li>
<li>Axis labels.</li>
<li>A plot title.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_HARV_df</span> <span class="op">&lt;-</span> <span class="va">DSM_HARV_df</span>  <span class="op">%&gt;%</span></span>
<span>               <span class="fu">mutate</span><span class="op">(</span>fct_elevation_6 <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">HARV_dsmCrop</span>, breaks <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span> <span class="va">my_col</span> <span class="op">&lt;-</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">6</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                      fill <span class="op">=</span> <span class="va">fct_elevation_6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">my_col</span>, name <span class="op">=</span> <span class="st">"Elevation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Classified Elevation Map - NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"UTM Easting Coordinate (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"UTM Northing Coordinate (m)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-challenge-code-plotting-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="layering-rasters">Layering Rasters<a class="anchor" aria-label="anchor" href="#layering-rasters"></a>
</h2>
<hr class="half-width">
<p>We can layer a raster on top of a hillshade raster for the same area,
and use a transparency factor to create a 3-dimensional shaded effect. A
hillshade is a raster that maps the shadows and texture that you would
see from above when viewing terrain. We will add a custom color, making
the plot grey.</p>
<p>First we need to read in our DSM hillshade data and view the
structure:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_hill_HARV</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_DSMhill.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DSM_hill_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 1367, 1697, 1  (nrow, ncol, nlyr)
resolution  : 1, 1  (x, y)
extent      : 731453, 733150, 4712471, 4713838  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_DSMhill.tif
name        : HARV_DSMhill
min value   :   -0.7136298
max value   :    0.9999997 </code></pre>
</div>
<p>Next we convert it to a dataframe, so that we can plot it using
<code>ggplot2</code>:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DSM_hill_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_hill_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">DSM_hill_HARV_df</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	2313675 obs. of  3 variables:
 $ x           : num  731454 731456 731456 731458 731458 ...
 $ y           : num  4713836 4713836 4713836 4713836 4713836 ...
 $ HARV_DSMhill: num  -0.15567 0.00743 0.86989 0.9791 0.96283 ...</code></pre>
</div>
<p>Now we can plot the hillshade data:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_hill_HARV_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">HARV_DSMhill</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_alpha</span><span class="op">(</span>range <span class="op">=</span>  <span class="fu">c</span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.65</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-raster-hillshade-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="data-tips-1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tips-1" class="callout-inner">
<h3 class="callout-title">Data Tips</h3>
<div class="callout-content">
<p>Turn off, or hide, the legend on a plot by adding
<code>guide = "none"</code> to a <code>scale_something()</code> function
or by setting <code>theme(legend.position = "none")</code>.</p>
<p>The alpha value determines how transparent the colors will be (0
being transparent, 1 being opaque).</p>
</div>
</div>
</div>
<p>We can layer another raster on top of our hillshade by adding another
call to the <code>geom_raster()</code> function. Let’s overlay
<code>DSM_HARV</code> on top of the <code>hill_HARV</code>.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , </span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  fill <span class="op">=</span> <span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_hill_HARV_df</span>, </span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  alpha <span class="op">=</span> <span class="va">HARV_DSMhill</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">scale_alpha</span><span class="op">(</span>range <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.65</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Elevation with hillshade"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-overlay-hillshade-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-create-dtm-dsm-for-sjer" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-create-dtm-dsm-for-sjer" class="callout-inner">
<h3 class="callout-title">Challenge: Create DTM &amp; DSM for SJER</h3>
<div class="callout-content">
<p>Use the files in the
<code>data/NEON-DS-Airborne-Remote-Sensing/SJER/</code> directory to
create a Digital Terrain Model map and Digital Surface Model map of the
San Joaquin Experimental Range field site.</p>
<p>Make sure to:</p>
<ul>
<li>include hillshade in the maps,</li>
<li>label axes on the DSM map and exclude them from the DTM map,</li>
<li>include a title for each map,</li>
<li>experiment with various alpha values and color palettes to represent
the data.</li>
</ul>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CREATE DSM MAPS</span></span>
<span></span>
<span><span class="co"># import DSM data</span></span>
<span><span class="va">DSM_SJER</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif"</span><span class="op">)</span></span>
<span><span class="co"># convert to a df for plotting</span></span>
<span><span class="va">DSM_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># import DSM hillshade</span></span>
<span><span class="va">DSM_hill_SJER</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmHill.tif"</span><span class="op">)</span></span>
<span><span class="co"># convert to a df for plotting</span></span>
<span><span class="va">DSM_hill_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_hill_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build Plot</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_SJER_df</span> , </span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                     fill <span class="op">=</span> <span class="va">SJER_dsmCrop</span>,</span>
<span>                     alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span>                <span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_hill_SJER_df</span>, </span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  alpha <span class="op">=</span> <span class="va">SJER_dsmHill</span><span class="op">)</span></span>
<span>                <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_alpha</span><span class="op">(</span>range <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co"># remove grey background and grid lines</span></span>
<span>    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, </span>
<span>          panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"UTM Easting Coordinate (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"UTM Northing Coordinate (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"DSM with Hillshade"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-challenge-hillshade-layering-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CREATE DTM MAP</span></span>
<span><span class="co"># import DTM</span></span>
<span><span class="va">DTM_SJER</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmCrop.tif"</span><span class="op">)</span></span>
<span><span class="va">DTM_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DTM_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># DTM Hillshade</span></span>
<span><span class="va">DTM_hill_SJER</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmHill.tif"</span><span class="op">)</span></span>
<span><span class="va">DTM_hill_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DTM_hill_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_SJER_df</span> ,</span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                     fill <span class="op">=</span> <span class="va">SJER_dtmCrop</span>,</span>
<span>                     alpha <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span></span>
<span>                <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_hill_SJER_df</span>,</span>
<span>                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                  alpha <span class="op">=</span> <span class="va">SJER_dtmHill</span><span class="op">)</span></span>
<span>                <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_fill_viridis_c</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">guides</span><span class="op">(</span>fill <span class="op">=</span> <span class="fu">guide_colorbar</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_alpha</span><span class="op">(</span>range <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.7</span><span class="op">)</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>, </span>
<span>          panel.grid.minor <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>axis.title.x <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          axis.title.y <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"DTM with Hillshade"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/02-raster-plot-rendered-challenge-hillshade-layering-2.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Continuous data ranges can be grouped into categories using
<code>mutate()</code> and <code>cut()</code>.</li>
<li>Use built-in <code>terrain.colors()</code> or set your preferred
color scheme manually.</li>
<li>Layer rasters on top of one another by using the <code>alpha</code>
aesthetic.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-03-raster-reproject-in-r"><p>Content from <a href="03-raster-reproject-in-r.html">Reproject Raster Data</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/03-raster-reproject-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I work with raster data sets that are in different
projections?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Reproject a raster in R.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>Sometimes we encounter raster datasets that do not “line up” when
plotted or analyzed. Rasters that don’t line up are most often in
different Coordinate Reference Systems (CRS). This episode explains how
to deal with rasters in different, known CRSs. It will walk though
reprojecting rasters in R using the <code>project()</code> function in
the <code>terra</code> package.</p>
<section><h2 class="section-heading" id="raster-projection-in-r">Raster Projection in R<a class="anchor" aria-label="anchor" href="#raster-projection-in-r"></a>
</h2>
<hr class="half-width">
<p>In the <a href="02-raster-plot/">Plot Raster Data in R</a> episode,
we learned how to layer a raster file on top of a hillshade for a nice
looking basemap. In that episode, all of our data were in the same CRS.
What happens when things don’t line up?</p>
<p>For this episode, we will be working with the Harvard Forest Digital
Terrain Model data. This differs from the surface model data we’ve been
working with so far in that the digital surface model (DSM) includes the
tops of trees, while the digital terrain model (DTM) shows the ground
level.</p>
<p>We’ll be looking at another model (the canopy height model) in <a href="04-raster-calculations-in-r/">a later episode</a> and will see how
to calculate the CHM from the DSM and DTM. Here, we will create a map of
the Harvard Forest Digital Terrain Model (<code>DTM_HARV</code>) draped
or layered on top of the hillshade (<code>DTM_hill_HARV</code>). The
hillshade layer maps the terrain using light and shadow to create a
3D-looking image, based on a hypothetical illumination of the ground
level.</p>
<figure><img src="fig/dc-spatial-raster/lidarTree-height.png" alt="Source: National Ecological Observatory Network (NEON)." class="figure mx-auto d-block"></figure><p>First, we need to import the DTM and DTM hillshade data.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DTM_HARV</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DTM_hill_HARV</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_DTMhill_WGS84.tif"</span><span class="op">)</span></span></code></pre>
</div>
<p>Next, we will convert each of these datasets to a dataframe for
plotting with <code>ggplot</code>.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DTM_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DTM_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DTM_hill_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DTM_hill_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can create a map of the DTM layered over the hillshade.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_HARV_df</span> , </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  fill <span class="op">=</span> <span class="va">HARV_dtmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_hill_HARV_df</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                   alpha <span class="op">=</span> <span class="va">HARV_DTMhill_WGS84</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/03-raster-reproject-in-r-rendered-unnamed-chunk-2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Our results are curious - neither the Digital Terrain Model
(<code>DTM_HARV_df</code>) nor the DTM Hillshade
(<code>DTM_hill_HARV_df</code>) plotted. Let’s try to plot the DTM on
its own to make sure there are data there.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_HARV_df</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    fill <span class="op">=</span> <span class="va">HARV_dtmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/03-raster-reproject-in-r-rendered-plot-DTM-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Our DTM seems to contain data and plots just fine.</p>
<p>Next we plot the DTM Hillshade on its own to see whether everything
is OK.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_hill_HARV_df</span>,</span>
<span>    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>    alpha <span class="op">=</span> <span class="va">HARV_DTMhill_WGS84</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/03-raster-reproject-in-r-rendered-plot-DTM-hill-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If we look at the axes, we can see that the projections of the two
rasters are different. When this is the case, <code>ggplot</code> won’t
render the image. It won’t even throw an error message to tell you
something has gone wrong. We can look at Coordinate Reference Systems
(CRSs) of the DTM and the hillshade data to see how they differ.</p>
<div id="exercise" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise" class="callout-inner">
<h3 class="callout-title">Exercise</h3>
<div class="callout-content">
<p>View the CRS for each of these two datasets. What projection does
each use?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view crs for DTM</span></span>
<span><span class="fu">crs</span><span class="op">(</span><span class="va">DTM_HARV</span>, parse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [2] "    BASEGEOGCRS[\"WGS 84\","
 [3] "        DATUM[\"World Geodetic System 1984\","
 [4] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [5] "                LENGTHUNIT[\"metre\",1]]],"
 [6] "        PRIMEM[\"Greenwich\",0,"
 [7] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
 [8] "        ID[\"EPSG\",4326]],"
 [9] "    CONVERSION[\"UTM zone 18N\","
[10] "        METHOD[\"Transverse Mercator\","
[11] "            ID[\"EPSG\",9807]],"
[12] "        PARAMETER[\"Latitude of natural origin\",0,"
[13] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[14] "            ID[\"EPSG\",8801]],"
[15] "        PARAMETER[\"Longitude of natural origin\",-75,"
[16] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[17] "            ID[\"EPSG\",8802]],"
[18] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[19] "            SCALEUNIT[\"unity\",1],"
[20] "            ID[\"EPSG\",8805]],"
[21] "        PARAMETER[\"False easting\",500000,"
[22] "            LENGTHUNIT[\"metre\",1],"
[23] "            ID[\"EPSG\",8806]],"
[24] "        PARAMETER[\"False northing\",0,"
[25] "            LENGTHUNIT[\"metre\",1],"
[26] "            ID[\"EPSG\",8807]]],"
[27] "    CS[Cartesian,2],"
[28] "        AXIS[\"(E)\",east,"
[29] "            ORDER[1],"
[30] "            LENGTHUNIT[\"metre\",1]],"
[31] "        AXIS[\"(N)\",north,"
[32] "            ORDER[2],"
[33] "            LENGTHUNIT[\"metre\",1]],"
[34] "    USAGE["
[35] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[36] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[37] "        BBOX[0,-78,84,-72]],"
[38] "    ID[\"EPSG\",32618]]"                                                                                                                                                                                                                                                       </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># view crs for hillshade</span></span>
<span><span class="fu">crs</span><span class="op">(</span><span class="va">DTM_hill_HARV</span>, parse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "GEOGCRS[\"WGS 84\","
 [2] "    DATUM[\"World Geodetic System 1984\","
 [3] "        ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [4] "            LENGTHUNIT[\"metre\",1]]],"
 [5] "    PRIMEM[\"Greenwich\",0,"
 [6] "        ANGLEUNIT[\"degree\",0.0174532925199433]],"
 [7] "    CS[ellipsoidal,2],"
 [8] "        AXIS[\"geodetic latitude (Lat)\",north,"
 [9] "            ORDER[1],"
[10] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[11] "        AXIS[\"geodetic longitude (Lon)\",east,"
[12] "            ORDER[2],"
[13] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[14] "    ID[\"EPSG\",4326]]"                                </code></pre>
</div>
<p><code>DTM_HARV</code> is in the UTM projection, with units of meters.
<code>DTM_hill_HARV</code> is in <code>Geographic WGS84</code> - which
is represented by latitude and longitude values.</p>
</div>
</div>
</div>
</div>
<p>Because the two rasters are in different CRSs, they don’t line up
when plotted in R. We need to reproject (or change the projection of)
<code>DTM_hill_HARV</code> into the UTM CRS. Alternatively, we could
reproject <code>DTM_HARV</code> into WGS84.</p>
</section><section><h2 class="section-heading" id="reproject-rasters">Reproject Rasters<a class="anchor" aria-label="anchor" href="#reproject-rasters"></a>
</h2>
<hr class="half-width">
<p>We can use the <code>project()</code> function to reproject a raster
into a new CRS. Keep in mind that reprojection only works when you first
have a defined CRS for the raster object that you want to reproject. It
cannot be used if no CRS is defined. Lucky for us, the
<code>DTM_hill_HARV</code> has a defined CRS.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>When we reproject a raster, we move it from one “grid” to another.
Thus, we are modifying the data! Keep this in mind as we work with
raster data.</p>
</div>
</div>
</div>
<p>To use the <code>project()</code> function, we need to define two
things:</p>
<ol style="list-style-type: decimal">
<li>the object we want to reproject and</li>
<li>the CRS that we want to reproject it to.</li>
</ol>
<p>The syntax is <code>project(RasterObject, crs)</code></p>
<p>We want the CRS of our hillshade to match the <code>DTM_HARV</code>
raster. We can thus assign the CRS of our <code>DTM_HARV</code> to our
hillshade within the <code>project()</code> function as follows:
<code>crs(DTM_HARV)</code>. Note that we are using the
<code>project()</code> function on the raster object, not the
<code>data.frame()</code> we use for plotting with
<code>ggplot</code>.</p>
<p>First we will reproject our <code>DTM_hill_HARV</code> raster data to
match the <code>DTM_HARV</code> raster CRS:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DTM_hill_UTMZ18N_HARV</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">DTM_hill_HARV</span>,</span>
<span>                                 <span class="fu">crs</span><span class="op">(</span><span class="va">DTM_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can compare the CRS of our original DTM hillshade and our new
DTM hillshade, to see how they are different.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">DTM_hill_UTMZ18N_HARV</span>, parse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [2] "    BASEGEOGCRS[\"WGS 84\","
 [3] "        DATUM[\"World Geodetic System 1984\","
 [4] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [5] "                LENGTHUNIT[\"metre\",1]]],"
 [6] "        PRIMEM[\"Greenwich\",0,"
 [7] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
 [8] "        ID[\"EPSG\",4326]],"
 [9] "    CONVERSION[\"UTM zone 18N\","
[10] "        METHOD[\"Transverse Mercator\","
[11] "            ID[\"EPSG\",9807]],"
[12] "        PARAMETER[\"Latitude of natural origin\",0,"
[13] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[14] "            ID[\"EPSG\",8801]],"
[15] "        PARAMETER[\"Longitude of natural origin\",-75,"
[16] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[17] "            ID[\"EPSG\",8802]],"
[18] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[19] "            SCALEUNIT[\"unity\",1],"
[20] "            ID[\"EPSG\",8805]],"
[21] "        PARAMETER[\"False easting\",500000,"
[22] "            LENGTHUNIT[\"metre\",1],"
[23] "            ID[\"EPSG\",8806]],"
[24] "        PARAMETER[\"False northing\",0,"
[25] "            LENGTHUNIT[\"metre\",1],"
[26] "            ID[\"EPSG\",8807]]],"
[27] "    CS[Cartesian,2],"
[28] "        AXIS[\"(E)\",east,"
[29] "            ORDER[1],"
[30] "            LENGTHUNIT[\"metre\",1]],"
[31] "        AXIS[\"(N)\",north,"
[32] "            ORDER[2],"
[33] "            LENGTHUNIT[\"metre\",1]],"
[34] "    USAGE["
[35] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[36] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[37] "        BBOX[0,-78,84,-72]],"
[38] "    ID[\"EPSG\",32618]]"                                                                                                                                                                                                                                                       </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">DTM_hill_HARV</span>, parse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "GEOGCRS[\"WGS 84\","
 [2] "    DATUM[\"World Geodetic System 1984\","
 [3] "        ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [4] "            LENGTHUNIT[\"metre\",1]]],"
 [5] "    PRIMEM[\"Greenwich\",0,"
 [6] "        ANGLEUNIT[\"degree\",0.0174532925199433]],"
 [7] "    CS[ellipsoidal,2],"
 [8] "        AXIS[\"geodetic latitude (Lat)\",north,"
 [9] "            ORDER[1],"
[10] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[11] "        AXIS[\"geodetic longitude (Lon)\",east,"
[12] "            ORDER[2],"
[13] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[14] "    ID[\"EPSG\",4326]]"                                </code></pre>
</div>
<p>We can also compare the extent of the two objects.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ext</span><span class="op">(</span><span class="va">DTM_hill_UTMZ18N_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SpatExtent : 731402.31567604, 733200.22199435, 4712407.19751409, 4713901.78222079 (xmin, xmax, ymin, ymax)</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ext</span><span class="op">(</span><span class="va">DTM_hill_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SpatExtent : -72.1819236223343, -72.1606102223342, 42.5294079700285, 42.5423355900285 (xmin, xmax, ymin, ymax)</code></pre>
</div>
<p>Notice in the output above that the <code>crs()</code> of
<code>DTM_hill_UTMZ18N_HARV</code> is now UTM. However, the extent
values of <code>DTM_hillUTMZ18N_HARV</code> are different from
<code>DTM_hill_HARV</code>.</p>
<div id="challenge-extent-change-with-crs-change" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-extent-change-with-crs-change" class="callout-inner">
<h3 class="callout-title">Challenge: Extent Change with CRS Change</h3>
<div class="callout-content">
<p>Why do you think the two extents differ?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Answers </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>The extent for DTM_hill_UTMZ18N_HARV is in UTMs so the extent is in
meters. The extent for DTM_hill_HARV is in lat/long so the extent is
expressed in decimal degrees.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="deal-with-raster-resolution">Deal with Raster Resolution<a class="anchor" aria-label="anchor" href="#deal-with-raster-resolution"></a>
</h2>
<hr class="half-width">
<p>Let’s next have a look at the resolution of our reprojected hillshade
versus our original data.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">res</span><span class="op">(</span><span class="va">DTM_hill_UTMZ18N_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1.001061 1.001061</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">res</span><span class="op">(</span><span class="va">DTM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1 1</code></pre>
</div>
<p>These two resolutions are different, but they’re representing the
same data. We can tell R to force our newly reprojected raster to be 1m
x 1m resolution by adding a line of code <code>res=1</code> within the
<code>project()</code> function. In the example below, we ensure a
resolution match by using <code>res(DTM_HARV)</code> as a variable.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">DTM_hill_UTMZ18N_HARV</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">DTM_hill_HARV</span>, </span>
<span>                                   <span class="fu">crs</span><span class="op">(</span><span class="va">DTM_HARV</span><span class="op">)</span>, </span>
<span>                                   res <span class="op">=</span> <span class="fu">res</span><span class="op">(</span><span class="va">DTM_HARV</span><span class="op">)</span><span class="op">)</span> </span></code></pre>
</div>
<p>Now both our resolutions and our CRSs match, so we can plot these two
data sets together. Let’s double-check our resolution to be sure:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">res</span><span class="op">(</span><span class="va">DTM_hill_UTMZ18N_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1 1</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">res</span><span class="op">(</span><span class="va">DTM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1 1</code></pre>
</div>
<p>For plotting with <code>ggplot()</code>, we will need to create a
dataframe from our newly reprojected raster.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DTM_hill_HARV_2_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DTM_hill_UTMZ18N_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>We can now create a plot of this data.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_HARV_df</span> , </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  fill <span class="op">=</span> <span class="va">HARV_dtmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_hill_HARV_2_df</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                   alpha <span class="op">=</span> <span class="va">HARV_DTMhill_WGS84</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/03-raster-reproject-in-r-rendered-plot-projected-raster-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We have now successfully draped the Digital Terrain Model on top of
our hillshade to produce a nice looking, textured map!</p>
<div id="challenge-reproject-then-plot-a-digital-terrain-model" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-reproject-then-plot-a-digital-terrain-model" class="callout-inner">
<h3 class="callout-title">Challenge: Reproject, then Plot a Digital Terrain Model</h3>
<div class="callout-content">
<p>Create a map of the <a href="https://www.neonscience.org/field-sites/field-sites-map/SJER" class="external-link">San
Joaquin Experimental Range</a> field site using the
<code>SJER_DSMhill_WGS84.tif</code> and <code>SJER_dsmCrop.tif</code>
files.</p>
<p>Reproject the data as necessary to make things line up!</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Answers </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># import DSM</span></span>
<span><span class="va">DSM_SJER</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif"</span><span class="op">)</span></span>
<span><span class="co"># import DSM hillshade</span></span>
<span><span class="va">DSM_hill_SJER_WGS</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_DSMhill_WGS84.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># reproject raster</span></span>
<span><span class="va">DSM_hill_UTMZ18N_SJER</span> <span class="op">&lt;-</span> <span class="fu">project</span><span class="op">(</span><span class="va">DSM_hill_SJER_WGS</span>,</span>
<span>                                 <span class="fu">crs</span><span class="op">(</span><span class="va">DSM_SJER</span><span class="op">)</span>,</span>
<span>                                 res <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># convert to data.frames</span></span>
<span><span class="va">DSM_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">DSM_hill_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">DSM_hill_UTMZ18N_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_hill_SJER_df</span>, </span>
<span>                 <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                   alpha <span class="op">=</span> <span class="va">SJER_DSMhill_WGS84</span><span class="op">)</span></span>
<span>                 <span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_SJER_df</span>, </span>
<span>             <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                  fill <span class="op">=</span> <span class="va">SJER_dsmCrop</span>,</span>
<span>                  alpha<span class="op">=</span><span class="fl">0.8</span><span class="op">)</span></span>
<span>             <span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/03-raster-reproject-in-r-rendered-challenge-code-reprojection-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="challenge-reproject-then-plot-a-digital-terrain-model" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-reproject-then-plot-a-digital-terrain-model" class="callout-inner">
<h3 class="callout-title">Challenge: Reproject, then Plot a Digital
Terrain Model<em> (continued)</em>
</h3>
<div class="callout-content">
<p>If you completed the San Joaquin plotting challenge in the <a href="02-raster-plot/">Plot Raster Data in R</a> episode, how does the
map you just created compare to that map?</p>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Answers </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>The maps look identical. Which is what they should be as the only
difference is this one was reprojected from WGS84 to UTM prior to
plotting.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>In order to plot two raster data sets together, they must be in the
same CRS.</li>
<li>Use the <code>project()</code> function to convert between
CRSs.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-04-raster-calculations-in-r"><p>Content from <a href="04-raster-calculations-in-r.html">Raster Calculations</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/04-raster-calculations-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How do I subtract one raster from another and extract pixel values
for defined locations?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Perform a subtraction between two rasters using raster math.</li>
<li>Perform a more efficient subtraction between two rasters using the
raster <code>lapp()</code> function.</li>
<li>Export raster data as a GeoTIFF file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>We often want to combine values of and perform calculations on
rasters to create a new output raster. This episode covers how to
subtract one raster from another using basic raster math and the
<code>lapp()</code> function. It also covers how to extract pixel values
from a set of locations - for example a buffer region around plot
locations at a field site.</p>
<section><h2 class="section-heading" id="raster-calculations-in-r">Raster Calculations in R<a class="anchor" aria-label="anchor" href="#raster-calculations-in-r"></a>
</h2>
<hr class="half-width">
<p>We often want to perform calculations on two or more rasters to
create a new output raster. For example, if we are interested in mapping
the heights of trees across an entire field site, we might want to
calculate the difference between the Digital Surface Model (DSM, tops of
trees) and the Digital Terrain Model (DTM, ground level). The resulting
dataset is referred to as a Canopy Height Model (CHM) and represents the
actual height of trees, buildings, etc. with the influence of ground
elevation removed.</p>
<figure><img src="fig/dc-spatial-raster/lidarTree-height.png" alt="Source: National Ecological Observatory Network (NEON)" class="figure mx-auto d-block"></figure><div id="more-resources" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources</h3>
<div class="callout-content">
<ul>
<li>Check out more on LiDAR CHM, DTM and DSM in this NEON Data Skills
overview tutorial: <a href="https://www.neonscience.org/chm-dsm-dtm-gridded-lidar-data" class="external-link">What
is a CHM, DSM and DTM? About Gridded, Raster LiDAR Data</a>.</li>
</ul>
</div>
</div>
</div>
<div class="section level3">
<h3 id="load-the-data">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h3>
<p>For this episode, we will use the DTM and DSM from the NEON Harvard
Forest Field site and San Joaquin Experimental Range, which we already
have loaded from previous episodes.</p>
<div id="exercise" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="exercise" class="callout-inner">
<h3 class="callout-title">Exercise</h3>
<div class="callout-content">
<p>Use the <code>describe()</code> function to view information about
the DTM and DSM data files. Do the two rasters have the same or
different CRSs and resolutions? Do they both have defined minimum and
maximum values?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif"
 [3] "Size is 1697, 1367"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731453.000000000000000,4713838.000000000000000)"
[45] "Pixel Size = (1.000000000000000,-1.000000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=BAND"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731453.000, 4713838.000) ( 72d10'52.71\"W, 42d32'32.18\"N)"
[53] "Lower Left  (  731453.000, 4712471.000) ( 72d10'54.71\"W, 42d31'47.92\"N)"
[54] "Upper Right (  733150.000, 4713838.000) ( 72d 9'38.40\"W, 42d32'30.35\"N)"
[55] "Lower Right (  733150.000, 4712471.000) ( 72d 9'40.41\"W, 42d31'46.08\"N)"
[56] "Center      (  732301.500, 4713154.500) ( 72d10'16.56\"W, 42d32' 9.13\"N)"
[57] "Band 1 Block=1697x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=304.560 Max=389.820 "
[59] "  Minimum=304.560, Maximum=389.820, Mean=344.898, StdDev=15.861"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=389.81997680664"
[63] "    STATISTICS_MEAN=344.8979433625"
[64] "    STATISTICS_MINIMUM=304.55999755859"
[65] "    STATISTICS_STDDEV=15.861471000978"                                                                                                                                                                                                                                         </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"
 [3] "Size is 1697, 1367"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731453.000000000000000,4713838.000000000000000)"
[45] "Pixel Size = (1.000000000000000,-1.000000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=BAND"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731453.000, 4713838.000) ( 72d10'52.71\"W, 42d32'32.18\"N)"
[53] "Lower Left  (  731453.000, 4712471.000) ( 72d10'54.71\"W, 42d31'47.92\"N)"
[54] "Upper Right (  733150.000, 4713838.000) ( 72d 9'38.40\"W, 42d32'30.35\"N)"
[55] "Lower Right (  733150.000, 4712471.000) ( 72d 9'40.41\"W, 42d31'46.08\"N)"
[56] "Center      (  732301.500, 4713154.500) ( 72d10'16.56\"W, 42d32' 9.13\"N)"
[57] "Band 1 Block=1697x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=305.070 Max=416.070 "
[59] "  Minimum=305.070, Maximum=416.070, Mean=359.853, StdDev=17.832"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=416.06997680664"
[63] "    STATISTICS_MEAN=359.85311802914"
[64] "    STATISTICS_MINIMUM=305.07000732422"
[65] "    STATISTICS_STDDEV=17.83169335933"                                                                                                                                                                                                                                          </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>We’ve already loaded and worked with these two data files in earlier
episodes. Let’s plot them each once more to remind ourselves what this
data looks like. First we’ll plot the DTM elevation data:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DTM_HARV_df</span> , </span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_dtmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-harv-dtm-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>And then the DSM elevation data:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">DSM_HARV_df</span> , </span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Elevation"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-harv-dsm-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</section><section><h2 class="section-heading" id="two-ways-to-perform-raster-calculations">Two Ways to Perform Raster Calculations<a class="anchor" aria-label="anchor" href="#two-ways-to-perform-raster-calculations"></a>
</h2>
<hr class="half-width">
<p>We can calculate the difference between two rasters in two different
ways:</p>
<ul>
<li>by directly subtracting the two rasters in R using raster math</li>
</ul>
<p>or for more efficient processing - particularly if our rasters are
large and/or the calculations we are performing are complex:</p>
<ul>
<li>using the <code>lapp()</code> function.</li>
</ul></section><section><h2 class="section-heading" id="raster-math-canopy-height-models">Raster Math &amp; Canopy Height Models<a class="anchor" aria-label="anchor" href="#raster-math-canopy-height-models"></a>
</h2>
<hr class="half-width">
<p>We can perform raster calculations by subtracting (or adding,
multiplying, etc) two rasters. In the geospatial world, we call this
“raster math”.</p>
<p>Let’s subtract the DTM from the DSM to create a Canopy Height Model.
After subtracting, let’s create a dataframe so we can plot with
<code>ggplot</code>.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_HARV</span> <span class="op">&lt;-</span> <span class="va">DSM_HARV</span> <span class="op">-</span> <span class="va">DTM_HARV</span></span>
<span></span>
<span><span class="va">CHM_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>We can now plot the output CHM.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_df</span> , </span>
<span>               <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-harv-chm-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Let’s have a look at the distribution of values in our newly created
Canopy Height Model (CHM).</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-create-hist-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Notice that the range of values for the output CHM is between 0 and
30 meters. Does this make sense for trees in Harvard Forest?</p>
<div id="challenge-explore-chm-raster-values" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-chm-raster-values" class="callout-inner">
<h3 class="callout-title">Challenge: Explore CHM Raster Values</h3>
<div class="callout-content">
<p>It’s often a good idea to explore the range of values in a raster
dataset just like we might explore a dataset that we collected in the
field.</p>
<ol style="list-style-type: decimal">
<li>What is the min and maximum value for the Harvard Forest Canopy
Height Model (<code>CHM_HARV</code>) that we just created?</li>
<li>What are two ways you can check this range of data for
<code>CHM_HARV</code>?</li>
<li>What is the distribution of all the pixel values in the CHM?</li>
<li>Plot a histogram with 6 bins instead of the default and change the
color of the histogram.</li>
<li>Plot the <code>CHM_HARV</code> raster using breaks that make sense
for the data. Include an appropriate color palette for the data, plot
title and no axes ticks / labels.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Answers </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>There are missing values in our data, so we need to specify
<code>na.rm = TRUE</code>.</li>
</ol>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">min</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">$</span><span class="va">HARV_dsmCrop</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 0</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">max</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">$</span><span class="va">HARV_dsmCrop</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 38.16998</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Possible ways include:</li>
</ol>
<ul>
<li>Create a histogram</li>
<li>Use the <code>min()</code>, <code>max()</code>, and
<code>range()</code> functions.</li>
<li>Print the object and look at the <code>values</code> attribute.</li>
</ul>
<ol start="3" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-chm-harv-hist-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="4" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"black"</span>, </span>
<span>                   fill<span class="op">=</span><span class="st">"darkgreen"</span>, bins <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-chm-harv-hist-green-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="5" style="list-style-type: decimal"><li>
</li></ol>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">custom_bins</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span><span class="op">)</span></span>
<span><span class="va">CHM_HARV_df</span> <span class="op">&lt;-</span> <span class="va">CHM_HARV_df</span> <span class="op">%&gt;%</span></span>
<span>                  <span class="fu">mutate</span><span class="op">(</span>canopy_discrete <span class="op">=</span> <span class="fu">cut</span><span class="op">(</span><span class="va">HARV_dsmCrop</span>, </span>
<span>                                               breaks <span class="op">=</span> <span class="va">custom_bins</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                       fill <span class="op">=</span> <span class="va">canopy_discrete</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-chm-harv-raster-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="efficient-raster-calculations">Efficient Raster Calculations<a class="anchor" aria-label="anchor" href="#efficient-raster-calculations"></a>
</h2>
<hr class="half-width">
<p>Raster math, like we just did, is an appropriate approach to raster
calculations if:</p>
<ol style="list-style-type: decimal">
<li>The rasters we are using are small in size.</li>
<li>The calculations we are performing are simple.</li>
</ol>
<p>However, raster math is a less efficient approach as computation
becomes more complex or as file sizes become large.</p>
<p>The <code>lapp()</code> function takes two or more rasters and
applies a function to them using efficient processing methods. The
syntax is</p>
<p><code>outputRaster &lt;- lapp(x, fun=functionName)</code></p>
<p>In which raster can be either a SpatRaster or a SpatRasterDataset
which is an object that holds rasters. See <code>help(sds)</code>.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>To create a SpatRasterDataset, we call the function <code>sds</code>
which can take a list of raster objects (each one created by calling
<code>rast</code>).</p>
</div>
</div>
</div>
<p>Let’s perform the same subtraction calculation that we calculated
above using raster math, using the <code>lapp()</code> function.</p>
<div id="data-tip-1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip-1" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>A custom function consists of a defined set of commands performed on
a input object. Custom functions are particularly useful for tasks that
need to be repeated over and over in the code. A simplified syntax for
writing a custom function in R is:
<code>function_name &lt;- function(variable1, variable2) { WhatYouWantDone, WhatToReturn}</code></p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_ov_HARV</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="fu">sds</span><span class="op">(</span><span class="fu">list</span><span class="op">(</span><span class="va">DSM_HARV</span>, <span class="va">DTM_HARV</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span><span class="op">)</span> <span class="op">{</span> <span class="kw">return</span><span class="op">(</span> <span class="va">r1</span> <span class="op">-</span> <span class="va">r2</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Next we need to convert our new object to a data frame for plotting
with <code>ggplot</code>.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_ov_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_ov_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot the CHM:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>   <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_ov_HARV_df</span>, </span>
<span>               <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>   <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-harv-chm-overlay-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>How do the plots of the CHM created with manual raster math and the
<code>lapp()</code> function compare?</p>
</section><section><h2 class="section-heading" id="export-a-geotiff">Export a GeoTIFF<a class="anchor" aria-label="anchor" href="#export-a-geotiff"></a>
</h2>
<hr class="half-width">
<p>Now that we’ve created a new raster, let’s export the data as a
GeoTIFF file using the <code>writeRaster()</code> function.</p>
<p>When we write this raster object to a GeoTIFF file we’ll name it
<code>CHM_HARV.tiff</code>. This name allows us to quickly remember both
what the data contains (CHM data) and for where (HARVard Forest). The
<code>writeRaster()</code> function by default writes the output file to
your working directory unless you specify a full file path.</p>
<p>We will specify the output format (“GTiff”), the no data value
<code>NAflag = -9999</code>. We will also tell R to overwrite any data
that is already in a file of the same name.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">writeRaster</span><span class="op">(</span><span class="va">CHM_ov_HARV</span>, <span class="st">"CHM_HARV.tiff"</span>,</span>
<span>            filetype<span class="op">=</span><span class="st">"GTiff"</span>,</span>
<span>            overwrite<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>            NAflag<span class="op">=</span><span class="op">-</span><span class="fl">9999</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="writeraster-options">writeRaster() Options<a class="anchor" aria-label="anchor" href="#writeraster-options"></a>
</h3>
<p>The function arguments that we used above include:</p>
<ul>
<li>
<strong>filetype:</strong> specify that the format will be
<code>GTiff</code> or GeoTIFF.</li>
<li>
<strong>overwrite:</strong> If TRUE, R will overwrite any existing
file with the same name in the specified directory. USE THIS SETTING
WITH CAUTION!</li>
<li>
<strong>NAflag:</strong> set the GeoTIFF tag for
<code>NoDataValue</code> to -9999, the National Ecological Observatory
Network’s (NEON) standard <code>NoDataValue</code>.</li>
</ul>
<div id="challenge-explore-the-neon-san-joaquin-experimental-range-field-site" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-explore-the-neon-san-joaquin-experimental-range-field-site" class="callout-inner">
<h3 class="callout-title">Challenge: Explore the NEON San Joaquin Experimental Range Field Site</h3>
<div class="callout-content">
<p>Data are often more interesting and powerful when we compare them
across various locations. Let’s compare some data collected over Harvard
Forest to data collected in Southern California. The <a href="https://www.neonscience.org/field-sites/field-sites-map/SJER" class="external-link">NEON
San Joaquin Experimental Range (SJER) field site</a> located in Southern
California has a very different ecosystem and climate than the <a href="https://www.neonscience.org/field-sites/field-sites-map/HARV" class="external-link">NEON
Harvard Forest Field Site</a> in Massachusetts.</p>
<p>Import the SJER DSM and DTM raster files and create a Canopy Height
Model. Then compare the two sites. Be sure to name your R objects and
outputs carefully, as follows: objectType_SJER
(e.g. <code>DSM_SJER</code>). This will help you keep track of data from
different sites!</p>
<ol start="0" style="list-style-type: decimal">
<li>You should have the DSM and DTM data for the SJER site already
loaded from the <a href="02-raster-plot/">Plot Raster Data in R</a>
episode.) Don’t forget to check the CRSs and units of the data.</li>
<li>Create a CHM from the two raster layers and check to make sure the
data are what you expect.</li>
<li>Plot the CHM from SJER.</li>
<li>Export the SJER CHM as a GeoTIFF.</li>
<li>Compare the vegetation structure of the Harvard Forest and San
Joaquin Experimental Range.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Answers </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>Use the <code>lapp()</code> function to subtract the two rasters
&amp; create the CHM.</li>
</ol>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_ov_SJER</span> <span class="op">&lt;-</span> <span class="fu">lapp</span><span class="op">(</span><span class="fu">sds</span><span class="op">(</span><span class="fu">list</span><span class="op">(</span><span class="va">DSM_SJER</span>, <span class="va">DTM_SJER</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">r1</span>, <span class="va">r2</span><span class="op">)</span><span class="op">{</span> <span class="kw">return</span><span class="op">(</span><span class="va">r1</span> <span class="op">-</span> <span class="va">r2</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span></code></pre>
</div>
<p>Convert the output to a dataframe:</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_ov_SJER_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_ov_SJER</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Create a histogram to check that the data distribution makes
sense:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_ov_SJER_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">SJER_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-sjer-chm-overlay-hist-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="2" style="list-style-type: decimal">
<li>Create a plot of the CHM:</li>
</ol>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_ov_SJER_df</span>, </span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, </span>
<span>                   fill <span class="op">=</span> <span class="va">SJER_dsmCrop</span><span class="op">)</span></span>
<span>              <span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, </span>
<span>        colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-sjer-chm-overlay-raster-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="3" style="list-style-type: decimal">
<li>Export the CHM object to a file:</li>
</ol>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">writeRaster</span><span class="op">(</span><span class="va">CHM_ov_SJER</span>, <span class="st">"chm_ov_SJER.tiff"</span>,</span>
<span>            filetype <span class="op">=</span> <span class="st">"GTiff"</span>,</span>
<span>            overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            NAflag <span class="op">=</span> <span class="op">-</span><span class="fl">9999</span><span class="op">)</span></span></code></pre>
</div>
<ol start="4" style="list-style-type: decimal">
<li>Compare the SJER and HARV CHMs. Tree heights are much shorter in
SJER. You can confirm this by looking at the histograms of the two
CHMs.</li>
</ol>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_HARV_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">HARV_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-compare-chm-harv-sjer-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">CHM_ov_SJER_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">SJER_dsmCrop</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/04-raster-calculations-in-r-rendered-compare-chm-harv-sjer-2.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Rasters can be computed on using mathematical functions.</li>
<li>The <code>lapp()</code> function provides an efficient way to do
raster math.</li>
<li>The <code>writeRaster()</code> function can be used to write raster
data to a file.</li>
</ul>
</div>
</div>
</div>
</div>
</section></section><section id="aio-05-raster-multi-band-in-r"><p>Content from <a href="05-raster-multi-band-in-r.html">Work with Multi-Band Rasters</a></p>
<hr>
<p>Last updated on 2025-06-10 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/05-raster-multi-band-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I visualize individual and multiple bands in a raster
object?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Identify a single vs. a multi-band raster file.</li>
<li>Import multi-band rasters into R using the <code>terra</code>
package.</li>
<li>Plot multi-band color image rasters in R using the
<code>ggplot</code> package.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>We introduced multi-band raster data in <a href="https://datacarpentry.org/organization-geospatial/01-intro-raster-data" class="external-link">an
earlier lesson</a>. This episode explores how to import and plot a
multi-band raster in R.</p>
<section><h2 class="section-heading" id="getting-started-with-multi-band-data-in-r">Getting Started with Multi-Band Data in R<a class="anchor" aria-label="anchor" href="#getting-started-with-multi-band-data-in-r"></a>
</h2>
<hr class="half-width">
<p>In this episode, the multi-band data that we are working with is
imagery collected using the <a href="https://www.neonscience.org/data-collection/airborne-remote-sensing" class="external-link">NEON
Airborne Observation Platform</a> high resolution camera over the <a href="https://www.neonscience.org/field-sites/field-sites-map/HARV" class="external-link">NEON
Harvard Forest field site</a>. Each RGB image is a 3-band raster. The
same steps would apply to working with a multi-spectral image with 4 or
more bands - like Landsat imagery.</p>
<p>By using the <code>rast()</code> function along with the
<code>lyrs</code> parameter, we can read specific raster bands (i.e. the
first one); omitting this parameter would read instead all bands.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_band1_HARV</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"</span>, </span>
<span>       lyrs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre>
</div>
<p>We need to convert this data to a data frame in order to plot it with
<code>ggplot</code>.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_band1_HARV_df</span>  <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">RGB_band1_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">RGB_band1_HARV_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">HARV_RGB_Ortho_1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-harv-rgb-band1-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>View the attributes of this band. What are its dimensions, CRS,
resolution, min and max values, and band number?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1"> Show me the solution </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_band1_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 2317, 3073, 1  (nrow, ncol, nlyr)
resolution  : 0.25, 0.25  (x, y)
extent      : 731998.5, 732766.8, 4712956, 4713536  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_RGB_Ortho.tif
name        : HARV_RGB_Ortho_1
min value   :                0
max value   :              255 </code></pre>
</div>
<p>Notice that when we look at the attributes of this band, we see:
<code>dimensions  : 2317, 3073, 1  (nrow, ncol, nlyr)</code></p>
<p>This is R telling us that we read only one its bands.</p>
</div>
</div>
</div>
</div>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>The number of bands associated with a raster’s file can also be
determined using the <code>describe()</code> function: syntax is
<code>describe(sources(RGB_band1_HARV))</code>.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="image-raster-data-values">Image Raster Data Values<a class="anchor" aria-label="anchor" href="#image-raster-data-values"></a>
</h3>
<p>As we saw in the previous exercise, this raster contains values
between 0 and 255. These values represent degrees of brightness
associated with the image band. In the case of a RGB image (red, green
and blue), band 1 is the red band. When we plot the red band, larger
numbers (towards 255) represent pixels with more red in them (a strong
red reflection). Smaller numbers (towards 0) represent pixels with less
red in them (less red was reflected). To plot an RGB image, we mix red +
green + blue values into one single color to create a full color image -
similar to the color image a digital camera creates.</p>
</div>
<div class="section level3">
<h3 id="import-a-specific-band">Import A Specific Band<a class="anchor" aria-label="anchor" href="#import-a-specific-band"></a>
</h3>
<p>We can use the <code>rast()</code> function to import specific bands
in our raster object by specifying which band we want with
<code>lyrs = N</code> (N represents the band number we want to work
with). To import the green band, we would use <code>lyrs = 2</code>.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_band2_HARV</span> <span class="op">&lt;-</span>  </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"</span>, </span>
<span>       lyrs <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre>
</div>
<p>We can convert this data to a data frame and plot the same way we
plotted the red band:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_band2_HARV_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">RGB_band2_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">RGB_band2_HARV_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">HARV_RGB_Ortho_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_equal</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-rgb-harv-band2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-making-sense-of-single-band-images" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-making-sense-of-single-band-images" class="callout-inner">
<h3 class="callout-title">Challenge: Making Sense of Single Band Images</h3>
<div class="callout-content">
<p>Compare the plots of band 1 (red) and band 2 (green). Is the forested
area darker or lighter in band 2 (the green band) compared to band 1
(the red band)?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2"> Show me the solution </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>We’d expect a <em>brighter</em> value for the forest in band 2
(green) than in band 1 (red) because the leaves on trees of most often
appear “green” - healthy leaves reflect MORE green light than red
light.</p>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="raster-stacks-in-r">Raster Stacks in R<a class="anchor" aria-label="anchor" href="#raster-stacks-in-r"></a>
</h2>
<hr class="half-width">
<p>Next, we will work with all three image bands (red, green and blue)
as an R raster object. We will then plot a 3-band composite, or full
color, image.</p>
<p>To bring in all bands of a multi-band raster, we use
the<code>rast()</code> function.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_stack_HARV</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"</span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s preview the attributes of our stack object:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_stack_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 2317, 3073, 3  (nrow, ncol, nlyr)
resolution  : 0.25, 0.25  (x, y)
extent      : 731998.5, 732766.8, 4712956, 4713536  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_RGB_Ortho.tif
names       : HARV_RGB_Ortho_1, HARV_RGB_Ortho_2, HARV_RGB_Ortho_3
min values  :                0,                0,                0
max values  :              255,              255,              255 </code></pre>
</div>
<p>We can view the attributes of each band in the stack in a single
output. For example, if we had hundreds of bands, we could specify which
band we’d like to view attributes for using an index value:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_stack_HARV</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 2317, 3073, 1  (nrow, ncol, nlyr)
resolution  : 0.25, 0.25  (x, y)
extent      : 731998.5, 732766.8, 4712956, 4713536  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_RGB_Ortho.tif
name        : HARV_RGB_Ortho_2
min value   :                0
max value   :              255 </code></pre>
</div>
<p>We can also use the <code>ggplot</code> functions to plot the data in
any layer of our raster object. Remember, we need to convert to a data
frame first.</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_stack_HARV_df</span>  <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">RGB_stack_HARV</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Each band in our RasterStack gets its own column in the data frame.
Thus we have:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">str</span><span class="op">(</span><span class="va">RGB_stack_HARV_df</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	7120141 obs. of  5 variables:
 $ x               : num  731999 731999 731999 731999 732000 ...
 $ y               : num  4713535 4713535 4713535 4713535 4713535 ...
 $ HARV_RGB_Ortho_1: num  0 2 6 0 16 0 0 6 1 5 ...
 $ HARV_RGB_Ortho_2: num  1 0 9 0 5 0 4 2 1 0 ...
 $ HARV_RGB_Ortho_3: num  0 10 1 0 17 0 4 0 0 7 ...</code></pre>
</div>
<p>Let’s create a histogram of the first band:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">RGB_stack_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">HARV_RGB_Ortho_1</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-rgb-harv-hist-band1-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>And a raster plot of the second band:</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">RGB_stack_HARV_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, alpha <span class="op">=</span> <span class="va">HARV_RGB_Ortho_2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">coord_quickmap</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-rgb-harv-plot-band2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can access any individual band in the same way.</p>
<div class="section level3">
<h3 id="create-a-three-band-image">Create A Three Band Image<a class="anchor" aria-label="anchor" href="#create-a-three-band-image"></a>
</h3>
<p>To render a final three band, colored image in R, we use the
<code>plotRGB()</code> function.</p>
<p>This function allows us to:</p>
<ol style="list-style-type: decimal">
<li>Identify what bands we want to render in the red, green and blue
regions. The <code>plotRGB()</code> function defaults to a 1=red,
2=green, and 3=blue band order. However, you can define what bands you’d
like to plot manually. Manual definition of bands is useful if you have,
for example a near-infrared band and want to create a color infrared
image.</li>
<li>Adjust the <code>stretch</code> of the image to increase or decrease
contrast.</li>
</ol>
<p>Let’s plot our 3-band image. Note that we can use the
<code>plotRGB()</code> function directly with our RasterStack object (we
don’t need a dataframe as this function isn’t part of the
<code>ggplot2</code> package).</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">RGB_stack_HARV</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-plot-rgb-image-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The image above looks pretty good. We can explore whether applying a
stretch to the image might improve clarity and contrast using
<code>stretch="lin"</code> or <code>stretch="hist"</code>.</p>
<figure><img src="fig/dc-spatial-raster/imageStretch_dark.jpg" alt="Image Stretch" class="figure mx-auto d-block"></figure><p>When the range of pixel brightness values is closer to 0, a darker
image is rendered by default. We can stretch the values to extend to the
full 0-255 range of potential values to increase the visual contrast of
the image.</p>
<figure><img src="fig/dc-spatial-raster/imageStretch_light.jpg" alt="Image Stretch light" class="figure mx-auto d-block"></figure><p>When the range of pixel brightness values is closer to 255, a lighter
image is rendered by default. We can stretch the values to extend to the
full 0-255 range of potential values to increase the visual contrast of
the image.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">RGB_stack_HARV</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        scale <span class="op">=</span> <span class="fl">800</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"lin"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in grDevices::rgb(RGB[, 1], RGB[, 2], RGB[, 3], alpha = alpha, maxColorValue = scale): alpha level 800, not in 0:255</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">RGB_stack_HARV</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        scale <span class="op">=</span> <span class="fl">800</span>,</span>
<span>        stretch <span class="op">=</span> <span class="st">"hist"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in grDevices::rgb(RGB[, 1], RGB[, 2], RGB[, 3], alpha = alpha, maxColorValue = scale): alpha level 800, not in 0:255</code></pre>
</div>
<p>In this case, the stretch doesn’t enhance the contrast our image
significantly given the distribution of reflectance (or brightness)
values is distributed well between 0 and 255.</p>
<div id="challenge---nodata-values" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---nodata-values" class="callout-inner">
<h3 class="callout-title">Challenge - NoData Values</h3>
<div class="callout-content">
<p>Let’s explore what happens with NoData values when working with
RasterStack objects and using the <code>plotRGB()</code> function. We
will use the <code>HARV_Ortho_wNA.tif</code> GeoTIFF file in the
<code>NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/</code>
directory.</p>
<ol style="list-style-type: decimal">
<li>View the files attributes. Are there <code>NoData</code> values
assigned for this file?</li>
<li>If so, what is the <code>NoData</code> Value?</li>
<li>How many bands does it have?</li>
<li>Load the multi-band raster file into R.</li>
<li>Plot the object as a true color image.</li>
<li>What happened to the black edges in the data?</li>
<li>What does this tell us about the difference in the data structure
between <code>HARV_Ortho_wNA.tif</code> and
<code>HARV_RGB_Ortho.tif</code> (R object <code>RGB_stack</code>). How
can you check?</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3"> Answers </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" aria-labelledby="headingSolution3" data-bs-parent="#accordionSolution3">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>First we use the <code>describe()</code> function to view the data
attributes.</li>
</ol>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_Ortho_wNA.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_Ortho_wNA.tif"
 [3] "Size is 3073, 2317"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731998.500000000000000,4713535.500000000000000)"
[45] "Pixel Size = (0.250000000000000,-0.250000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=PIXEL"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731998.500, 4713535.500) ( 72d10'29.27\"W, 42d32'21.80\"N)"
[53] "Lower Left  (  731998.500, 4712956.250) ( 72d10'30.11\"W, 42d32' 3.04\"N)"
[54] "Upper Right (  732766.750, 4713535.500) ( 72d 9'55.63\"W, 42d32'20.97\"N)"
[55] "Lower Right (  732766.750, 4712956.250) ( 72d 9'56.48\"W, 42d32' 2.21\"N)"
[56] "Center      (  732382.625, 4713245.875) ( 72d10'12.87\"W, 42d32'12.00\"N)"
[57] "Band 1 Block=3073x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=0.000 Max=255.000 "
[59] "  Minimum=0.000, Maximum=255.000, Mean=107.837, StdDev=30.019"
[60] "  NoData Value=-9999"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=255"
[63] "    STATISTICS_MEAN=107.83651227531"
[64] "    STATISTICS_MINIMUM=0"
[65] "    STATISTICS_STDDEV=30.019177549096"
[66] "Band 2 Block=3073x1 Type=Float64, ColorInterp=Undefined"
[67] "  Min=0.000 Max=255.000 "
[68] "  Minimum=0.000, Maximum=255.000, Mean=130.096, StdDev=32.002"
[69] "  NoData Value=-9999"
[70] "  Metadata:"
[71] "    STATISTICS_MAXIMUM=255"
[72] "    STATISTICS_MEAN=130.09595363812"
[73] "    STATISTICS_MINIMUM=0"
[74] "    STATISTICS_STDDEV=32.001675868273"
[75] "Band 3 Block=3073x1 Type=Float64, ColorInterp=Undefined"
[76] "  Min=0.000 Max=255.000 "
[77] "  Minimum=0.000, Maximum=255.000, Mean=95.760, StdDev=16.577"
[78] "  NoData Value=-9999"
[79] "  Metadata:"
[80] "    STATISTICS_MAXIMUM=255"
[81] "    STATISTICS_MEAN=95.759787935476"
[82] "    STATISTICS_MINIMUM=0"
[83] "    STATISTICS_STDDEV=16.577042076977"                                                                                                                                                                                                                                         </code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li><p>From the output above, we see that there are <code>NoData</code>
values and they are assigned the value of -9999.</p></li>
<li><p>The data has three bands.</p></li>
<li><p>To read in the file, we will use the <code>rast()</code>
function:</p></li>
</ol>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">HARV_NA</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_Ortho_wNA.tif"</span><span class="op">)</span></span></code></pre>
</div>
<ol start="5" style="list-style-type: decimal">
<li>We can plot the data with the <code>plotRGB()</code> function:</li>
</ol>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plotRGB</span><span class="op">(</span><span class="va">HARV_NA</span>,</span>
<span>        r <span class="op">=</span> <span class="fl">1</span>, g <span class="op">=</span> <span class="fl">2</span>, b <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/05-raster-multi-band-in-r-rendered-harv-na-rgb-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><ol start="6" style="list-style-type: decimal">
<li><p>The black edges are not plotted.</p></li>
<li><p>Both data sets have <code>NoData</code> values, however, in the
RGB_stack the NoData value is not defined in the tiff tags, thus R
renders them as black as the reflectance values are 0. The black edges
in the other file are defined as -9999 and R renders them as
NA.</p></li>
</ol>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">describe</span><span class="op">(</span><span class="st">"data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Driver: GTiff/GeoTIFF"
 [2] "Files: data/NEON-DS-Airborne-Remote-Sensing/HARV/RGB_Imagery/HARV_RGB_Ortho.tif"
 [3] "Size is 3073, 2317"
 [4] "Coordinate System is:"
 [5] "PROJCRS[\"WGS 84 / UTM zone 18N\","
 [6] "    BASEGEOGCRS[\"WGS 84\","
 [7] "        DATUM[\"World Geodetic System 1984\","
 [8] "            ELLIPSOID[\"WGS 84\",6378137,298.257223563,"
 [9] "                LENGTHUNIT[\"metre\",1]]],"
[10] "        PRIMEM[\"Greenwich\",0,"
[11] "            ANGLEUNIT[\"degree\",0.0174532925199433]],"
[12] "        ID[\"EPSG\",4326]],"
[13] "    CONVERSION[\"UTM zone 18N\","
[14] "        METHOD[\"Transverse Mercator\","
[15] "            ID[\"EPSG\",9807]],"
[16] "        PARAMETER[\"Latitude of natural origin\",0,"
[17] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[18] "            ID[\"EPSG\",8801]],"
[19] "        PARAMETER[\"Longitude of natural origin\",-75,"
[20] "            ANGLEUNIT[\"degree\",0.0174532925199433],"
[21] "            ID[\"EPSG\",8802]],"
[22] "        PARAMETER[\"Scale factor at natural origin\",0.9996,"
[23] "            SCALEUNIT[\"unity\",1],"
[24] "            ID[\"EPSG\",8805]],"
[25] "        PARAMETER[\"False easting\",500000,"
[26] "            LENGTHUNIT[\"metre\",1],"
[27] "            ID[\"EPSG\",8806]],"
[28] "        PARAMETER[\"False northing\",0,"
[29] "            LENGTHUNIT[\"metre\",1],"
[30] "            ID[\"EPSG\",8807]]],"
[31] "    CS[Cartesian,2],"
[32] "        AXIS[\"(E)\",east,"
[33] "            ORDER[1],"
[34] "            LENGTHUNIT[\"metre\",1]],"
[35] "        AXIS[\"(N)\",north,"
[36] "            ORDER[2],"
[37] "            LENGTHUNIT[\"metre\",1]],"
[38] "    USAGE["
[39] "        SCOPE[\"Engineering survey, topographic mapping.\"],"
[40] "        AREA[\"Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.\"],"
[41] "        BBOX[0,-78,84,-72]],"
[42] "    ID[\"EPSG\",32618]]"
[43] "Data axis to CRS axis mapping: 1,2"
[44] "Origin = (731998.500000000000000,4713535.500000000000000)"
[45] "Pixel Size = (0.250000000000000,-0.250000000000000)"
[46] "Metadata:"
[47] "  AREA_OR_POINT=Area"
[48] "Image Structure Metadata:"
[49] "  COMPRESSION=LZW"
[50] "  INTERLEAVE=PIXEL"
[51] "Corner Coordinates:"
[52] "Upper Left  (  731998.500, 4713535.500) ( 72d10'29.27\"W, 42d32'21.80\"N)"
[53] "Lower Left  (  731998.500, 4712956.250) ( 72d10'30.11\"W, 42d32' 3.04\"N)"
[54] "Upper Right (  732766.750, 4713535.500) ( 72d 9'55.63\"W, 42d32'20.97\"N)"
[55] "Lower Right (  732766.750, 4712956.250) ( 72d 9'56.48\"W, 42d32' 2.21\"N)"
[56] "Center      (  732382.625, 4713245.875) ( 72d10'12.87\"W, 42d32'12.00\"N)"
[57] "Band 1 Block=3073x1 Type=Float64, ColorInterp=Gray"
[58] "  Min=0.000 Max=255.000 "
[59] "  Minimum=0.000, Maximum=255.000, Mean=nan, StdDev=nan"
[60] "  NoData Value=-1.69999999999999994e+308"
[61] "  Metadata:"
[62] "    STATISTICS_MAXIMUM=255"
[63] "    STATISTICS_MEAN=nan"
[64] "    STATISTICS_MINIMUM=0"
[65] "    STATISTICS_STDDEV=nan"
[66] "Band 2 Block=3073x1 Type=Float64, ColorInterp=Undefined"
[67] "  Min=0.000 Max=255.000 "
[68] "  Minimum=0.000, Maximum=255.000, Mean=nan, StdDev=nan"
[69] "  NoData Value=-1.69999999999999994e+308"
[70] "  Metadata:"
[71] "    STATISTICS_MAXIMUM=255"
[72] "    STATISTICS_MEAN=nan"
[73] "    STATISTICS_MINIMUM=0"
[74] "    STATISTICS_STDDEV=nan"
[75] "Band 3 Block=3073x1 Type=Float64, ColorInterp=Undefined"
[76] "  Min=0.000 Max=255.000 "
[77] "  Minimum=0.000, Maximum=255.000, Mean=nan, StdDev=nan"
[78] "  NoData Value=-1.69999999999999994e+308"
[79] "  Metadata:"
[80] "    STATISTICS_MAXIMUM=255"
[81] "    STATISTICS_MEAN=nan"
[82] "    STATISTICS_MINIMUM=0"
[83] "    STATISTICS_STDDEV=nan"                                                                                                                                                                                                                                                     </code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="data-tip-1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip-1" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>We can create a raster object from several, individual single-band
GeoTIFFs too. We will do this in a later episode, <a href="12-time-series-raster/">Raster Time Series Data in R</a>.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="spatraster-in-r">SpatRaster in R<a class="anchor" aria-label="anchor" href="#spatraster-in-r"></a>
</h2>
<hr class="half-width">
<p>The R SpatRaster object type can handle rasters with multiple bands.
The SpatRaster only holds parameters that describe the properties of
raster data that is located somewhere on our computer.</p>
<p>A SpatRasterDataset object can hold references to sub-datasets, that
is, SpatRaster objects. In most cases, we can work with a SpatRaster in
the same way we might work with a SpatRasterDataset.</p>
<div id="more-resources" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="more-resources" class="callout-inner">
<h3 class="callout-title">More Resources</h3>
<div class="callout-content">
<p>You can read the help for the <code>rast()</code> and
<code>sds()</code> functions by typing <code>?rast</code> or
<code>?sds</code>.</p>
</div>
</div>
</div>
<p>We can build a SpatRasterDataset using a SpatRaster or a list of
SpatRaster:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_sds_HARV</span> <span class="op">&lt;-</span> <span class="fu">sds</span><span class="op">(</span><span class="va">RGB_stack_HARV</span><span class="op">)</span></span>
<span><span class="va">RGB_sds_HARV</span> <span class="op">&lt;-</span> <span class="fu">sds</span><span class="op">(</span><span class="fu">list</span><span class="op">(</span><span class="va">RGB_stack_HARV</span>, <span class="va">RGB_stack_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>We can retrieve the SpatRaster objects from a SpatRasterDataset using
subsetting:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_sds_HARV</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 2317, 3073, 3  (nrow, ncol, nlyr)
resolution  : 0.25, 0.25  (x, y)
extent      : 731998.5, 732766.8, 4712956, 4713536  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_RGB_Ortho.tif
names       : HARV_RGB_Ortho_1, HARV_RGB_Ortho_2, HARV_RGB_Ortho_3
min values  :                0,                0,                0
max values  :              255,              255,              255 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_sds_HARV</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 2317, 3073, 3  (nrow, ncol, nlyr)
resolution  : 0.25, 0.25  (x, y)
extent      : 731998.5, 732766.8, 4712956, 4713536  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 18N (EPSG:32618)
source      : HARV_RGB_Ortho.tif
names       : HARV_RGB_Ortho_1, HARV_RGB_Ortho_2, HARV_RGB_Ortho_3
min values  :                0,                0,                0
max values  :              255,              255,              255 </code></pre>
</div>
<div id="challenge-what-functions-can-be-used-on-an-r-object-of-a-particular-class" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-what-functions-can-be-used-on-an-r-object-of-a-particular-class" class="callout-inner">
<h3 class="callout-title">Challenge: What Functions Can Be Used on an R Object of a particular class?</h3>
<div class="callout-content">
<p>We can view various functions (or methods) available to use on an R
object with <code>methods(class=class(objectNameHere))</code>. Use this
to figure out:</p>
<ol style="list-style-type: decimal">
<li>What methods can be used on the <code>RGB_stack_HARV</code>
object?</li>
<li>What methods can be used on a single band within
<code>RGB_stack_HARV</code>?</li>
<li>Why do you think there isn’t a difference?</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4"> Answers </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" aria-labelledby="headingSolution4" data-bs-parent="#accordionSolution4">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>We can see a list of all of the methods available for our
RasterStack object:</li>
</ol>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">methods</span><span class="op">(</span>class<span class="op">=</span><span class="fu">class</span><span class="op">(</span><span class="va">RGB_stack_HARV</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  [1] !                     [                     [[
  [4] [[&lt;-                  [&lt;-                   %in%
  [7] $                     $&lt;-                   activeCat
 [10] activeCat&lt;-           add&lt;-                 addCats
 [13] adjacent              aggregate             align
 [16] all.equal             allNA                 animate
 [19] anyNA                 app                   approximate
 [22] area                  Arith                 as.array
 [25] as.bool               as.character          as.contour
 [28] as.data.frame         as.factor             as.int
 [31] as.integer            as.lines              as.list
 [34] as.logical            as.matrix             as.numeric
 [37] as.points             as.polygons           as.raster
 [40] atan_2                atan2                 autocor
 [43] barplot               bestMatch             blocks
 [46] boundaries            boxplot               buffer
 [49] c                     catalyze              categories
 [52] cats                  cellFromRowCol        cellFromRowColCombine
 [55] cellFromXY            cells                 cellSize
 [58] clamp_ts              clamp                 classify
 [61] click                 coerce                colFromCell
 [64] colFromX              colMeans              colorize
 [67] colSums               coltab                coltab&lt;-
 [70] Compare               compare               compareGeom
 [73] concats               contour               costDist
 [76] countNA               cover                 crds
 [79] crop                  crosstab              crs
 [82] crs&lt;-                 datatype              deepcopy
 [85] density               depth                 depth&lt;-
 [88] depthName             depthName&lt;-           depthUnit
 [91] depthUnit&lt;-           describe              diff
 [94] dim                   dim&lt;-                 direction
 [97] disagg                distance              divide
[100] droplevels            expanse               ext
[103] ext&lt;-                 extend                extract
[106] extractRange          fillTime              flip
[109] flowAccumulation      focal                 focal3D
[112] focalCpp              focalPairs            focalReg
[115] focalValues           freq                  getTileExtents
[118] global                gridDist              gridDistance
[121] has.colors            has.RGB               has.time
[124] hasMinMax             hasValues             head
[127] hist                  identical             ifel
[130] image                 init                  inMemory
[133] inset                 interpIDW             interpNear
[136] interpolate           intersect             is.bool
[139] is.factor             is.finite             is.flipped
[142] is.infinite           is.int                is.lonlat
[145] is.na                 is.nan                is.num
[148] is.related            is.rotated            isFALSE
[151] isTRUE                k_means               lapp
[154] layerCor              levels                levels&lt;-
[157] linearUnits           lines                 log
[160] Logic                 logic                 longnames
[163] longnames&lt;-           makeTiles             mask
[166] match                 math                  Math
[169] Math2                 mean                  median
[172] merge                 meta                  metags
[175] metags&lt;-              minmax                modal
[178] mosaic                NAflag                NAflag&lt;-
[181] names                 names&lt;-               ncell
[184] ncol                  ncol&lt;-                NIDP
[187] nlyr                  nlyr&lt;-                noNA
[190] not.na                nrow                  nrow&lt;-
[193] nsrc                  origin                origin&lt;-
[196] pairs                 panel                 patches
[199] persp                 pitfinder             plet
[202] plot                  plotRGB               points
[205] polys                 prcomp                predict
[208] princomp              project               quantile
[211] rangeFill             rapp                  rast
[214] rasterize             rasterizeGeom         rasterizeWin
[217] rcl                   readStart             readStop
[220] readValues            rectify               regress
[223] relate                rep                   res
[226] res&lt;-                 resample              rescale
[229] rev                   RGB                   RGB&lt;-
[232] roll                  rotate                rowColCombine
[235] rowColFromCell        rowFromCell           rowFromY
[238] rowMeans              rowSums               sapp
[241] saveRDS               scale_linear          scale
[244] scoff                 scoff&lt;-               sds
[247] segregate             sel                   selectHighest
[250] selectRange           serialize             set.cats
[253] set.crs               set.ext               set.names
[256] set.RGB               set.values            set.window
[259] setMinMax             setValues             shift
[262] show                  sieve                 simplifyLevels
[265] size                  sort                  sources
[268] spatSample            split                 sprc
[271] stdev                 str                   stretch
[274] subset                subst                 summary
[277] Summary               surfArea              t
[280] tail                  tapp                  terrain
[283] text                  thresh                tighten
[286] time                  time&lt;-                timeInfo
[289] toMemory              trans                 trim
[292] unique                units                 units&lt;-
[295] update                values                values&lt;-
[298] varnames              varnames&lt;-            viewshed
[301] watershed             weighted.mean         where.max
[304] where.min             which.lyr             which.max
[307] which.min             window                window&lt;-
[310] wrap                  wrapCache             writeCDF
[313] writeRaster           writeStart            writeStop
[316] writeValues           xapp                  xFromCell
[319] xFromCol              xmax                  xmax&lt;-
[322] xmin                  xmin&lt;-                xres
[325] xyFromCell            yFromCell             yFromRow
[328] ymax                  ymax&lt;-                ymin
[331] ymin&lt;-                yres                  zonal
[334] zoom
see '?methods' for accessing help and source code</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>And compare that with the methods available for a single band:</li>
</ol>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">methods</span><span class="op">(</span>class<span class="op">=</span><span class="fu">class</span><span class="op">(</span><span class="va">RGB_stack_HARV</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  [1] !                     [                     [[
  [4] [[&lt;-                  [&lt;-                   %in%
  [7] $                     $&lt;-                   activeCat
 [10] activeCat&lt;-           add&lt;-                 addCats
 [13] adjacent              aggregate             align
 [16] all.equal             allNA                 animate
 [19] anyNA                 app                   approximate
 [22] area                  Arith                 as.array
 [25] as.bool               as.character          as.contour
 [28] as.data.frame         as.factor             as.int
 [31] as.integer            as.lines              as.list
 [34] as.logical            as.matrix             as.numeric
 [37] as.points             as.polygons           as.raster
 [40] atan_2                atan2                 autocor
 [43] barplot               bestMatch             blocks
 [46] boundaries            boxplot               buffer
 [49] c                     catalyze              categories
 [52] cats                  cellFromRowCol        cellFromRowColCombine
 [55] cellFromXY            cells                 cellSize
 [58] clamp_ts              clamp                 classify
 [61] click                 coerce                colFromCell
 [64] colFromX              colMeans              colorize
 [67] colSums               coltab                coltab&lt;-
 [70] Compare               compare               compareGeom
 [73] concats               contour               costDist
 [76] countNA               cover                 crds
 [79] crop                  crosstab              crs
 [82] crs&lt;-                 datatype              deepcopy
 [85] density               depth                 depth&lt;-
 [88] depthName             depthName&lt;-           depthUnit
 [91] depthUnit&lt;-           describe              diff
 [94] dim                   dim&lt;-                 direction
 [97] disagg                distance              divide
[100] droplevels            expanse               ext
[103] ext&lt;-                 extend                extract
[106] extractRange          fillTime              flip
[109] flowAccumulation      focal                 focal3D
[112] focalCpp              focalPairs            focalReg
[115] focalValues           freq                  getTileExtents
[118] global                gridDist              gridDistance
[121] has.colors            has.RGB               has.time
[124] hasMinMax             hasValues             head
[127] hist                  identical             ifel
[130] image                 init                  inMemory
[133] inset                 interpIDW             interpNear
[136] interpolate           intersect             is.bool
[139] is.factor             is.finite             is.flipped
[142] is.infinite           is.int                is.lonlat
[145] is.na                 is.nan                is.num
[148] is.related            is.rotated            isFALSE
[151] isTRUE                k_means               lapp
[154] layerCor              levels                levels&lt;-
[157] linearUnits           lines                 log
[160] Logic                 logic                 longnames
[163] longnames&lt;-           makeTiles             mask
[166] match                 math                  Math
[169] Math2                 mean                  median
[172] merge                 meta                  metags
[175] metags&lt;-              minmax                modal
[178] mosaic                NAflag                NAflag&lt;-
[181] names                 names&lt;-               ncell
[184] ncol                  ncol&lt;-                NIDP
[187] nlyr                  nlyr&lt;-                noNA
[190] not.na                nrow                  nrow&lt;-
[193] nsrc                  origin                origin&lt;-
[196] pairs                 panel                 patches
[199] persp                 pitfinder             plet
[202] plot                  plotRGB               points
[205] polys                 prcomp                predict
[208] princomp              project               quantile
[211] rangeFill             rapp                  rast
[214] rasterize             rasterizeGeom         rasterizeWin
[217] rcl                   readStart             readStop
[220] readValues            rectify               regress
[223] relate                rep                   res
[226] res&lt;-                 resample              rescale
[229] rev                   RGB                   RGB&lt;-
[232] roll                  rotate                rowColCombine
[235] rowColFromCell        rowFromCell           rowFromY
[238] rowMeans              rowSums               sapp
[241] saveRDS               scale_linear          scale
[244] scoff                 scoff&lt;-               sds
[247] segregate             sel                   selectHighest
[250] selectRange           serialize             set.cats
[253] set.crs               set.ext               set.names
[256] set.RGB               set.values            set.window
[259] setMinMax             setValues             shift
[262] show                  sieve                 simplifyLevels
[265] size                  sort                  sources
[268] spatSample            split                 sprc
[271] stdev                 str                   stretch
[274] subset                subst                 summary
[277] Summary               surfArea              t
[280] tail                  tapp                  terrain
[283] text                  thresh                tighten
[286] time                  time&lt;-                timeInfo
[289] toMemory              trans                 trim
[292] unique                units                 units&lt;-
[295] update                values                values&lt;-
[298] varnames              varnames&lt;-            viewshed
[301] watershed             weighted.mean         where.max
[304] where.min             which.lyr             which.max
[307] which.min             window                window&lt;-
[310] wrap                  wrapCache             writeCDF
[313] writeRaster           writeStart            writeStop
[316] writeValues           xapp                  xFromCell
[319] xFromCol              xmax                  xmax&lt;-
[322] xmin                  xmin&lt;-                xres
[325] xyFromCell            yFromCell             yFromRow
[328] ymax                  ymax&lt;-                ymin
[331] ymin&lt;-                yres                  zonal
[334] zoom
see '?methods' for accessing help and source code</code></pre>
</div>
<ol start="3" style="list-style-type: decimal">
<li>A SpatRaster is the same no matter its number of bands.</li>
</ol>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>A single raster file can contain multiple bands or layers.</li>
<li>Use the <code>rast()</code> function to load all bands in a
multi-layer raster file into R.</li>
<li>Individual bands within a SpatRaster can be accessed, analyzed, and
visualized using the same functions no matter how many bands it
holds.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-06-vector-open-shapefile-in-r"><p>Content from <a href="06-vector-open-shapefile-in-r.html">Open and Plot Vector Layers</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/06-vector-open-shapefile-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I distinguish between and visualize point, line and polygon
vector data?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Know the difference between point, line, and polygon vector
elements.</li>
<li>Load point, line, and polygon vector layers into R.</li>
<li>Access the attributes of a spatial object in R.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>Starting with this episode, we will be moving from working with
raster data to working with vector data. In this episode, we will open
and plot point, line and polygon vector data loaded from ESRI’s
<code>shapefile</code> format into R. These data refer to the <a href="https://www.neonscience.org/field-sites/field-sites-map/HARV" class="external-link">NEON
Harvard Forest field site</a>, which we have been working with in
previous episodes. In later episodes, we will learn how to work with
raster and vector data together and combine them into a single plot.</p>
<section><h2 class="section-heading" id="import-vector-data">Import Vector Data<a class="anchor" aria-label="anchor" href="#import-vector-data"></a>
</h2>
<hr class="half-width">
<p>We will use the <code>sf</code> package to work with vector data in
R. We will also use the <code>terra</code> package, which has been
loaded in previous episodes, so we can explore raster and vector spatial
metadata using similar commands. Make sure you have the <code>sf</code>
library loaded.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span></code></pre>
</div>
<p>The vector layers that we will import from ESRI’s
<code>shapefile</code> format are:</p>
<ul>
<li>A polygon vector layer representing our field site boundary,</li>
<li>A line vector layer representing roads, and</li>
<li>A point vector layer representing the location of the <a href="https://www.neonscience.org/data-collection/flux-tower-measurements" class="external-link">Fisher
flux tower</a> located at the <a href="https://www.neonscience.org/field-sites/field-sites-map/HARV" class="external-link">NEON
Harvard Forest field site</a>.</li>
</ul>
<p>The first vector layer that we will open contains the boundary of our
study area (or our Area Of Interest or AOI, hence the name
<code>aoiBoundary</code>). To import a vector layer from an ESRI
<code>shapefile</code> we use the <code>sf</code> function
<code>st_read()</code>. <code>st_read()</code> requires the file path to
the ESRI <code>shapefile</code>.</p>
<p>Let’s import our AOI:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_HARV</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span></span>
<span>  <span class="st">"data/NEON-DS-Site-Layout-Files/HARV/HarClip_UTMZ18.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `HarClip_UTMZ18' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/HARV/HarClip_UTMZ18.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 732128 ymin: 4713209 xmax: 732251.1 ymax: 4713359
Projected CRS: WGS 84 / UTM zone 18N</code></pre>
</div>
</section><section><h2 class="section-heading" id="vector-layer-metadata-attributes">Vector Layer Metadata &amp; Attributes<a class="anchor" aria-label="anchor" href="#vector-layer-metadata-attributes"></a>
</h2>
<hr class="half-width">
<p>When we import the <code>HarClip_UTMZ18</code> vector layer from an
ESRI <code>shapefile</code> into R (as our
<code>aoi_boundary_HARV</code> object), the <code>st_read()</code>
function automatically stores information about the data. We are
particularly interested in the geospatial metadata, describing the
format, CRS, extent, and other components of the vector data, and the
attributes which describe properties associated with each individual
vector object.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>The <a href="07-vector-shapefile-attributes-in-r/">Explore and Plot
by Vector Layer Attributes</a> episode provides more information on both
metadata and attributes and using attributes to subset and plot
data.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="spatial-metadata">Spatial Metadata<a class="anchor" aria-label="anchor" href="#spatial-metadata"></a>
</h2>
<hr class="half-width">
<p>Key metadata for all vector layers includes:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Object Type:</strong> the class of the imported object.</li>
<li>
<strong>Coordinate Reference System (CRS):</strong> the projection
of the data.</li>
<li>
<strong>Extent:</strong> the spatial extent (i.e. geographic area
that the vector layer covers) of the data. Note that the spatial extent
for a vector layer represents the combined extent for all individual
objects in the vector layer.</li>
</ol>
<p>We can view metadata of a vector layer using the
<code>st_geometry_type()</code>, <code>st_crs()</code> and
<code>st_bbox()</code> functions. First, let’s view the geometry type
for our AOI vector layer:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_geometry_type</span><span class="op">(</span><span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] POLYGON
18 Levels: GEOMETRY POINT LINESTRING POLYGON MULTIPOINT ... TRIANGLE</code></pre>
</div>
<p>Our <code>aoi_boundary_HARV</code> is a polygon spatial object. The
18 levels shown below our output list the possible categories of the
geometry type. Now let’s check what CRS this file data is in:</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
<p>Our data in the CRS <strong>UTM zone 18N</strong>. The CRS is
critical to interpreting the spatial object’s extent values as it
specifies units. To find the extent of our AOI, we can use the
<code>st_bbox()</code> function:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 732128.0 4713208.7  732251.1 4713359.2 </code></pre>
</div>
<p>The spatial extent of a vector layer or R spatial object represents
the geographic “edge” or location that is the furthest north, south east
and west. Thus it represents the overall geographic coverage of the
spatial object. Image Source: National Ecological Observatory Network
(NEON).</p>
<figure><img src="fig/dc-spatial-vector/spatial_extent.png" alt="Extent image" class="figure mx-auto d-block"></figure><p>Lastly, we can view all of the metadata and attributes for this R
spatial object by printing it to the screen:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aoi_boundary_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 1 feature and 1 field
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: 732128 ymin: 4713209 xmax: 732251.1 ymax: 4713359
Projected CRS: WGS 84 / UTM zone 18N
  id                       geometry
1  1 POLYGON ((732128 4713359, 7...</code></pre>
</div>
</section><section><h2 class="section-heading" id="spatial-data-attributes">Spatial Data Attributes<a class="anchor" aria-label="anchor" href="#spatial-data-attributes"></a>
</h2>
<hr class="half-width">
<p>We introduced the idea of spatial data attributes in <a href="https://datacarpentry.org/organization-geospatial/02-intro-vector-data" class="external-link">an
earlier lesson</a>. Now we will explore how to use spatial data
attributes stored in our data to plot different features.</p>
</section><section><h2 class="section-heading" id="plot-a-vector-layer">Plot a vector layer<a class="anchor" aria-label="anchor" href="#plot-a-vector-layer"></a>
</h2>
<hr class="half-width">
<p>Next, let’s visualize the data in our <code>sf</code> object using
the <code>ggplot</code> package. Unlike with raster data, we do not need
to convert vector data to a dataframe before plotting with
<code>ggplot</code>.</p>
<p>We’re going to customize our boundary plot by setting the size,
color, and fill for our plot. When plotting <code>sf</code> objects with
<code>ggplot2</code>, you need to use the <code>coord_sf()</code>
coordinate system.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"cyan1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"AOI Boundary Plot"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/06-vector-open-shapefile-in-r-rendered-plot-shapefile-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-import-line-and-point-vector-layers" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-import-line-and-point-vector-layers" class="callout-inner">
<h3 class="callout-title">Challenge: Import Line and Point Vector Layers</h3>
<div class="callout-content">
<p>Using the steps above, import the HARV_roads and HARVtower_UTM18N
vector layers into R. Call the HARV_roads object <code>lines_HARV</code>
and the HARVtower_UTM18N <code>point_HARV</code>.</p>
<p>Answer the following questions:</p>
<ol style="list-style-type: decimal">
<li><p>What type of R spatial object is created when you import each
layer?</p></li>
<li><p>What is the CRS and extent for each object?</p></li>
<li><p>Do the files contain points, lines, or polygons?</p></li>
<li><p>How many spatial objects are in each file?</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>First we import the data:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines_HARV</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/HARV/HARV_roads.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `HARV_roads' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/HARV/HARV_roads.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 13 features and 15 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: 730741.2 ymin: 4711942 xmax: 733295.5 ymax: 4714260
Projected CRS: WGS 84 / UTM zone 18N</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_HARV</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/HARV/HARVtower_UTM18N.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `HARVtower_UTM18N' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/HARV/HARVtower_UTM18N.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 14 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 732183.2 ymin: 4713265 xmax: 732183.2 ymax: 4713265
Projected CRS: WGS 84 / UTM zone 18N</code></pre>
</div>
<p>Then we check its class:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "sf"         "data.frame"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "sf"         "data.frame"</code></pre>
</div>
<p>We also check the CRS and extent of each object:</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 730741.2 4711942.0  733295.5 4714260.0 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 732183.2 4713265.0  732183.2 4713265.0 </code></pre>
</div>
<p>To see the number of objects in each file, we can look at the output
from when we read these objects into R. <code>lines_HARV</code> contains
13 features (all lines) and <code>point_HARV</code> contains only one
point.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Metadata for vector layers include geometry type, CRS, and
extent.</li>
<li>Load spatial objects into R with the <code>st_read()</code>
function.</li>
<li>Spatial objects can be plotted directly with <code>ggplot</code>
using the <code>geom_sf()</code> function. No need to convert to a
dataframe.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-07-vector-shapefile-attributes-in-r"><p>Content from <a href="07-vector-shapefile-attributes-in-r.html">Explore and Plot by Vector Layer Attributes</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/07-vector-shapefile-attributes-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I compute on the attributes of a spatial object?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Query attributes of a spatial object.</li>
<li>Subset spatial objects using specific attribute values.</li>
<li>Plot a vector feature, colored by unique attribute values.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode continues our discussion of vector layer attributes and
covers how to work with vector layer attributes in R. It covers how to
identify and query layer attributes, as well as how to subset features
by specific attribute values. Finally, we will learn how to plot a
feature according to a set of attribute values.</p>
<section><h2 class="section-heading" id="load-the-data">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h2>
<hr class="half-width">
<p>We will continue using the <code>sf</code>, <code>terra</code>
<code>dplyr</code> and <code>ggplot2</code> packages in this episode.
Make sure that you have these packages loaded. We will continue to work
with the three ESRI <code>shapefiles</code> (vector layers) that we
loaded in the <a href="06-vector-open-shapefile-in-r/">Open and Plot
Vector Layers in R</a> episode.</p>
</section><section><h2 class="section-heading" id="query-vector-feature-metadata">Query Vector Feature Metadata<a class="anchor" aria-label="anchor" href="#query-vector-feature-metadata"></a>
</h2>
<hr class="half-width">
<p>As we discussed in the <a href="06-vector-open-shapefile-in-r/">Open
and Plot Vector Layers in R</a> episode, we can view metadata associated
with an R object using:</p>
<ul>
<li>
<code>st_geometry_type()</code> - The type of vector data stored in
the object.</li>
<li>
<code>nrow()</code> - The number of features in the object</li>
<li>
<code>st_bbox()</code> - The spatial extent (geographic area covered
by) of the object.</li>
<li>
<code>st_crs()</code> - The CRS (spatial projection) of the
data.</li>
</ul>
<p>We started to explore our <code>point_HARV</code> object in the
previous episode. To see a summary of all of the metadata associated
with our <code>point_HARV</code> object, we can view the object with
<code>View(point_HARV)</code> or print a summary of the object itself to
the console.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 1 feature and 14 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 732183.2 ymin: 4713265 xmax: 732183.2 ymax: 4713265
Projected CRS: WGS 84 / UTM zone 18N
  Un_ID Domain DomainName       SiteName Type       Sub_Type     Lat      Long
1     A      1  Northeast Harvard Forest Core Advanced Tower 42.5369 -72.17266
  Zone  Easting Northing                Ownership    County annotation
1   18 732183.2  4713265 Harvard University, LTER Worcester         C1
                  geometry
1 POINT (732183.2 4713265)</code></pre>
</div>
<p>We can use the <code>ncol</code> function to count the number of
attributes associated with a spatial object too. Note that the geometry
is just another column and counts towards the total. Let’s look at the
roads file:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ncol</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 16</code></pre>
</div>
<p>We can view the individual name of each attribute using the
<code>names()</code> function in R:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "OBJECTID_1" "OBJECTID"   "TYPE"       "NOTES"      "MISCNOTES"
 [6] "RULEID"     "MAPLABEL"   "SHAPE_LENG" "LABEL"      "BIKEHORSE"
[11] "RESVEHICLE" "RECMAP"     "Shape_Le_1" "ResVehic_1" "BicyclesHo"
[16] "geometry"  </code></pre>
</div>
<p>We could also view just the first 6 rows of attribute values using
the <code>head()</code> function to get a preview of the data:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Simple feature collection with 6 features and 15 fields
Geometry type: MULTILINESTRING
Dimension:     XY
Bounding box:  xmin: 730741.2 ymin: 4712685 xmax: 732232.3 ymax: 4713726
Projected CRS: WGS 84 / UTM zone 18N
  OBJECTID_1 OBJECTID       TYPE             NOTES MISCNOTES RULEID
1         14       48 woods road Locust Opening Rd      &lt;NA&gt;      5
2         40       91   footpath              &lt;NA&gt;      &lt;NA&gt;      6
3         41      106   footpath              &lt;NA&gt;      &lt;NA&gt;      6
4        211      279 stone wall              &lt;NA&gt;      &lt;NA&gt;      1
5        212      280 stone wall              &lt;NA&gt;      &lt;NA&gt;      1
6        213      281 stone wall              &lt;NA&gt;      &lt;NA&gt;      1
           MAPLABEL SHAPE_LENG             LABEL BIKEHORSE RESVEHICLE RECMAP
1 Locust Opening Rd 1297.35706 Locust Opening Rd         Y         R1      Y
2              &lt;NA&gt;  146.29984              &lt;NA&gt;         Y         R1      Y
3              &lt;NA&gt;  676.71804              &lt;NA&gt;         Y         R2      Y
4              &lt;NA&gt;  231.78957              &lt;NA&gt;      &lt;NA&gt;       &lt;NA&gt;   &lt;NA&gt;
5              &lt;NA&gt;   45.50864              &lt;NA&gt;      &lt;NA&gt;       &lt;NA&gt;   &lt;NA&gt;
6              &lt;NA&gt;  198.39043              &lt;NA&gt;      &lt;NA&gt;       &lt;NA&gt;   &lt;NA&gt;
  Shape_Le_1                            ResVehic_1                  BicyclesHo
1 1297.10617    R1 - All Research Vehicles Allowed Bicycles and Horses Allowed
2  146.29983    R1 - All Research Vehicles Allowed Bicycles and Horses Allowed
3  676.71807 R2 - 4WD/High Clearance Vehicles Only Bicycles and Horses Allowed
4  231.78962                                  &lt;NA&gt;                        &lt;NA&gt;
5   45.50859                                  &lt;NA&gt;                        &lt;NA&gt;
6  198.39041                                  &lt;NA&gt;                        &lt;NA&gt;
                        geometry
1 MULTILINESTRING ((730819.2 ...
2 MULTILINESTRING ((732040.2 ...
3 MULTILINESTRING ((732057 47...
4 MULTILINESTRING ((731903.6 ...
5 MULTILINESTRING ((732039.1 ...
6 MULTILINESTRING ((732056.2 ...</code></pre>
</div>
<div id="challenge-attributes-for-different-spatial-classes" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-attributes-for-different-spatial-classes" class="callout-inner">
<h3 class="callout-title">Challenge: Attributes for Different Spatial Classes</h3>
<div class="callout-content">
<p>Explore the attributes associated with the <code>point_HARV</code>
and <code>aoi_boundary_HARV</code> spatial objects.</p>
<ol style="list-style-type: decimal">
<li><p>How many attributes does each have?</p></li>
<li><p>Who owns the site in the <code>point_HARV</code> data
object?</p></li>
<li><p>Which of the following is NOT an attribute of the
<code>point_HARV</code> data object?</p></li>
</ol>
<ol style="list-style-type: upper-alpha">
<li>Latitude B) County C) Country</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>To find the number of attributes, we use the <code>ncol()</code>
function:</li>
</ol>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ncol</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 15</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ncol</span><span class="op">(</span><span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 2</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>Ownership information is in a column named
<code>Ownership</code>:</li>
</ol>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">point_HARV</span><span class="op">$</span><span class="va">Ownership</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "Harvard University, LTER"</code></pre>
</div>
<ol start="3" style="list-style-type: decimal">
<li>To see a list of all of the attributes, we can use the
<code>names()</code> function:</li>
</ol>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Un_ID"      "Domain"     "DomainName" "SiteName"   "Type"
 [6] "Sub_Type"   "Lat"        "Long"       "Zone"       "Easting"
[11] "Northing"   "Ownership"  "County"     "annotation" "geometry"  </code></pre>
</div>
<p>“Country” is not an attribute of this object.</p>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="explore-values-within-one-attribute">Explore Values within One Attribute<a class="anchor" aria-label="anchor" href="#explore-values-within-one-attribute"></a>
</h2>
<hr class="half-width">
<p>We can explore individual values stored within a particular
attribute. Comparing attributes to a spreadsheet or a data frame, this
is similar to exploring values in a column. We did this with the
<code>gapminder</code> dataframe in <a href="https://datacarpentry.org/r-intro-geospatial/05-data-subsetting/index.html" class="external-link">an
earlier lesson</a>. For spatial objects, we can use the same syntax:
<code>objectName$attributeName</code>.</p>
<p>We can see the contents of the <code>TYPE</code> field of our lines
feature:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines_HARV</span><span class="op">$</span><span class="va">TYPE</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "woods road" "footpath"   "footpath"   "stone wall" "stone wall"
 [6] "stone wall" "stone wall" "stone wall" "stone wall" "boardwalk"
[11] "woods road" "woods road" "woods road"</code></pre>
</div>
<p>To see only unique values within the <code>TYPE</code> field, we can
use the <code>unique()</code> function for extracting the possible
values of a character variable (R also is able to handle categorical
variables called factors; we worked with factors a little bit in <a href="https://datacarpentry.org/r-intro-geospatial/03-data-structures-part1/index.html" class="external-link">an
earlier lesson</a>.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">$</span><span class="va">TYPE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "woods road" "footpath"   "stone wall" "boardwalk" </code></pre>
</div>
<div class="section level3">
<h3 id="subset-features">Subset Features<a class="anchor" aria-label="anchor" href="#subset-features"></a>
</h3>
<p>We can use the <code>filter()</code> function from <code>dplyr</code>
that we worked with in <a href="https://datacarpentry.org/r-intro-geospatial/06-dplyr" class="external-link">an earlier
lesson</a> to select a subset of features from a spatial object in R,
just like with data frames.</p>
<p>For example, we might be interested only in features that are of
<code>TYPE</code> “footpath”. Once we subset out this data, we can use
it as input to other code so that code only operates on the footpath
lines.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">footpath_HARV</span> <span class="op">&lt;-</span> <span class="va">lines_HARV</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">TYPE</span> <span class="op">==</span> <span class="st">"footpath"</span><span class="op">)</span></span>
<span><span class="fu">nrow</span><span class="op">(</span><span class="va">footpath_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 2</code></pre>
</div>
<p>Our subsetting operation reduces the <code>features</code> count to
2. This means that only two feature lines in our spatial object have the
attribute <code>TYPE == footpath</code>. We can plot only the footpath
lines:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">footpath_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>, subtitle <span class="op">=</span> <span class="st">"Footpaths"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-plot-subset-shapefile-1.png" alt="Map of the footpaths in the study area." class="figure mx-auto d-block"><figcaption>
Map of the footpaths in the study area.
</figcaption></figure><p>There are two features in our footpaths subset. Why does the plot
look like there is only one feature? Let’s adjust the colors used in our
plot. If we have 2 features in our vector object, we can plot each using
a unique color by assigning a column name to the color aesthetic
(<code>color =</code>). We use the syntax <code>aes(color = )</code> to
do this. We can also alter the default line thickness by using the
<code>linewidth =</code> parameter, as the default value of 0.5 can be
hard to see. Note that size is placed outside of the <code>aes()</code>
function, as we are not connecting line thickness to a data
variable.</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">footpath_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">factor</span><span class="op">(</span><span class="va">OBJECTID</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Footpath ID'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>, subtitle <span class="op">=</span> <span class="st">"Footpaths"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-plot-subset-shapefile-unique-colors-1.png" alt="Map of the footpaths in the study area where each feature is colored differently." class="figure mx-auto d-block"><figcaption>
Map of the footpaths in the study area where each feature is colored
differently.
</figcaption></figure><p>Now, we see that there are in fact two features in our plot!</p>
<div id="challenge-subset-spatial-line-objects-part-1" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-subset-spatial-line-objects-part-1" class="callout-inner">
<h3 class="callout-title">Challenge: Subset Spatial Line Objects Part 1</h3>
<div class="callout-content">
<p>Subset out all <code>boardwalk</code> from the lines layer and plot
it.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>First we will save an object with only the boardwalk lines:</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boardwalk_HARV</span> <span class="op">&lt;-</span> <span class="va">lines_HARV</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">TYPE</span> <span class="op">==</span> <span class="st">"boardwalk"</span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s check how many features there are in this subset:</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">nrow</span><span class="op">(</span><span class="va">boardwalk_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 1</code></pre>
</div>
<p>Now let’s plot that data:</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">boardwalk_HARV</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>, subtitle <span class="op">=</span> <span class="st">"Boardwalks"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-boardwalk-map-1.png" alt="Map of the boardwalks in the study area." class="figure mx-auto d-block"><figcaption>
Map of the boardwalks in the study area.
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="challenge-subset-spatial-line-objects-part-2" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-subset-spatial-line-objects-part-2" class="callout-inner">
<h3 class="callout-title">Challenge: Subset Spatial Line Objects Part 2</h3>
<div class="callout-content">
<p>Subset out all <code>stone wall</code> features from the lines layer
and plot it. For each plot, color each feature using a unique color.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Answer
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<p>First we will save an object with only the stone wall lines and check
the number of features:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stoneWall_HARV</span> <span class="op">&lt;-</span> <span class="va">lines_HARV</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">TYPE</span> <span class="op">==</span> <span class="st">"stone wall"</span><span class="op">)</span></span>
<span><span class="fu">nrow</span><span class="op">(</span><span class="va">stoneWall_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 6</code></pre>
</div>
<p>Now we can plot the data:</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">stoneWall_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="fu">factor</span><span class="op">(</span><span class="va">OBJECTID</span><span class="op">)</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Wall ID'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>, subtitle <span class="op">=</span> <span class="st">"Stonewalls"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-stone-wall-map-1.png" alt="Map of the stone walls in the study area where each feature is colored differently." class="figure mx-auto d-block"><figcaption>
Map of the stone walls in the study area where each feature is colored
differently.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="customize-plots">Customize Plots<a class="anchor" aria-label="anchor" href="#customize-plots"></a>
</h2>
<hr class="half-width">
<p>In the examples above, <code>ggplot()</code> automatically selected
colors for each line based on a default color order. If we don’t like
those default colors, we can create a vector of colors - one for each
feature.</p>
<p>First we will check how many unique values our TYPE attribute
has:</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">$</span><span class="va">TYPE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "woods road" "footpath"   "stone wall" "boardwalk" </code></pre>
</div>
<p>Then we can create a palette of four colors, one for each feature in
our vector object.</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">road_colors</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"blue"</span>, <span class="st">"green"</span>, <span class="st">"navy"</span>, <span class="st">"purple"</span><span class="op">)</span></span></code></pre>
</div>
<p>We can tell <code>ggplot</code> to use these colors when we plot the
data.</p>
<div class="codewrapper sourceCode" id="cb35">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Road Type'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>, subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-paths-map-1.png" alt="Roads and trails in the area." class="figure mx-auto d-block"><figcaption>
Roads and trails in the area.
</figcaption></figure><div class="section level3">
<h3 id="adjust-line-width">Adjust Line Width<a class="anchor" aria-label="anchor" href="#adjust-line-width"></a>
</h3>
<p>We adjusted line width universally earlier. If we want a unique line
width for each attribute category in our spatial object, we can use the
same syntax that we used for colors, above.</p>
<p>We already know that we have four different <code>TYPE</code>s in the
lines_HARV object, so we will set four different line widths.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">line_widths</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre>
</div>
<p>We can use those line widths when we plot the data.</p>
<div class="codewrapper sourceCode" id="cb37">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span>, linewidth <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Road Type'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">line_widths</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails - Line width varies"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Using linewidth for a discrete variable is not advised.</code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-paths-map-wide-1.png" alt="Roads and trails in the area demonstrating how to use different line thickness and colors." class="figure mx-auto d-block"><figcaption>
Roads and trails in the area demonstrating how to use different line
thickness and colors.
</figcaption></figure><div id="challenge-plot-line-width-by-attribute" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-line-width-by-attribute" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Line Width by Attribute</h3>
<div class="callout-content">
<p>In the example above, we set the line widths to be 1, 2, 3, and 4.
Because R orders alphabetically by default, this gave us a plot where
woods roads (the last type) were the thickest and boardwalks were the
thinnest.</p>
<p>Let’s create another plot where we show the different line types with
the following thicknesses:</p>
<ol style="list-style-type: decimal">
<li>woods road size = 6</li>
<li>boardwalks size = 1</li>
<li>footpath size = 3</li>
<li>stone wall size = 2</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Answers
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<p>First we need to look at the values of our data to see what order the
road types are in:</p>
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">unique</span><span class="op">(</span><span class="va">lines_HARV</span><span class="op">$</span><span class="va">TYPE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "woods road" "footpath"   "stone wall" "boardwalk" </code></pre>
</div>
<p>We then can create our <code>line_width</code> vector setting each of
the levels to the desired thickness.</p>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">line_width</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">2</span>, <span class="fl">6</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can create our plot.</p>
<div class="codewrapper sourceCode" id="cb42">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_size_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">line_width</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails - Line width varies"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Using linewidth for a discrete variable is not advised.</code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-path-line-types-1.png" alt="Roads and trails in the area with different line thickness for each type of paths." class="figure mx-auto d-block"><figcaption>
Roads and trails in the area with different line thickness for each type
of paths.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="add-plot-legend">Add Plot Legend<a class="anchor" aria-label="anchor" href="#add-plot-legend"></a>
</h3>
<p>We can add a legend to our plot too. When we add a legend, we use the
following elements to specify labels and colors:</p>
<p>Let’s add a legend to our plot. We will use the
<code>road_colors</code> object that we created above to color the
legend. We can customize the appearance of our legend by manually
setting different parameters.</p>
<div class="codewrapper sourceCode" id="cb44">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Road Type'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails - Default Legend"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-add-legend-to-plot-1.png" alt="Roads and trails in the study area using thicker lines than the previous figure." class="figure mx-auto d-block"><figcaption>
Roads and trails in the study area using thicker lines than the previous
figure.
</figcaption></figure><p>We can change the appearance of our legend by manually setting
different parameters.</p>
<ul>
<li>
<code>legend.text</code>: change the font size</li>
<li>
<code>legend.box.background</code>: add an outline box</li>
</ul>
<div class="codewrapper sourceCode" id="cb45">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Road Type'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>        legend.box.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails - Modified Legend"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-modify-legend-plot-1.png" alt="Map of the paths in the study area with large-font and border around the legend." class="figure mx-auto d-block"><figcaption>
Map of the paths in the study area with large-font and border around the
legend.
</figcaption></figure><div class="codewrapper sourceCode" id="cb46">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_colors</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"springgreen"</span>, <span class="st">"blue"</span>, <span class="st">"magenta"</span>, <span class="st">"orange"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">new_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">'Road Type'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>        legend.box.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads &amp; Trails - Pretty Colors"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: The `size` argument of `element_rect()` is deprecated as of ggplot2 3.4.0.
ℹ Please use the `linewidth` argument instead.
This warning is displayed once every 8 hours.
Call `lifecycle::last_lifecycle_warnings()` to see where this warning was
generated.</code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-plot-different-colors-1.png" alt="Map of the paths in the study area using a different color palette." class="figure mx-auto d-block"><figcaption>
Map of the paths in the study area using a different color palette.
</figcaption></figure><div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>You can modify the default R color palette using the palette method.
For example <code>palette(rainbow(6))</code> or
<code>palette(terrain.colors(6))</code>. You can reset the palette
colors using <code>palette("default")</code>!</p>
<p>You can also use colorblind-friendly palettes such as those in the <a href="https://cran.r-project.org/package=viridis" class="external-link">viridis
package</a>.</p>
</div>
</div>
</div>
<div id="challenge-plot-lines-by-attribute" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-lines-by-attribute" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Lines by Attribute</h3>
<div class="callout-content">
<p>Create a plot that emphasizes only roads where bicycles and horses
are allowed. To emphasize this, make the lines where bicycles are not
allowed THINNER than the roads where bicycles are allowed. NOTE: this
attribute information is located in the
<code>lines_HARV$BicyclesHo</code> attribute.</p>
<p>Be sure to add a title and legend to your map. You might consider a
color palette that has all bike/horse-friendly roads displayed in a
bright color. All other lines can be black.</p>
</div>
</div>
</div>
<div id="accordionSolution5" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution5" aria-expanded="false" aria-controls="collapseSolution5">
  <h4 class="accordion-header" id="headingSolution5">
  Answers
  </h4>
</button>
<div id="collapseSolution5" class="accordion-collapse collapse" data-bs-parent="#accordionSolution5" aria-labelledby="headingSolution5">
<div class="accordion-body">
<p>First we explore the <code>BicyclesHo</code> attribute to learn the
values that correspond to the roads we need.</p>
<div class="codewrapper sourceCode" id="cb48">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines_HARV</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">BicyclesHo</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">unique</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "Bicycles and Horses Allowed"     NA
[3] "DO NOT SHOW ON REC MAP"          "Bicycles and Horses NOT ALLOWED"</code></pre>
</div>
<p>Now, we can create a data frame with only those roads where bicycles
and horses are allowed.</p>
<div class="codewrapper sourceCode" id="cb50">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lines_showHarv</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">lines_HARV</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">BicyclesHo</span> <span class="op">==</span> <span class="st">"Bicycles and Horses Allowed"</span><span class="op">)</span></span></code></pre>
</div>
<p>Finally, we plot the needed roads after setting them to magenta and a
thicker line width.</p>
<div class="codewrapper sourceCode" id="cb51">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_showHarv</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">BicyclesHo</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"magenta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"Roads Where Bikes and Horses Are Allowed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-harv-paths-bike-horses-1.png" alt="Roads and trails in the area highlighting paths where horses and bikes are allowed." class="figure mx-auto d-block"><figcaption>
Roads and trails in the area highlighting paths where horses and bikes
are allowed.
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="challenge-plot-polygon-by-attribute" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-polygon-by-attribute" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Polygon by Attribute</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Create a map of the state boundaries in the United States using the
data located in your downloaded data folder:
<code>NEON-DS-Site-Layout-Files/US-Boundary-Layers\US-State-Boundaries-Census-2014</code>.
Apply a line color to each state using its <code>region</code> value.
Add a legend.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution6" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution6" aria-expanded="false" aria-controls="collapseSolution6">
  <h4 class="accordion-header" id="headingSolution6">
  Answers
  </h4>
</button>
<div id="collapseSolution6" class="accordion-collapse collapse" data-bs-parent="#accordionSolution6" aria-labelledby="headingSolution6">
<div class="accordion-body">
<p>First we read in the data and check how many levels there are in the
<code>region</code> column:</p>
<div class="codewrapper sourceCode" id="cb52">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_boundary_US</span> <span class="op">&lt;-</span></span>
<span><span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span><span class="co"># NOTE: We need neither Z nor M coordinates!</span></span>
<span><span class="fu">st_zm</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `US-State-Boundaries-Census-2014' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 58 features and 10 fields
Geometry type: MULTIPOLYGON
Dimension:     XYZ
Bounding box:  xmin: -124.7258 ymin: 24.49813 xmax: -66.9499 ymax: 49.38436
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb54">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_boundary_US</span><span class="op">$</span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu">as.factor</span><span class="op">(</span><span class="va">state_boundary_US</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span>
<span><span class="fu">levels</span><span class="op">(</span><span class="va">state_boundary_US</span><span class="op">$</span><span class="va">region</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "Midwest"   "Northeast" "Southeast" "Southwest" "West"     </code></pre>
</div>
<p>Next we set a color vector with that many items:</p>
<div class="codewrapper sourceCode" id="cb56">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"purple"</span>, <span class="st">"springgreen"</span>, <span class="st">"yellow"</span>, <span class="st">"brown"</span>, <span class="st">"navy"</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can create our plot:</p>
<div class="codewrapper sourceCode" id="cb57">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">state_boundary_US</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">region</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Contiguous U.S. State Boundaries"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure style="text-align: center"><img src="fig/07-vector-shapefile-attributes-in-r-rendered-colored-state-boundaries-1.png" alt="Map of the continental United States where the state lines are colored by region." class="figure mx-auto d-block"><figcaption>
Map of the continental United States where the state lines are colored
by region.
</figcaption></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Spatial objects in <code>sf</code> are similar to standard data
frames and can be manipulated using the same functions.</li>
<li>Almost any feature of a plot can be customized using the various
functions and options in the <code>ggplot2</code> package.</li>
</ul>
</div>
</div>
</div>
</div>
</section></section><section id="aio-08-vector-plot-shapefiles-custom-legend"><p>Content from <a href="08-vector-plot-shapefiles-custom-legend.html">Plot Multiple Vector Layers</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/08-vector-plot-shapefiles-custom-legend.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create map compositions with custom legends using
ggplot?</li>
<li>How can I plot raster and vector data together?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Plot multiple vector layers in the same plot.</li>
<li>Apply custom symbols to spatial objects in a plot.</li>
<li>Create a multi-layered plot with raster and vector data.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode builds upon <a href="07-vector-shapefile-attributes-in-r/">the previous episode</a> to
work with vector layers in R and explore how to plot multiple vector
layers. It also covers how to plot raster and vector data together on
the same plot.</p>
<section><h2 class="section-heading" id="load-the-data">Load the Data<a class="anchor" aria-label="anchor" href="#load-the-data"></a>
</h2>
<hr class="half-width">
<p>To work with vector data in R, we can use the <code>sf</code>
library. The <code>terra</code> package also allows us to explore
metadata using similar commands for both raster and vector files. Make
sure that you have these packages loaded.</p>
<p>We will continue to work with the three ESRI <code>shapefile</code>
that we loaded in the <a href="06-vector-open-shapefile-in-r/">Open and
Plot Vector Layers in R</a> episode.</p>
</section><section><h2 class="section-heading" id="plotting-multiple-vector-layers">Plotting Multiple Vector Layers<a class="anchor" aria-label="anchor" href="#plotting-multiple-vector-layers"></a>
</h2>
<hr class="half-width">
<p>In the <a href="07-vector-shapefile-attributes-in-r/">previous
episode</a>, we learned how to plot information from a single vector
layer and do some plot customization including adding a custom legend.
However, what if we want to create a more complex plot with many vector
layers and unique symbols that need to be represented clearly in a
legend?</p>
<p>Now, let’s create a plot that combines our tower location
(<code>point_HARV</code>), site boundary
(<code>aoi_boundary_HARV</code>) and roads (<code>lines_HARV</code>)
spatial objects. We will need to build a custom legend as well.</p>
<p>To begin, we will create a plot with the site boundary as the first
layer. Then layer the tower location and road data on top using
<code>+</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, fill <span class="op">=</span> <span class="st">"grey"</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-plot-many-shapefiles-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Next, let’s build a custom legend using the symbology (the colors and
symbols) that we used to create the plot above. For example, it might be
good if the lines were symbolized as lines. In the previous episode, you
may have noticed that the default legend behavior for
<code>geom_sf</code> is to draw a ‘patch’ for each legend entry. If you
want the legend to draw lines or points, you need to add an instruction
to the <code>geom_sf</code> call - in this case,
<code>show.legend = 'line'</code>.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, fill <span class="op">=</span> <span class="st">"grey"</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>,</span>
<span>          show.legend <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Sub_Type</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-plot-custom-shape-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now lets adjust the legend titles by passing a <code>name</code> to
the respective <code>color</code> and <code>fill</code> palettes.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, fill <span class="op">=</span> <span class="st">"grey"</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Sub_Type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="st">"line"</span>,</span>
<span>          size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span>, name <span class="op">=</span> <span class="st">"Line Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span>, name <span class="op">=</span> <span class="st">"Tower Location"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-create-custom-legend-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Finally, it might be better if the points were symbolized as a
symbol. We can customize this using <code>shape</code> parameters in our
call to <code>geom_sf</code>: 16 is a point symbol, 15 is a box.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>To view a short list of <code>shape</code> symbols, type
<code>?pch</code> into the R console.</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, fill <span class="op">=</span> <span class="st">"grey"</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Sub_Type</span><span class="op">)</span>, shape <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>,</span>
<span>          show.legend <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">road_colors</span>, name <span class="op">=</span> <span class="st">"Line Type"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="st">"black"</span>, name <span class="op">=</span> <span class="st">"Tower Location"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-custom-symbols-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-plot-polygon-by-attribute" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-polygon-by-attribute" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Polygon by Attribute</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>Using the
<code>NEON-DS-Site-Layout-Files/HARV/PlotLocations_HARV.shp</code> ESRI
<code>shapefile</code>, create a map of study plot locations, with each
point colored by the soil type (<code>soilTypeOr</code>). How many
different soil types are there at this particular field site? Overlay
this layer on top of the <code>lines_HARV</code> layer (the roads).
Create a custom legend that applies line symbols to lines and point
symbols to the points.</p></li>
<li><p>Modify the plot above. Tell R to plot each point, using a
different symbol of <code>shape</code> value.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>First we need to read in the data and see how many unique soils are
represented in the <code>soilTypeOr</code> attribute.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_locations</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/HARV/PlotLocations_HARV.shp"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `PlotLocations_HARV' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/HARV/PlotLocations_HARV.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 21 features and 25 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 731405.3 ymin: 4712845 xmax: 732275.3 ymax: 4713846
Projected CRS: WGS 84 / UTM zone 18N</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_locations</span><span class="op">$</span><span class="va">soilTypeOr</span> <span class="op">&lt;-</span> <span class="fu">as.factor</span><span class="op">(</span><span class="va">plot_locations</span><span class="op">$</span><span class="va">soilTypeOr</span><span class="op">)</span></span>
<span><span class="fu">levels</span><span class="op">(</span><span class="va">plot_locations</span><span class="op">$</span><span class="va">soilTypeOr</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "Histosols"   "Inceptisols"</code></pre>
</div>
<p>Next we can create a new color palette with one color for each soil
type.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">blue_orange</span> <span class="op">&lt;-</span> <span class="fu">c</span><span class="op">(</span><span class="st">"cornflowerblue"</span>, <span class="st">"darkorange"</span><span class="op">)</span></span></code></pre>
</div>
<p>Finally, we will create our plot.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="st">"line"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">soilTypeOr</span><span class="op">)</span>,</span>
<span>          shape <span class="op">=</span> <span class="fl">21</span>, show.legend <span class="op">=</span> <span class="st">'point'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Line Type"</span>, values <span class="op">=</span> <span class="va">road_colors</span>,</span>
<span>     guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"solid"</span>,</span>
<span>                                              shape <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Soil Type"</span>, values <span class="op">=</span> <span class="va">blue_orange</span>,</span>
<span>     guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"blank"</span>, shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>                                              colour <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-harv-plot-locations-bg-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>If we want each soil to be shown with a different symbol, we can give
multiple values to the <code>scale_shape_manual()</code> argument.</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">TYPE</span><span class="op">)</span>, show.legend <span class="op">=</span> <span class="st">"line"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations</span>, <span class="fu">aes</span><span class="op">(</span>fill <span class="op">=</span> <span class="va">soilTypeOr</span>, shape <span class="op">=</span> <span class="va">soilTypeOr</span><span class="op">)</span>,</span>
<span>          show.legend <span class="op">=</span> <span class="st">'point'</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_shape_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Soil Type"</span>, values <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">21</span>, <span class="fl">22</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_color_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Line Type"</span>, values <span class="op">=</span> <span class="va">road_colors</span>,</span>
<span>     guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"solid"</span>, shape <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Soil Type"</span>, values <span class="op">=</span> <span class="va">blue_orange</span>,</span>
<span>     guide <span class="op">=</span> <span class="fu">guide_legend</span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu">list</span><span class="op">(</span>linetype <span class="op">=</span> <span class="st">"blank"</span>, shape <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">21</span>, <span class="fl">22</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-harv-plot-locations-pch-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="challenge-plot-raster-vector-data-together" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-raster-vector-data-together" class="callout-inner">
<h3 class="callout-title">Challenge: Plot Raster &amp; Vector Data Together</h3>
<div class="callout-content">
<p>You can plot vector data layered on top of raster data using the
<code>+</code> to add a layer in <code>ggplot</code>. Create a plot that
uses the NEON AOI Canopy Height Model
<code>data/NEON-DS-Airborne-Remote-Sensing/HARV/CHM/HARV_chmCrop.tif</code>
as a base layer. On top of the CHM, please add:</p>
<ul>
<li>The study site AOI.</li>
<li>Roads.</li>
<li>The tower location.</li>
</ul>
<p>Be sure to give your plot a meaningful title.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">lines_HARV</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, color <span class="op">=</span> <span class="st">"grey20"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, pch <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"NEON Harvard Forest Field Site w/ Canopy Height Model"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/08-vector-plot-shapefiles-custom-legend-rendered-challenge-vector-raster-overlay-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>+</code> operator to add multiple layers to a
ggplot.</li>
<li>Multi-layered plots can combine raster and vector datasets.</li>
<li>Use the <code>show.legend</code> argument to set legend symbol
types.</li>
<li>Use the <code>scale_fill_manual()</code> function to set legend
colors.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-09-vector-when-data-dont-line-up-crs"><p>Content from <a href="09-vector-when-data-dont-line-up-crs.html">Handling Spatial Projection &amp; CRS</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/09-vector-when-data-dont-line-up-crs.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What do I do when vector data don’t line up?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Plot vector objects with different CRSs in the same plot.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>In <a href="03-raster-reproject-in-r/">an earlier episode</a> we
learned how to handle a situation where you have two different files
with raster data in different projections. Now we will apply those same
principles to working with vector data. We will create a base map of our
study site using United States state and country boundary information
accessed from the <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html" class="external-link">United
States Census Bureau</a>. We will learn how to map vector data that are
in different CRSs and thus don’t line up on a map.</p>
<p>We will continue to work with the three ESRI <code>shapefiles</code>
that we loaded in the <a href="06-vector-open-shapefile-in-r/">Open and
Plot Vector Layers in R</a> episode.</p>
<section><h2 class="section-heading" id="working-with-spatial-data-from-different-sources">Working With Spatial Data From Different Sources<a class="anchor" aria-label="anchor" href="#working-with-spatial-data-from-different-sources"></a>
</h2>
<hr class="half-width">
<p>We often need to gather spatial datasets from different sources
and/or data that cover different spatial extents. These data are often
in different Coordinate Reference Systems (CRSs).</p>
<p>Some reasons for data being in different CRSs include:</p>
<ol style="list-style-type: decimal">
<li>The data are stored in a particular CRS convention used by the data
provider (for example, a government agency).</li>
<li>The data are stored in a particular CRS that is customized to a
region. For instance, many states in the US prefer to use a State Plane
projection customized for that state.</li>
</ol>
<p><img src="fig/map_usa_different_projections.jpg" alt="Maps of the United States using data in different projections. Source: opennews.org, from: https://media.opennews.org/cache/06/37/0637aa2541b31f526ad44f7cb2db7b6c.jpg" class="figure">{alt=’Maps
of the United States using data in different projections.}</p>
<p>Notice the differences in shape associated with each different
projection. These differences are a direct result of the calculations
used to “flatten” the data onto a 2-dimensional map. Often data are
stored purposefully in a particular projection that optimizes the
relative shape and size of surrounding geographic boundaries (states,
counties, countries, etc).</p>
<p>In this episode we will learn how to identify and manage spatial data
in different projections. We will learn how to reproject the data so
that they are in the same projection to support plotting / mapping. Note
that these skills are also required for any geoprocessing / spatial
analysis. Data need to be in the same CRS to ensure accurate
results.</p>
<p>We will continue to use the <code>sf</code> and <code>terra</code>
packages in this episode.</p>
</section><section><h2 class="section-heading" id="import-us-boundaries---census-data">Import US Boundaries - Census Data<a class="anchor" aria-label="anchor" href="#import-us-boundaries---census-data"></a>
</h2>
<hr class="half-width">
<p>There are many good sources of boundary base layers that we can use
to create a basemap. Some R packages even have these base layers built
in to support quick and efficient mapping. In this episode, we will use
boundary layers for the contiguous United States, provided by the <a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html" class="external-link">United
States Census Bureau</a>. It is useful to have vector layers in ESRI’s
<code>shapefile</code> format to work with because we can add additional
attributes to them if need be - for project specific mapping.</p>
</section><section><h2 class="section-heading" id="read-us-boundary-file">Read US Boundary File<a class="anchor" aria-label="anchor" href="#read-us-boundary-file"></a>
</h2>
<hr class="half-width">
<p>We will use the <code>st_read()</code> function to import the
<code>/US-Boundary-Layers/US-State-Boundaries-Census-2014</code> layer
into R. This layer contains the boundaries of all contiguous states in
the U.S. Please note that these data have been modified and reprojected
from the original data downloaded from the Census website to support the
learning goals of this episode.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_boundary_US</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_zm</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `US-State-Boundaries-Census-2014' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 58 features and 10 fields
Geometry type: MULTIPOLYGON
Dimension:     XYZ
Bounding box:  xmin: -124.7258 ymin: 24.49813 xmax: -66.9499 ymax: 49.38436
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  WGS 84</code></pre>
</div>
<p>Next, let’s plot the U.S. states data:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">state_boundary_US</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of Contiguous US State Boundaries"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-find-coordinates-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="u-s--boundary-layer">U.S. Boundary Layer<a class="anchor" aria-label="anchor" href="#u-s--boundary-layer"></a>
</h2>
<hr class="half-width">
<p>We can add a boundary layer of the United States to our map - to make
it look nicer. We will import
<code>NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States</code>.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">country_boundary_US</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_zm</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `US-Boundary-Dissolved-States' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 9 fields
Geometry type: MULTIPOLYGON
Dimension:     XYZ
Bounding box:  xmin: -124.7258 ymin: 24.49813 xmax: -66.9499 ymax: 49.38436
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  WGS 84</code></pre>
</div>
<p>If we specify a thicker line width using <code>size = 2</code> for
the border layer, it will make our map pop! We will also manually set
the colors of the state boundaries and country boundaries.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">state_boundary_US</span>, color <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">country_boundary_US</span>, color <span class="op">=</span> <span class="st">"black"</span>,alpha <span class="op">=</span> <span class="fl">0.25</span>,size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of Contiguous US State Boundaries"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-us-boundaries-thickness-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Next, let’s add the location of a flux tower where our study area is.
As we are adding these layers, take note of the CRS of each object.
First let’s look at the CRS of our tower location object:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span><span class="op">$</span><span class="va">proj4string</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs"</code></pre>
</div>
<p>Our project string for <code>point_HARV</code> specifies the UTM
projection as follows:</p>
<p><code>+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs</code></p>
<ul>
<li>
<strong>proj=utm:</strong> the projection is UTM, UTM has several
zones.</li>
<li>
<strong>zone=18:</strong> the zone is 18</li>
<li>
<strong>datum=WGS84:</strong> the datum WGS84 (the datum refers to
the 0,0 reference for the coordinate system used in the projection)</li>
<li>
<strong>units=m:</strong> the units for the coordinates are in
METERS.</li>
</ul>
<p>Note that the <code>zone</code> is unique to the UTM projection. Not
all CRSs will have a zone.</p>
<p>Let’s check the CRS of our state and country boundary objects:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">state_boundary_US</span><span class="op">)</span><span class="op">$</span><span class="va">proj4string</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=longlat +datum=WGS84 +no_defs"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">country_boundary_US</span><span class="op">)</span><span class="op">$</span><span class="va">proj4string</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=longlat +datum=WGS84 +no_defs"</code></pre>
</div>
<p>Our project string for <code>state_boundary_US</code> and
<code>country_boundary_US</code> specifies the lat/long projection as
follows:</p>
<p><code>+proj=longlat +datum=WGS84 +no_defs</code></p>
<ul>
<li>
<strong>proj=longlat:</strong> the data are in a geographic
(latitude and longitude) coordinate system</li>
<li>
<strong>datum=WGS84:</strong> the datum WGS84 (the datum refers to
the 0,0 reference for the coordinate system used in the projection)</li>
<li>
<strong>no_defs:</strong> ensures that no defaults are used, but
this is now obsolete</li>
</ul>
<p>Note that there are no specified units above. This is because this
geographic coordinate reference system is in latitude and longitude
which is most often recorded in decimal degrees.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>the last portion of each <code>proj4</code> string could potentially
be something like <code>+towgs84=0,0,0</code>. This is a conversion
factor that is used if a datum conversion is required. We will not deal
with datums in this episode series.</p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="crs-units---view-object-extent">CRS Units - View Object Extent<a class="anchor" aria-label="anchor" href="#crs-units---view-object-extent"></a>
</h2>
<hr class="half-width">
<p>Next, let’s view the extent or spatial coverage for the
<code>point_HARV</code> spatial object compared to the
<code>state_boundary_US</code> object.</p>
<p>First we’ll look at the extent for our study site:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 732183.2 4713265.0  732183.2 4713265.0 </code></pre>
</div>
<p>And then the extent for the state boundary data.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">state_boundary_US</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>      xmin       ymin       xmax       ymax
-124.72584   24.49813  -66.94989   49.38436 </code></pre>
</div>
<p>Note the difference in the units for each object. The extent for
<code>state_boundary_US</code> is in latitude and longitude which yields
smaller numbers representing decimal degree units. Our tower location
point is in UTM, is represented in meters.</p>
<div id="proj4-crs-resources" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="proj4-crs-resources" class="callout-inner">
<h3 class="callout-title">Proj4 &amp; CRS Resources</h3>
<div class="callout-content">
<ul>
<li><a href="https://proj4.org/" class="external-link">Official PROJ library
documentation</a></li>
<li><a href="https://proj.maptools.org/faq.html" class="external-link">More information on the
proj4 format.</a></li>
<li><a href="https://spatialreference.org" class="external-link">A fairly comprehensive list
of CRSs by format.</a></li>
<li>To view a list of datum conversion factors type:
<code>sf_proj_info(type = "datum")</code> into the R console. However,
the results would depend on the underlying version of the PROJ
library.</li>
</ul>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="reproject-vector-data-or-no">Reproject Vector Data or No?<a class="anchor" aria-label="anchor" href="#reproject-vector-data-or-no"></a>
</h2>
<hr class="half-width">
<p>We saw in <a href="03-raster-reproject-in-r/">an earlier episode</a>
that when working with raster data in different CRSs, we needed to
convert all objects to the same CRS. We can do the same thing with our
vector data - however, we don’t need to! When using the
<code>ggplot2</code> package, <code>ggplot</code> automatically converts
all objects to the same CRS before plotting. This means we can plot our
three data sets together without doing any conversion:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">state_boundary_US</span>, color <span class="op">=</span> <span class="st">"gray60"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">country_boundary_US</span>, size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, shape <span class="op">=</span> <span class="fl">19</span>, color <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of Contiguous US State Boundaries"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-layer-point-on-states-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge---plot-multiple-layers-of-spatial-data" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---plot-multiple-layers-of-spatial-data" class="callout-inner">
<h3 class="callout-title">Challenge - Plot Multiple Layers of Spatial Data</h3>
<div class="callout-content">
<p>Create a map of the North Eastern United States as follows:</p>
<ol style="list-style-type: decimal">
<li>Import and plot <code>Boundary-US-State-NEast.shp</code>. Adjust
line width as necessary.</li>
<li>Layer the Fisher Tower (in the NEON Harvard Forest site) point
location <code>point_HARV</code> onto the plot.</li>
<li>Add a title.</li>
<li>Add a legend that shows both the state boundary (as a line) and the
Tower location point.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NE.States.Boundary.US</span> <span class="op">&lt;-</span> <span class="fu">st_read</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/Boundary-US-State-NEast.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">st_zm</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Reading layer `Boundary-US-State-NEast' from data source
  `/home/runner/work/r-raster-vector-geospatial/r-raster-vector-geospatial/site/built/data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/Boundary-US-State-NEast.shp'
  using driver `ESRI Shapefile'
Simple feature collection with 12 features and 9 fields
Geometry type: MULTIPOLYGON
Dimension:     XYZ
Bounding box:  xmin: -80.51989 ymin: 37.91685 xmax: -66.9499 ymax: 47.45716
z_range:       zmin: 0 zmax: 0
Geodetic CRS:  WGS 84</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NE.States.Boundary.US</span>, <span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span><span class="st">"color"</span><span class="op">)</span>,</span>
<span>            show.legend <span class="op">=</span> <span class="st">"line"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, labels <span class="op">=</span> <span class="st">"State Boundary"</span>,</span>
<span>                       values <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"color"</span> <span class="op">=</span> <span class="st">"gray18"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">point_HARV</span>, <span class="fu">aes</span><span class="op">(</span>shape <span class="op">=</span> <span class="st">"shape"</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"purple"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_shape_manual</span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, labels <span class="op">=</span> <span class="st">"Fisher Tower"</span>,</span>
<span>                       values <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"shape"</span> <span class="op">=</span> <span class="fl">19</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Fisher Tower location"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.background <span class="op">=</span> <span class="fu">element_rect</span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/09-vector-when-data-dont-line-up-crs-rendered-ne-states-harv-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>
<code>ggplot2</code> automatically converts all objects in a plot to
the same CRS.</li>
<li>Still be aware of the CRS and extent for each object.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-10-vector-csv-to-shapefile-in-r"><p>Content from <a href="10-vector-csv-to-shapefile-in-r.html">Convert from .csv to a Vector Layer</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/10-vector-csv-to-shapefile-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I import CSV files as vector layers in R?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Import .csv files containing x,y coordinate locations into R as a
data frame.</li>
<li>Convert a data frame to a spatial object.</li>
<li>Export a spatial object to a text file.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode will review how to import spatial points stored in
<code>.csv</code> (Comma Separated Value) format into R as an
<code>sf</code> spatial object. We will also reproject data imported
from an ESRI <code>shapefile</code> format, export the reprojected data
as an ESRI <code>shapefile</code>, and plot raster and vector data as
layers in the same plot.</p>
<section><h2 class="section-heading" id="spatial-data-in-text-format">Spatial Data in Text Format<a class="anchor" aria-label="anchor" href="#spatial-data-in-text-format"></a>
</h2>
<hr class="half-width">
<p>The <code>HARV_PlotLocations.csv</code> file contains
<code>x, y</code> (point) locations for study plot where NEON collects
data on <a href="https://www.neonscience.org/data-collection/terrestrial-organismal-sampling" class="external-link">vegetation
and other ecological metics</a>. We would like to:</p>
<ul>
<li>Create a map of these plot locations.</li>
<li>Export the data in an ESRI <code>shapefile</code> format to share
with our colleagues. This <code>shapefile</code> can be imported into
most GIS software.</li>
<li>Create a map showing vegetation height with plot locations layered
on top.</li>
</ul>
<p>Spatial data are sometimes stored in a text file format
(<code>.txt</code> or <code>.csv</code>). If the text file has an
associated <code>x</code> and <code>y</code> location column, then we
can convert it into an <code>sf</code> spatial object. The
<code>sf</code> object allows us to store both the <code>x,y</code>
values that represent the coordinate location of each point and the
associated attribute data - or columns describing each feature in the
spatial object.</p>
<p>We will continue using the <code>sf</code> and <code>terra</code>
packages in this episode.</p>
</section><section><h2 class="section-heading" id="import--csv">Import .csv<a class="anchor" aria-label="anchor" href="#import--csv"></a>
</h2>
<hr class="half-width">
<p>To begin let’s import a <code>.csv</code> file that contains plot
coordinate <code>x, y</code> locations at the NEON Harvard Forest Field
Site (<code>HARV_PlotLocations.csv</code>) and look at the structure of
that new object:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_locations_HARV</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">read.csv</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/HARV/HARV_PlotLocations.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	21 obs. of  16 variables:
 $ easting   : num  731405 731934 731754 731724 732125 ...
 $ northing  : num  4713456 4713415 4713115 4713595 4713846 ...
 $ geodeticDa: chr  "WGS84" "WGS84" "WGS84" "WGS84" ...
 $ utmZone   : chr  "18N" "18N" "18N" "18N" ...
 $ plotID    : chr  "HARV_015" "HARV_033" "HARV_034" "HARV_035" ...
 $ stateProvi: chr  "MA" "MA" "MA" "MA" ...
 $ county    : chr  "Worcester" "Worcester" "Worcester" "Worcester" ...
 $ domainName: chr  "Northeast" "Northeast" "Northeast" "Northeast" ...
 $ domainID  : chr  "D01" "D01" "D01" "D01" ...
 $ siteID    : chr  "HARV" "HARV" "HARV" "HARV" ...
 $ plotType  : chr  "distributed" "tower" "tower" "tower" ...
 $ subtype   : chr  "basePlot" "basePlot" "basePlot" "basePlot" ...
 $ plotSize  : int  1600 1600 1600 1600 1600 1600 1600 1600 1600 1600 ...
 $ elevation : num  332 342 348 334 353 ...
 $ soilTypeOr: chr  "Inceptisols" "Inceptisols" "Inceptisols" "Histosols" ...
 $ plotdim_m : int  40 40 40 40 40 40 40 40 40 40 ...</code></pre>
</div>
<p>We now have a data frame that contains 21 locations (rows) and 16
variables (attributes). Note that all of our character data was imported
into R as character (text) data. Next, let’s explore the dataframe to
determine whether it contains columns with coordinate values. If we are
lucky, our <code>.csv</code> will contain columns labeled:</p>
<ul>
<li>“X” and “Y” OR</li>
<li>Latitude and Longitude OR</li>
<li>easting and northing (UTM coordinates)</li>
</ul>
<p>Let’s check out the column names of our dataframe.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "easting"    "northing"   "geodeticDa" "utmZone"    "plotID"
 [6] "stateProvi" "county"     "domainName" "domainID"   "siteID"
[11] "plotType"   "subtype"    "plotSize"   "elevation"  "soilTypeOr"
[16] "plotdim_m" </code></pre>
</div>
</section><section><h2 class="section-heading" id="identify-xy-location-columns">Identify X,Y Location Columns<a class="anchor" aria-label="anchor" href="#identify-xy-location-columns"></a>
</h2>
<hr class="half-width">
<p>Our column names include several fields that might contain spatial
information. The <code>plot_locations_HARV$easting</code> and
<code>plot_locations_HARV$northing</code> columns contain coordinate
values. We can confirm this by looking at the first six rows of our
data.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">$</span><span class="va">easting</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 731405.3 731934.3 731754.3 731724.3 732125.3 731634.3</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">$</span><span class="va">northing</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 4713456 4713415 4713115 4713595 4713846 4713295</code></pre>
</div>
<p>We have coordinate values in our data frame. In order to convert our
data frame to an <code>sf</code> object, we also need to know the CRS
associated with those coordinate values.</p>
<p>There are several ways to figure out the CRS of spatial data in text
format.</p>
<ol style="list-style-type: decimal">
<li>We can check the file metadata in hopes that the CRS was recorded in
the data.</li>
<li>We can explore the file itself to see if CRS information is embedded
in the file header or somewhere in the data columns.</li>
</ol>
<p>Following the <code>easting</code> and <code>northing</code> columns,
there is a <code>geodeticDa</code> and a <code>utmZone</code> column.
These appear to contain CRS information (<code>datum</code> and
<code>projection</code>). Let’s view those next.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">$</span><span class="va">geodeticDa</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "WGS84" "WGS84" "WGS84" "WGS84" "WGS84" "WGS84"</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">plot_locations_HARV</span><span class="op">$</span><span class="va">utmZone</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "18N" "18N" "18N" "18N" "18N" "18N"</code></pre>
</div>
<p>It is not typical to store CRS information in a column. But this
particular file contains CRS information this way. The
<code>geodeticDa</code> and <code>utmZone</code> columns contain the
information that helps us determine the CRS:</p>
<ul>
<li>
<code>geodeticDa</code>: WGS84 – this is geodetic datum WGS84</li>
<li>
<code>utmZone</code>: 18</li>
</ul>
<p>In <a href="09-vector-when-data-dont-line-up-crs.html">When Vector
Data Don’t Line Up - Handling Spatial Projection &amp; CRS in R</a> we
learned about the components of a <code>proj4</code> string. We have
everything we need to assign a CRS to our data frame.</p>
<p>To create the <code>proj4</code> associated with UTM Zone 18 WGS84 we
can look up the projection on the <a href="https://spatialreference.org/ref/epsg/32618/" class="external-link">Spatial Reference
website</a>, which contains a list of CRS formats for each projection.
From here, we can extract the <a href="https://spatialreference.org/ref/epsg/32618/proj4.txt" class="external-link">proj4
string for UTM Zone 18N WGS84</a>.</p>
<p>However, if we have other data in the UTM Zone 18N projection, it’s
much easier to use the <code>st_crs()</code> function to extract the CRS
in <code>proj4</code> format from that object and assign it to our new
spatial object. We’ve seen this CRS before with our Harvard Forest study
site (<code>point_HARV</code>).</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
<p>The output above shows that the points vector layer is in UTM zone
18N. We can thus use the CRS from that spatial object to convert our
non-spatial dataframe into an <code>sf</code> object.</p>
<p>Next, let’s create a <code>crs</code> object that we can use to
define the CRS of our <code>sf</code> object when we create it.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">utm18nCRS</span> <span class="op">&lt;-</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">point_HARV</span><span class="op">)</span></span>
<span><span class="va">utm18nCRS</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">utm18nCRS</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "crs"</code></pre>
</div>
</section><section><h2 class="section-heading" id="csv-to-sf-object">.csv to sf object<a class="anchor" aria-label="anchor" href="#csv-to-sf-object"></a>
</h2>
<hr class="half-width">
<p>Next, let’s convert our dataframe into an <code>sf</code> object. To
do this, we need to specify:</p>
<ol style="list-style-type: decimal">
<li>The columns containing X (<code>easting</code>) and Y
(<code>northing</code>) coordinate values</li>
<li>The CRS that the column coordinate represent (units are included in
the CRS) - stored in our <code>utmCRS</code> object.</li>
</ol>
<p>We will use the <code>st_as_sf()</code> function to perform the
conversion.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_locations_sp_HARV</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">plot_locations_HARV</span>,</span>
<span>                                   coords <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"easting"</span>, <span class="st">"northing"</span><span class="op">)</span>,</span>
<span>                                   crs <span class="op">=</span> <span class="va">utm18nCRS</span><span class="op">)</span></span></code></pre>
</div>
<p>We should double check the CRS to make sure it is correct.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">plot_locations_sp_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84 / UTM zone 18N
  wkt:
PROJCRS["WGS 84 / UTM zone 18N",
    BASEGEOGCRS["WGS 84",
        DATUM["World Geodetic System 1984",
            ELLIPSOID["WGS 84",6378137,298.257223563,
                LENGTHUNIT["metre",1]]],
        PRIMEM["Greenwich",0,
            ANGLEUNIT["degree",0.0174532925199433]],
        ID["EPSG",4326]],
    CONVERSION["UTM zone 18N",
        METHOD["Transverse Mercator",
            ID["EPSG",9807]],
        PARAMETER["Latitude of natural origin",0,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8801]],
        PARAMETER["Longitude of natural origin",-75,
            ANGLEUNIT["Degree",0.0174532925199433],
            ID["EPSG",8802]],
        PARAMETER["Scale factor at natural origin",0.9996,
            SCALEUNIT["unity",1],
            ID["EPSG",8805]],
        PARAMETER["False easting",500000,
            LENGTHUNIT["metre",1],
            ID["EPSG",8806]],
        PARAMETER["False northing",0,
            LENGTHUNIT["metre",1],
            ID["EPSG",8807]]],
    CS[Cartesian,2],
        AXIS["(E)",east,
            ORDER[1],
            LENGTHUNIT["metre",1]],
        AXIS["(N)",north,
            ORDER[2],
            LENGTHUNIT["metre",1]],
    ID["EPSG",32618]]</code></pre>
</div>
</section><section><h2 class="section-heading" id="plot-spatial-object">Plot Spatial Object<a class="anchor" aria-label="anchor" href="#plot-spatial-object"></a>
</h2>
<hr class="half-width">
<p>We now have a spatial R object, we can plot our newly created spatial
object.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations_sp_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of Plot Locations"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-plot-data-points-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="plot-extent">Plot Extent<a class="anchor" aria-label="anchor" href="#plot-extent"></a>
</h2>
<hr class="half-width">
<p>In <a href="06-vector-open-shapefile-in-r.html">Open and Plot Vector
Layers in R</a> we learned about spatial object extent. When we plot
several spatial layers in R using <code>ggplot</code>, all of the layers
of the plot are considered in setting the boundaries of the plot. To
show this, let’s plot our <code>aoi_boundary_HARV</code> object with our
vegetation plots.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations_sp_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"AOI Boundary Plot"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-plot-data-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>When we plot the two layers together, <code>ggplot</code> sets the
plot boundaries so that they are large enough to include all of the data
included in all of the layers. That’s really handy!</p>
<div id="challenge---import-plot-additional-points" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge---import-plot-additional-points" class="callout-inner">
<h3 class="callout-title">Challenge - Import &amp; Plot Additional Points</h3>
<div class="callout-content">
<p>We want to add two phenology plots to our existing map of vegetation
plot locations.</p>
<p>Import the .csv: <code>HARV/HARV_2NewPhenPlots.csv</code> into R and
do the following:</p>
<ol style="list-style-type: decimal">
<li>Find the X and Y coordinate locations. Which value is X and which
value is Y?</li>
<li>These data were collected in a geographic coordinate system (WGS84).
Convert the dataframe into an <code>sf</code> object.</li>
<li>Plot the new points with the plot location points from above. Be
sure to add a legend. Use a different symbol for the 2 new points!</li>
</ol>
<p>If you have extra time, feel free to add roads and other layers to
your map!</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ol style="list-style-type: decimal">
<li>First we will read in the new csv file and look at the data
structure.</li>
</ol>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newplot_locations_HARV</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">read.csv</span><span class="op">(</span><span class="st">"data/NEON-DS-Site-Layout-Files/HARV/HARV_2NewPhenPlots.csv"</span><span class="op">)</span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">newplot_locations_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	2 obs. of  13 variables:
 $ decimalLat: num  42.5 42.5
 $ decimalLon: num  -72.2 -72.2
 $ country   : chr  "unitedStates" "unitedStates"
 $ stateProvi: chr  "MA" "MA"
 $ county    : chr  "Worcester" "Worcester"
 $ domainName: chr  "Northeast" "Northeast"
 $ domainID  : chr  "D01" "D01"
 $ siteID    : chr  "HARV" "HARV"
 $ plotType  : chr  "tower" "tower"
 $ subtype   : chr  "phenology" "phenology"
 $ plotSize  : int  40000 40000
 $ plotDimens: chr  "200m x 200m" "200m x 200m"
 $ elevation : num  358 346</code></pre>
</div>
<ol start="2" style="list-style-type: decimal">
<li>The US boundary data we worked with previously is in a geographic
WGS84 CRS. We can use that data to establish a CRS for this data. First
we will extract the CRS from the <code>country_boundary_US</code> object
and confirm that it is WGS84.</li>
</ol>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">geogCRS</span> <span class="op">&lt;-</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">country_boundary_US</span><span class="op">)</span></span>
<span><span class="va">geogCRS</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<p>Then we will convert our new data to a spatial dataframe, using the
<code>geogCRS</code> object as our CRS.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newPlot.Sp.HARV</span> <span class="op">&lt;-</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="va">newplot_locations_HARV</span>,</span>
<span>                            coords <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"decimalLon"</span>, <span class="st">"decimalLat"</span><span class="op">)</span>,</span>
<span>                            crs <span class="op">=</span> <span class="va">geogCRS</span><span class="op">)</span></span></code></pre>
</div>
<p>Next we’ll confirm that the CRS for our new object is correct.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_crs</span><span class="op">(</span><span class="va">newPlot.Sp.HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Coordinate Reference System:
  User input: WGS 84
  wkt:
GEOGCRS["WGS 84",
    DATUM["World Geodetic System 1984",
        ELLIPSOID["WGS 84",6378137,298.257223563,
            LENGTHUNIT["metre",1]]],
    PRIMEM["Greenwich",0,
        ANGLEUNIT["degree",0.0174532925199433]],
    CS[ellipsoidal,2],
        AXIS["latitude",north,
            ORDER[1],
            ANGLEUNIT["degree",0.0174532925199433]],
        AXIS["longitude",east,
            ORDER[2],
            ANGLEUNIT["degree",0.0174532925199433]],
    ID["EPSG",4326]]</code></pre>
</div>
<p>We will be adding these new data points to the plot we created
before. The data for the earlier plot was in UTM. Since we’re using
<code>ggplot</code>, it will reproject the data for us.</p>
<ol start="3" style="list-style-type: decimal">
<li>Now we can create our plot.</li>
</ol>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations_sp_HARV</span>, color <span class="op">=</span> <span class="st">"orange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">newPlot.Sp.HARV</span>, color <span class="op">=</span> <span class="st">"lightblue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Map of All Plot Locations"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/10-vector-csv-to-shapefile-in-r-rendered-plot-locations-harv-orange-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="export-to-an-esri-shapefile">Export to an ESRI <code>shapefile</code>
<a class="anchor" aria-label="anchor" href="#export-to-an-esri-shapefile"></a>
</h2>
<hr class="half-width">
<p>We can write an R spatial object to an ESRI <code>shapefile</code>
using the <code>st_write</code> function in <code>sf</code>. To do this
we need the following arguments:</p>
<ul>
<li>the name of the spatial object
(<code>plot_locations_sp_HARV</code>)</li>
<li>the directory where we want to save our ESRI <code>shapefile</code>
(to use <code>current = getwd()</code> or you can specify a different
path)</li>
<li>the name of the new ESRI <code>shapefile</code>
(<code>PlotLocations_HARV</code>)</li>
<li>the driver which specifies the file format (ESRI Shapefile)</li>
</ul>
<p>We can now export the spatial object as an ESRI
<code>shapefile</code>.</p>
<div class="codewrapper sourceCode" id="cb32">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_write</span><span class="op">(</span><span class="va">plot_locations_sp_HARV</span>,</span>
<span>         <span class="st">"data/PlotLocations_HARV.shp"</span>, driver <span class="op">=</span> <span class="st">"ESRI Shapefile"</span><span class="op">)</span></span></code></pre>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Know the projection (if any) of your point data prior to converting
to a spatial object.</li>
<li>Convert a data frame to an <code>sf</code> object using the
<code>st_as_sf()</code> function.</li>
<li>Export an <code>sf</code> object as text using the
<code>st_write()</code> function.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-11-vector-raster-integration"><p>Content from <a href="11-vector-raster-integration.html">Manipulate Raster Data</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/11-vector-raster-integration.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I crop raster objects to vector objects, and extract the
summary of raster pixels?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Crop a raster to the extent of a vector layer.</li>
<li>Extract values from a raster that correspond to a vector file
overlay.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode explains how to crop a raster using the extent of a
vector layer. We will also cover how to extract values from a raster
that occur within a set of polygons, or in a buffer (surrounding) region
around a set of points.</p>
<section><h2 class="section-heading" id="crop-a-raster-to-vector-extent">Crop a Raster to Vector Extent<a class="anchor" aria-label="anchor" href="#crop-a-raster-to-vector-extent"></a>
</h2>
<hr class="half-width">
<p>We often work with spatial layers that have different spatial
extents. The spatial extent of a vector layer or R spatial object
represents the geographic “edge” or location that is the furthest north,
south east and west. Thus it represents the overall geographic coverage
of the spatial object.</p>
<p><img src="fig/dc-spatial-vector/spatial_extent.png" alt="Extent illustration" class="figure"> Image Source: National Ecological
Observatory Network (NEON)</p>
<p>The graphic below illustrates the extent of several of the spatial
layers that we have worked with in this workshop:</p>
<ul>
<li>Area of interest (AOI) – blue</li>
<li>Roads and trails – purple</li>
<li>Vegetation plot locations (marked with white dots)– black</li>
<li>A canopy height model (CHM) in GeoTIFF format – green</li>
</ul>
<figure><img src="fig/11-vector-raster-integration-rendered-compare-data-extents-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Frequent use cases of cropping a raster file include reducing file
size and creating maps. Sometimes we have a raster file that is much
larger than our study area or area of interest. It is often more
efficient to crop the raster to the extent of our study area to reduce
file sizes as we process our data. Cropping a raster can also be useful
when creating pretty maps so that the raster layer matches the extent of
the desired vector layers.</p>
</section><section><h2 class="section-heading" id="crop-a-raster-using-vector-extent">Crop a Raster Using Vector Extent<a class="anchor" aria-label="anchor" href="#crop-a-raster-using-vector-extent"></a>
</h2>
<hr class="half-width">
<p>We can use the <code>crop()</code> function to crop a raster to the
extent of another spatial object. To do this, we need to specify the
raster to be cropped and the spatial object that will be used to crop
the raster. R will use the <code>extent</code> of the spatial object as
the cropping boundary.</p>
<p>To illustrate this, we will crop the Canopy Height Model (CHM) to
only include the area of interest (AOI). Let’s start by plotting the
full extent of the CHM data and overlay where the AOI falls within it.
The boundaries of the AOI will be colored blue, and we use
<code>fill = NA</code> to make the area transparent.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-crop-by-vector-extent-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now that we have visualized the area of the CHM we want to subset, we
can perform the cropping operation. We are going to <code>crop()</code>
function from the raster package to create a new object with only the
portion of the CHM data that falls within the boundaries of the AOI.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_HARV_Cropped</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>, y <span class="op">=</span> <span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot the cropped CHM data, along with a boundary box
showing the full CHM extent. However, remember, since this is raster
data, we need to convert to a data frame in order to plot using
<code>ggplot</code>. To get the boundary box from CHM, the
<code>st_bbox()</code> will extract the 4 corners of the rectangle that
encompass all the features contained in this object. The
<code>st_as_sfc()</code> converts these 4 coordinates into a polygon
that we can plot:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_HARV_Cropped_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_HARV_Cropped</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="fu">st_as_sfc</span><span class="op">(</span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">CHM_HARV</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"green"</span>,</span>
<span>          color <span class="op">=</span> <span class="st">"green"</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_Cropped_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-show-cropped-area-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The plot above shows that the full CHM extent (plotted in green) is
much larger than the resulting cropped raster. Our new cropped CHM now
has the same extent as the <code>aoi_boundary_HARV</code> object that
was used as a crop extent (blue border below).</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_Cropped_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-view-crop-extent-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can look at the extent of all of our other objects for this field
site.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">CHM_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   xmin    ymin    xmax    ymax
 731453 4712471  733150 4713838 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">CHM_HARV_Cropped</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   xmin    ymin    xmax    ymax
 732128 4713209  732251 4713359 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">aoi_boundary_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 732128.0 4713208.7  732251.1 4713359.2 </code></pre>
</div>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">st_bbox</span><span class="op">(</span><span class="va">plot_locations_sp_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>     xmin      ymin      xmax      ymax
 731405.3 4712845.0  732275.3 4713846.3 </code></pre>
</div>
<p>Our plot location extent is not the largest but is larger than the
AOI Boundary. It would be nice to see our vegetation plot locations
plotted on top of the Canopy Height Model information.</p>
<div id="challenge-crop-to-vector-points-extent" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-crop-to-vector-points-extent" class="callout-inner">
<h3 class="callout-title">Challenge: Crop to Vector Points Extent</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Crop the Canopy Height Model to the extent of the study plot
locations.</li>
<li>Plot the vegetation plot location points on top of the Canopy Height
Model.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_plots_HARVcrop</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>, y <span class="op">=</span> <span class="va">plot_locations_sp_HARV</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CHM_plots_HARVcrop_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_plots_HARVcrop</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_plots_HARVcrop_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_locations_sp_HARV</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-challenge-code-crop-raster-points-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<p>In the plot above, created in the challenge, all the vegetation plot
locations (black dots) appear on the Canopy Height Model raster layer
except for one. One is situated on the blank space to the left of the
map. Why?</p>
<p>A modification of the first figure in this episode is below, showing
the relative extents of all the spatial objects. Notice that the extent
for our vegetation plot layer (black) extends further west than the
extent of our CHM raster (bright green). The <code>crop()</code>
function will make a raster extent smaller, it will not expand the
extent in areas where there are no data. Thus, the extent of our
vegetation plot layer will still extend further west than the extent of
our (cropped) raster data (dark green).</p>
<figure><img src="fig/11-vector-raster-integration-rendered-repeat-compare-data-extents-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="define-an-extent">Define an Extent<a class="anchor" aria-label="anchor" href="#define-an-extent"></a>
</h2>
<hr class="half-width">
<p>So far, we have used a vector layer to crop the extent of a raster
dataset. Alternatively, we can also the <code>ext()</code> function to
define an extent to be used as a cropping boundary. This creates a new
object of class extent. Here we will provide the <code>ext()</code>
function our xmin, xmax, ymin, and ymax (in that order).</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_extent</span> <span class="op">&lt;-</span> <span class="fu">ext</span><span class="op">(</span><span class="fl">732161.2</span>, <span class="fl">732238.7</span>, <span class="fl">4713249</span>, <span class="fl">4713333</span><span class="op">)</span></span>
<span><span class="fu">class</span><span class="op">(</span><span class="va">new_extent</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "SpatExtent"
attr(,"package")
[1] "terra"</code></pre>
</div>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>The extent can be created from a numeric vector (as shown above), a
matrix, or a list. For more details see the <code>ext()</code> function
help file (<code>?terra::ext</code>).</p>
</div>
</div>
</div>
<p>Once we have defined our new extent, we can use the
<code>crop()</code> function to crop our raster to this extent
object.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_HARV_manual_cropped</span> <span class="op">&lt;-</span> <span class="fu">crop</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>, y <span class="op">=</span> <span class="va">new_extent</span><span class="op">)</span></span></code></pre>
</div>
<p>To plot this data using <code>ggplot()</code> we need to convert it
to a dataframe.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CHM_HARV_manual_cropped_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">CHM_HARV_manual_cropped</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot this cropped data. We will show the AOI boundary on
the same plot for scale.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_sf</span><span class="op">(</span>data <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, color <span class="op">=</span> <span class="st">"blue"</span>, fill <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">CHM_HARV_manual_cropped_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Canopy Height"</span>, colors <span class="op">=</span> <span class="fu">terrain.colors</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">coord_sf</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-show-manual-crop-area-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="extract-raster-pixels-values-using-vector-polygons">Extract Raster Pixels Values Using Vector Polygons<a class="anchor" aria-label="anchor" href="#extract-raster-pixels-values-using-vector-polygons"></a>
</h2>
<hr class="half-width">
<p>Often we want to extract values from a raster layer for particular
locations - for example, plot locations that we are sampling on the
ground. We can extract all pixel values within 20m of our x,y point of
interest. These can then be summarized into some value of interest
(e.g. mean, maximum, total).</p>
<p><img src="fig//BufferSquare.png" alt="Image shows raster information extraction using 20m polygon boundary." class="figure">
Image Source: National Ecological Observatory Network (NEON)</p>
<p>To do this in R, we use the <code>extract()</code> function. The
<code>extract()</code> function requires:</p>
<ul>
<li>The raster that we wish to extract values from,</li>
<li>The vector layer containing the polygons that we wish to use as a
boundary or boundaries,</li>
<li>we can tell it to store the output values in a data frame using
<code>raw = FALSE</code> (this is optional).</li>
</ul>
<p>We will begin by extracting all canopy height pixel values located
within our <code>aoi_boundary_HARV</code> polygon which surrounds the
tower located at the NEON Harvard Forest field site.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_height</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>, y <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>, raw <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">tree_height</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	18450 obs. of  2 variables:
 $ ID          : num  1 1 1 1 1 1 1 1 1 1 ...
 $ HARV_chmCrop: num  21.2 23.9 23.8 22.4 23.9 ...</code></pre>
</div>
<p>When we use the <code>extract()</code> function, R extracts the value
for each pixel located within the boundary of the polygon being used to
perform the extraction - in this case the <code>aoi_boundary_HARV</code>
object (a single polygon). Here, the function extracted values from
18,450 pixels.</p>
<p>We can create a histogram of tree height values within the boundary
to better understand the structure or height distribution of trees at
our site. We will use the column <code>HARV_chmCrop</code> from our data
frame as our x values, as this column represents the tree heights for
each pixel.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span>data <span class="op">=</span> <span class="va">tree_height</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Histogram of CHM Height Values (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Tree Height"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Frequency of Pixels"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-view-extract-histogram-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We can also use the <code>summary()</code> function to view
descriptive statistics including min, max, and mean height values. These
values help us better understand vegetation at our field site.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">summary</span><span class="op">(</span><span class="va">tree_height</span><span class="op">$</span><span class="va">HARV_chmCrop</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.
   2.03   21.36   22.81   22.43   23.97   38.17 </code></pre>
</div>
</section><section><h2 class="section-heading" id="summarize-extracted-raster-values">Summarize Extracted Raster Values<a class="anchor" aria-label="anchor" href="#summarize-extracted-raster-values"></a>
</h2>
<hr class="half-width">
<p>We often want to extract summary values from a raster. We can tell R
the type of summary statistic we are interested in using the
<code>fun =</code> argument. Let’s extract a mean height value for our
AOI.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_tree_height_AOI</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>, y <span class="op">=</span> <span class="va">aoi_boundary_HARV</span>,</span>
<span>                                fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mean_tree_height_AOI</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  ID HARV_chmCrop
1  1     22.43018</code></pre>
</div>
<p>It appears that the mean height value, extracted from our LiDAR data
derived canopy height model is 22.43 meters.</p>
</section><section><h2 class="section-heading" id="extract-data-using-xy-locations">Extract Data using x,y Locations<a class="anchor" aria-label="anchor" href="#extract-data-using-xy-locations"></a>
</h2>
<hr class="half-width">
<p>We can also extract pixel values from a raster by defining a buffer
or area surrounding individual point locations using the
<code>st_buffer()</code> function. To do this we define the summary
argument (<code>fun = mean</code>) and the buffer distance
(<code>dist = 20</code>) which represents the radius of a circular
region around each point. By default, the units of the buffer are the
same units as the data’s CRS. All pixels that are touched by the buffer
region are included in the extract.</p>
<p><img src="fig/BufferCircular.png" alt="Image shows raster information extraction using 20m buffer region." class="figure">
Image Source: National Ecological Observatory Network (NEON)</p>
<p>Let’s put this into practice by figuring out the mean tree height in
the 20m around the tower location (<code>point_HARV</code>).</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_tree_height_tower</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>,</span>
<span>                                  y <span class="op">=</span> <span class="fu">st_buffer</span><span class="op">(</span><span class="va">point_HARV</span>, dist <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                                  fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mean_tree_height_tower</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  ID HARV_chmCrop
1  1     22.38806</code></pre>
</div>
<div id="challenge-extract-raster-height-values-for-plot-locations" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-extract-raster-height-values-for-plot-locations" class="callout-inner">
<h3 class="callout-title">Challenge: Extract Raster Height Values For Plot Locations</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li><p>Use the plot locations object
(<code>plot_locations_sp_HARV</code>) to extract an average tree height
for the area within 20m of each vegetation plot location in the study
area. Because there are multiple plot locations, there will be multiple
averages returned.</p></li>
<li><p>Create a plot showing the mean tree height of each area.</p></li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extract data at each plot location</span></span>
<span><span class="va">mean_tree_height_plots_HARV</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span>x <span class="op">=</span> <span class="va">CHM_HARV</span>,</span>
<span>                                       y <span class="op">=</span> <span class="fu">st_buffer</span><span class="op">(</span><span class="va">plot_locations_sp_HARV</span>,</span>
<span>                                                     dist <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,</span>
<span>                                       fun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># view data</span></span>
<span><span class="va">mean_tree_height_plots_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   ID HARV_chmCrop
1   1          NaN
2   2     23.96756
3   3     22.34937
4   4     16.49739
5   5     21.54419
6   6     19.16772
7   7     20.61651
8   8     21.61439
9   9     12.23006
10 10     19.13398
11 11     21.36966
12 12     19.32084
13 13     17.25975
14 14     20.47120
15 15     12.68301
16 16     15.51888
17 17     18.90894
18 18     18.19369
19 19     19.67441
20 20     20.23245
21 21     20.44984</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot data</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">mean_tree_height_plots_HARV</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">ID</span>, <span class="va">HARV_chmCrop</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_col</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Mean Tree Height at each Plot"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Plot ID"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Tree Height (m)"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">WARNING<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="warning" tabindex="0"><code>Warning: Removed 1 row containing missing values or values outside the scale range
(`geom_col()`).</code></pre>
</div>
<figure><img src="fig/11-vector-raster-integration-rendered-hist-tree-height-veg-plot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>crop()</code> function to crop a raster object.</li>
<li>Use the <code>extract()</code> function to extract pixels from a
raster object that fall within a particular extent boundary.</li>
<li>Use the <code>ext()</code> function to define an extent.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-12-time-series-raster"><p>Content from <a href="12-time-series-raster.html">Raster Time Series Data</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/12-time-series-raster.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I view and and plot data for different times of the
year?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Understand the format of a time series raster dataset.</li>
<li>Work with time series rasters.</li>
<li>Import a set of rasters stored in a single directory.</li>
<li>Create a multi-paneled plot.</li>
<li>Convert character data to date format.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode covers how to work with and plot a raster time series,
using an R raster object. It also covers practical assessment of data
quality in remote sensing derived imagery.</p>
<section><h2 class="section-heading" id="about-raster-time-series-data">About Raster Time Series Data<a class="anchor" aria-label="anchor" href="#about-raster-time-series-data"></a>
</h2>
<hr class="half-width">
<p>A raster data file can contain one single band or many bands. If the
raster data contains imagery data, each band may represent reflectance
for a different wavelength (color or type of light) or set of
wavelengths - for example red, green and blue. A multi-band raster may
two or more bands or layers of data collected at different times for the
same extent (region) and of the same resolution. For this episode, we
will work with a time series of normalized difference vegetation index
(NDVI) and RGB data from the Harvard Forest site. We introduced the
concepts of NDVI and RGB data in <a href="https://datacarpentry.org/organization-geospatial/01-intro-raster-data" class="external-link">an
earlier lesson</a> and worked with an RGB RasterStack in the <a href="05-raster-multi-band-in-r/">Work with Multi-band Rasters in R</a>
episode.</p>
<p>In this episode, we will:</p>
<ol style="list-style-type: decimal">
<li>Import NDVI data in GeoTIFF format.</li>
<li>Import, explore and plot NDVI data derived for several dates
throughout the year.</li>
<li>View the RGB imagery used to derived the NDVI time series to better
understand unusual / outlier values.</li>
</ol></section><section><h2 class="section-heading" id="rgb-data">RGB Data<a class="anchor" aria-label="anchor" href="#rgb-data"></a>
</h2>
<hr class="half-width">
<p>While the NDVI data is a single band product, the RGB images that
contain the red band used to derive NDVI, contain 3 (of the 7) 30m
resolution bands available from Landsat data. The RGB directory contains
RGB images for each time period that NDVI is available.</p>
<div class="section level3">
<h3 id="getting-started">Getting Started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h3>
<p>In this episode, we will use the <code>terra</code>,
<code>scales</code>, <code>tidyr</code>, and <code>ggplot2</code>
packages. Make sure you have them loaded.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">terra</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">scales</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyr</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">ggplot2</span><span class="op">)</span></span></code></pre>
</div>
<p>To begin, we will create a list of raster files using the
<code>list.files()</code> function. This list will be used to generate a
RasterStack. We will only add files that have a <code>.tif</code>
extension to our list. To do this, we will use the syntax
<code>pattern=".tif$"</code>. If we specify
<code>full.names = TRUE</code>, the full path for each file will be
added to the list.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>In the pattern above, the <code>$</code> character represents the end
of a line. Using it ensures that our pattern will only match files that
end in <code>.tif</code>. This pattern matching uses a language called
“regular expressions”, which is beyond the scope of this workshop.</p>
<ul>
<li><a href="https://regexone.com/" class="external-link">Regular expressions
tutorial</a></li>
<li><a href="https://github.com/rstudio/cheatsheets/blob/main/regex.pdf" class="external-link">Regular
expressions cheatsheet</a></li>
</ul>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_path</span> <span class="op">&lt;-</span> <span class="st">"data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI"</span></span>
<span></span>
<span><span class="va">all_NDVI_HARV</span> <span class="op">&lt;-</span> <span class="fu">list.files</span><span class="op">(</span><span class="va">NDVI_HARV_path</span>,</span>
<span>                            full.names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            pattern <span class="op">=</span> <span class="st">".tif$"</span><span class="op">)</span></span></code></pre>
</div>
<p>It’s a good idea to look at the file names that matched our search to
make sure they meet our expectations.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">all_NDVI_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/005_HARV_ndvi_crop.tif"
 [2] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/037_HARV_ndvi_crop.tif"
 [3] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/085_HARV_ndvi_crop.tif"
 [4] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/133_HARV_ndvi_crop.tif"
 [5] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/181_HARV_ndvi_crop.tif"
 [6] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/197_HARV_ndvi_crop.tif"
 [7] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/213_HARV_ndvi_crop.tif"
 [8] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/229_HARV_ndvi_crop.tif"
 [9] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/245_HARV_ndvi_crop.tif"
[10] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/261_HARV_ndvi_crop.tif"
[11] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/277_HARV_ndvi_crop.tif"
[12] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/293_HARV_ndvi_crop.tif"
[13] "data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI/309_HARV_ndvi_crop.tif"</code></pre>
</div>
<p>Now we have a list of all GeoTIFF files in the NDVI directory for
Harvard Forest. The number at the start of the filenames represents the
julilan day. Next, we will create a stack of rasters from this list
using the <code>rast()</code> function. We worked with the
<code>rast()</code> function in <a href="05-raster-multi-band-in-r/">an
earlier episode</a>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_stack</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">all_NDVI_HARV</span><span class="op">)</span></span></code></pre>
</div>
<p>We can explore the GeoTIFF tags (the embedded metadata) in a stack
using the same syntax that we used on single-band raster objects in R
including: <code>crs()</code> (coordinate reference system),
<code>ext()</code> and <code>res()</code> (resolution; specifically
<code>yres()</code> and <code>xres()</code>).</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">crs</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span>, proj <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "+proj=utm +zone=19 +ellps=WGS84 +units=m +no_defs"</code></pre>
</div>
<p>The CRS for our stack is
<code>+proj=utm +zone=19 +ellps=WGS84 +units=m +no_defs</code>. The CRS
is in UTM Zone 19. If you have completed the previous episodes in this
workshop, you may have noticed that the UTM zone for the NEON collected
remote sensing data was in Zone 18 rather than Zone 19. Why are the
Landsat data in Zone 19?</p>
<figure><img src="fig/dc-spatial-raster/UTM_zones_18-19.jpg" alt="Source: National Ecological Observatory Network (NEON)." class="figure mx-auto d-block"></figure><p>A Landsat scene is extremely wide - spanning over 170km north to
south and 180km east to west. This means that Landsat data often cover
multiple UTM zones. When the data are processed, the zone in which the
majority of the data cover is the zone which is used for the final CRS.
Thus, our field site at Harvard Forest is located in UTM Zone 18, but
the Landsat data is in a CRS of UTM Zone 19.</p>
<div id="challenge-raster-metadata" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-raster-metadata" class="callout-inner">
<h3 class="callout-title">Challenge: Raster Metadata</h3>
<div class="callout-content">
<p>Investigate the metadata for our RasterStack and answer the following
questions.</p>
<ol style="list-style-type: decimal">
<li>What are the x and y resolution of the data?</li>
<li>What units are the above resolution in?</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ext</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>SpatExtent : 239415, 239535, 4714215, 4714365 (xmin, xmax, ymin, ymax)</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">yres</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 30</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">xres</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] 30</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="plotting-time-series-data">Plotting Time Series Data<a class="anchor" aria-label="anchor" href="#plotting-time-series-data"></a>
</h2>
<hr class="half-width">
<p>Once we have created our RasterStack, we can visualize our data. We
can use the <code>ggplot()</code> command to create a multi-panelled
plot showing each band in our RasterStack. First we need to create a
data frame object. Because there are multiple columns in our data that
are not variables, we will tidy (or “pivot”) the data so that we have a
single column with the NDVI observations. We will use the function
<code>pivot_longer()</code> from the <code>tidyr</code> package to do
this:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_stack_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">:</span><span class="va">y</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot our data using <code>ggplot()</code>. We want to
create a separate panel for each time point in our time series, so we
will use the <code>facet_wrap()</code> function to create a
multi-paneled plot:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-ndvi-wrap-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Look at the range of NDVI values observed in the plot above. We know
that the accepted values for NDVI range from 0-1. Why does our data
range from 0 - 10,000?</p>
</section><section><h2 class="section-heading" id="scale-factors">Scale Factors<a class="anchor" aria-label="anchor" href="#scale-factors"></a>
</h2>
<hr class="half-width">
<p>The metadata for this NDVI data specifies a scale factor: 10,000. A
scale factor is sometimes used to maintain smaller file sizes by
removing decimal places. Storing data in integer format keeps files
sizes smaller.</p>
<p>Let’s apply the scale factor before we go any further. Conveniently,
we can quickly apply this factor using raster math on the entire stack
as follows:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_stack</span> <span class="op">&lt;-</span> <span class="va">NDVI_HARV_stack</span><span class="op">/</span><span class="fl">10000</span></span></code></pre>
</div>
<p>After applying our scale factor, we can recreate our plot using the
same code we used above.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_stack_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">pivot_longer</span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">x</span><span class="op">:</span><span class="va">y</span><span class="op">)</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-ndvi-stack-wrap-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="take-a-closer-look-at-our-data">Take a Closer Look at Our Data<a class="anchor" aria-label="anchor" href="#take-a-closer-look-at-our-data"></a>
</h2>
<hr class="half-width">
<p>Let’s take a closer look at the plots of our data. Massachusetts,
where the NEON Harvard Forest Field Site is located, has a fairly
consistent fall, winter, spring, and summer season where vegetation
turns green in the spring, continues to grow throughout the summer, and
begins to change colors and senesce in the fall through winter. Do you
notice anything that seems unusual about the patterns of greening and
browning observed in the plots above?</p>
<p>Hint: the number after the “X” in each tile title is the Julian day
which in this case represents the number of days into each year. If you
are unfamiliar with Julian day, check out the NEON Data Skills <a href="https://www.neonscience.org/julian-day-conversion-r" class="external-link">Converting to
Julian Day</a> tutorial.</p>
</section><section><h2 class="section-heading" id="view-distribution-of-raster-values">View Distribution of Raster Values<a class="anchor" aria-label="anchor" href="#view-distribution-of-raster-values"></a>
</h2>
<hr class="half-width">
<p>In the above exercise, we viewed plots of our NDVI time series and
noticed a few images seem to be unusually light. However this was only a
visual representation of potential issues in our data. What is another
way we can look at these data that is quantitative?</p>
<p>Next we will use histograms to explore the distribution of NDVI
values stored in each raster.</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">NDVI_HARV_stack_df</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_histogram</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-view-stack-histogram-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>It seems like things get green in the spring and summer like we
expect, but the data at Julian days 277 and 293 are unusual. It appears
as if the vegetation got green in the spring, but then died back only to
get green again towards the end of the year. Is this right?</p>
<div class="section level3">
<h3 id="explore-unusual-data-patterns">Explore Unusual Data Patterns<a class="anchor" aria-label="anchor" href="#explore-unusual-data-patterns"></a>
</h3>
<p>The NDVI data that we are using comes from 2011, perhaps a strong
freeze around Julian day 277 could cause a vegetation to senesce early,
however in the eastern United States, it seems unusual that it would
proceed to green up again shortly thereafter.</p>
<p>Let’s next view some temperature data for our field site to see
whether there were some unusual fluctuations that may explain this
pattern of greening and browning seen in the NDVI data. First we will
read in the temperature data and preview the structure of that
dataframe:</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">har_met_daily</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">read.csv</span><span class="op">(</span><span class="st">"data/NEON-DS-Met-Time-Series/HARV/FisherTower-Met/hf001-06-daily-m.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">str</span><span class="op">(</span><span class="va">har_met_daily</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>'data.frame':	5345 obs. of  46 variables:
 $ date     : chr  "2001-02-11" "2001-02-12" "2001-02-13" "2001-02-14" ...
 $ jd       : int  42 43 44 45 46 47 48 49 50 51 ...
 $ airt     : num  -10.7 -9.8 -2 -0.5 -0.4 -3 -4.5 -9.9 -4.5 3.2 ...
 $ f.airt   : chr  "" "" "" "" ...
 $ airtmax  : num  -6.9 -2.4 5.7 1.9 2.4 1.3 -0.7 -3.3 0.7 8.9 ...
 $ f.airtmax: chr  "" "" "" "" ...
 $ airtmin  : num  -15.1 -17.4 -7.3 -5.7 -5.7 -9 -12.7 -17.1 -11.7 -1.3 ...
 $ f.airtmin: chr  "" "" "" "" ...
 $ rh       : int  40 45 70 78 69 82 66 51 57 62 ...
 $ f.rh     : chr  "" "" "" "" ...
 $ rhmax    : int  58 85 100 100 100 100 100 71 81 78 ...
 $ f.rhmax  : chr  "" "" "" "" ...
 $ rhmin    : int  22 14 34 59 37 46 30 34 37 42 ...
 $ f.rhmin  : chr  "" "" "" "" ...
 $ dewp     : num  -22.2 -20.7 -7.6 -4.1 -6 -5.9 -10.8 -18.5 -12 -3.5 ...
 $ f.dewp   : chr  "" "" "" "" ...
 $ dewpmax  : num  -16.8 -9.2 -4.6 1.9 2 -0.4 -0.7 -14.4 -4 0.6 ...
 $ f.dewpmax: chr  "" "" "" "" ...
 $ dewpmin  : num  -25.7 -27.9 -10.2 -10.2 -12.1 -10.6 -25.4 -25 -16.5 -5.7 ...
 $ f.dewpmin: chr  "" "" "" "" ...
 $ prec     : num  0 0 0 6.9 0 2.3 0 0 0 0 ...
 $ f.prec   : chr  "" "" "" "" ...
 $ slrt     : num  14.9 14.8 14.8 2.6 10.5 6.4 10.3 15.5 15 7.7 ...
 $ f.slrt   : chr  "" "" "" "" ...
 $ part     : num  NA NA NA NA NA NA NA NA NA NA ...
 $ f.part   : chr  "M" "M" "M" "M" ...
 $ netr     : num  NA NA NA NA NA NA NA NA NA NA ...
 $ f.netr   : chr  "M" "M" "M" "M" ...
 $ bar      : int  1025 1033 1024 1016 1010 1016 1008 1022 1022 1017 ...
 $ f.bar    : chr  "" "" "" "" ...
 $ wspd     : num  3.3 1.7 1.7 2.5 1.6 1.1 3.3 2 2.5 2 ...
 $ f.wspd   : chr  "" "" "" "" ...
 $ wres     : num  2.9 0.9 0.9 1.9 1.2 0.5 3 1.9 2.1 1.8 ...
 $ f.wres   : chr  "" "" "" "" ...
 $ wdir     : int  287 245 278 197 300 182 281 272 217 218 ...
 $ f.wdir   : chr  "" "" "" "" ...
 $ wdev     : int  27 55 53 38 40 56 24 24 31 27 ...
 $ f.wdev   : chr  "" "" "" "" ...
 $ gspd     : num  15.4 7.2 9.6 11.2 12.7 5.8 16.9 10.3 11.1 10.9 ...
 $ f.gspd   : chr  "" "" "" "" ...
 $ s10t     : num  NA NA NA NA NA NA NA NA NA NA ...
 $ f.s10t   : chr  "M" "M" "M" "M" ...
 $ s10tmax  : num  NA NA NA NA NA NA NA NA NA NA ...
 $ f.s10tmax: chr  "M" "M" "M" "M" ...
 $ s10tmin  : num  NA NA NA NA NA NA NA NA NA NA ...
 $ f.s10tmin: chr  "M" "M" "M" "M" ...</code></pre>
</div>
<p>The <code>date</code> column is currently coded as a character. We
want to be able to treat it as a date, so we will use the
<code>as.Date()</code> function to convert it. We need to tell R what
format the data is in. Our dates are YYY-MM-DD, which is represented by
R as <code>%Y-%m-%d</code>.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">har_met_daily</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu">as.Date</span><span class="op">(</span><span class="va">har_met_daily</span><span class="op">$</span><span class="va">date</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span></code></pre>
</div>
<p>We only want to look at the data from 2011:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yr_11_daily_avg</span> <span class="op">&lt;-</span> <span class="va">har_met_daily</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="fu">between</span><span class="op">(</span><span class="va">date</span>, <span class="fu">as.Date</span><span class="op">(</span><span class="st">'2011-01-01'</span><span class="op">)</span>, <span class="fu">as.Date</span><span class="op">(</span><span class="st">'2011-12-31'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot the air temperature (the <code>airt</code> column) by
Julian day (the <code>jd</code> column):</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>data <span class="op">=</span> <span class="va">yr_11_daily_avg</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">jd</span>, <span class="va">airt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Daily Mean Air Temperature"</span>,</span>
<span>          subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Julian Day 2011"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean Air Temperature (C)"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-air-temperature-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>There are no significant peaks or dips in the temperature during the
late summer or early fall time period that might account for patterns
seen in the NDVI data. Let’s have a look at the source Landsat imagery
that was partially used used to derive our NDVI rasters to try to
understand what appear to be outlier NDVI values.</p>
<p><img src="fig/12-time-series-raster-rendered-ndvi-plots-1.png" style="display: block; margin: auto;" class="figure"><img src="fig/12-time-series-raster-rendered-ndvi-plots-2.png" style="display: block; margin: auto;" class="figure"></p>
<div id="challenge-examine-rgb-raster-files" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-examine-rgb-raster-files" class="callout-inner">
<h3 class="callout-title">Challenge: Examine RGB Raster Files</h3>
<div class="callout-content">
<p>Plot the RGB images for the Julian days 277 and 293. Compare those
with the RGB plots for Julian days 133 and 197 (shown above). Does the
RGB imagery from these two days explain the low NDVI values observed on
these days?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<p>First we need to load in the RGB data for Julian day 277 and look at
its metadata.</p>
<div class="codewrapper sourceCode" id="cb25">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_277</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Landsat-NDVI/HARV/2011/RGB/277_HARV_landRGB.tif"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># NOTE: Fix the bands' names so they don't start with a number!</span></span>
<span><span class="fu">names</span><span class="op">(</span><span class="va">RGB_277</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"X"</span>, <span class="fu">names</span><span class="op">(</span><span class="va">RGB_277</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">RGB_277</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>class       : SpatRaster
size        : 652, 696, 3  (nrow, ncol, nlyr)
resolution  : 30, 30  (x, y)
extent      : 230775, 251655, 4704825, 4724385  (xmin, xmax, ymin, ymax)
coord. ref. : WGS 84 / UTM zone 19N (EPSG:32619)
source      : 277_HARV_landRGB.tif
names       : X277_HARV_landRGB_1, X277_HARV_landRGB_2, X277_HARV_landRGB_3
min values  :                  26,                  29,                  79
max values  :                 255,                 255,                 255 </code></pre>
</div>
<p>The RGB data has a max value of 255, but we need our color intensity
to be between 0 and 1, so we will divide our RasterStack object by
255.</p>
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_277</span> <span class="op">&lt;-</span> <span class="va">RGB_277</span><span class="op">/</span><span class="fl">255</span></span></code></pre>
</div>
<p>Next we convert it to a dataframe.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_277_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">RGB_277</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre>
</div>
<p>We create RGB colors from the three channels:</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RGB_277_df</span><span class="op">$</span><span class="va">rgb</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">with</span><span class="op">(</span><span class="va">RGB_277_df</span>, <span class="fu">rgb</span><span class="op">(</span><span class="va">X277_HARV_landRGB_1</span>, <span class="va">X277_HARV_landRGB_2</span>, </span>
<span>                       <span class="va">X277_HARV_landRGB_3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Finally, we can plot the RGB data for Julian day 277.</p>
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data<span class="op">=</span><span class="va">RGB_277_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, fill<span class="op">=</span><span class="va">RGB_277_df</span><span class="op">$</span><span class="va">rgb</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Julian day 277"</span><span class="op">)</span> </span></code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-rgb-277-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>We then do the same steps for Julian day 293</p>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Julian day 293</span></span>
<span><span class="va">RGB_293</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="st">"data/NEON-DS-Landsat-NDVI/HARV/2011/RGB/293_HARV_landRGB.tif"</span><span class="op">)</span></span>
<span><span class="fu">names</span><span class="op">(</span><span class="va">RGB_293</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"X"</span>, <span class="fu">names</span><span class="op">(</span><span class="va">RGB_293</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">RGB_293</span> <span class="op">&lt;-</span> <span class="va">RGB_293</span><span class="op">/</span><span class="fl">255</span></span>
<span><span class="va">RGB_293_df</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="va">RGB_293</span>, xy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">RGB_293_df</span><span class="op">$</span><span class="va">rgb</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu">with</span><span class="op">(</span><span class="va">RGB_293_df</span>, <span class="fu">rgb</span><span class="op">(</span><span class="va">X293_HARV_landRGB_1</span>, <span class="va">X293_HARV_landRGB_2</span>, </span>
<span>                       <span class="va">X293_HARV_landRGB_3</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">RGB_293_df</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">RGB_293_df</span><span class="op">$</span><span class="va">rgb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Julian day 293"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/12-time-series-raster-rendered-rgb-293-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>This example highlights the importance of exploring the source of a
derived data product. In this case, the NDVI data product was created
using Landsat imagery - specifically the red and near-infrared bands.
When we look at the RGB collected at Julian days 277 and 293 we see that
most of the image is filled with clouds. The very low NDVI values
resulted from cloud cover — a common challenge that we encounter when
working with satellite remote sensing imagery.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>list.files()</code> function to get a list of
filenames matching a specific pattern.</li>
<li>Use the <code>facet_wrap()</code> function to create multi-paneled
plots with <code>ggplot2</code>.</li>
<li>Use the <code>as.Date()</code> function to convert data to date
format.</li>
</ul>
</div>
</div>
</div>
</div>
</section></section><section id="aio-13-plot-time-series-rasters-in-r"><p>Content from <a href="13-plot-time-series-rasters-in-r.html">Create Publication-quality Graphics</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/13-plot-time-series-rasters-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I create a publication-quality graphic and customize plot
parameters?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Assign custom names to bands in a RasterStack.</li>
<li>Customize raster plots using the <code>ggplot2</code> package.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>This episode covers how to customize your raster plots using the
<code>ggplot2</code> package in R to create publication-quality
plots.</p>
<section><h2 class="section-heading" id="before-and-after">Before and After<a class="anchor" aria-label="anchor" href="#before-and-after"></a>
</h2>
<hr class="half-width">
<p>In <a href="12-time-series-raster/">the previous episode</a>, we
learned how to plot multi-band raster data in R using the
<code>facet_wrap()</code> function. This created a separate panel in our
plot for each raster band. The plot we created together is shown
below:</p>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-levelplot-time-series-before-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Although this plot is informative, it isn’t something we would expect
to see in a journal publication. The x and y-axis labels aren’t
informative. There is a lot of unnecessary gray background and the
titles of each panel don’t clearly state that the number refers to the
Julian day the data was collected. In this episode, we will customize
this plot above to produce a publication quality graphic. We will go
through these steps iteratively. When we’re done, we will have created
the plot shown below.</p>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-levelplot-time-series-after-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="adjust-the-plot-theme">Adjust the Plot Theme<a class="anchor" aria-label="anchor" href="#adjust-the-plot-theme"></a>
</h2>
<hr class="half-width">
<p>The first thing we will do to our plot remove the x and y-axis labels
and axis ticks, as these are unnecessary and make our plot look messy.
We can do this by setting the plot theme to <code>void</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-adjust-theme-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Next we will center our plot title and subtitle. We need to do this
<strong>after</strong> the <code>theme_void()</code> layer, because R
interprets the <code>ggplot</code> layers in order. If we first tell R
to center our plot title, and then set the theme to <code>void</code>,
any adjustments we’ve made to the plot theme will be over-written by the
<code>theme_void()</code> function. So first we make the theme
<code>void</code> and then we center the title. We center both the title
and subtitle by using the <code>theme()</code> function and setting the
<code>hjust</code> parameter to 0.5. The <code>hjust</code> parameter
stands for “horizontal justification” and takes any value between 0 and
1. A setting of 0 indicates left justification and a setting of 1
indicates right justification.</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-adjust-theme-2-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge" class="callout-inner">
<h3 class="callout-title">Challenge</h3>
<div class="callout-content">
<p>Change the plot title (but not the subtitle) to bold font. You can
(and should!) use the help menu in RStudio or any internet resources to
figure out how to change this setting.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Learners can find this information in the help files for the
<code>theme()</code> function. The parameter to set is called
<code>face</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span>,</span>
<span>              <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>        plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-use-bold-face-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="adjust-the-color-ramp">Adjust the Color Ramp<a class="anchor" aria-label="anchor" href="#adjust-the-color-ramp"></a>
</h2>
<hr class="half-width">
<p>Next, let’s adjust the color ramp used to render the rasters. First,
we can change the blue color ramp to a green one that is more visually
suited to our NDVI (greenness) data using the
<code>colorRampPalette()</code> function in combination with
<code>colorBrewer</code> which requires loading the
<code>RColorBrewer</code> library. Then we use
<code>scale_fill_gradientn</code> to pass the list of colours (here 20
different colours) to ggplot.</p>
<p>First we need to create a set of colors to use. We will select a set
of nine colors from the “YlGn” (yellow-green) color palette. This
returns a set of hex color codes:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span></span>
<span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">9</span>, <span class="st">"YlGn"</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "#FFFFE5" "#F7FCB9" "#D9F0A3" "#ADDD8E" "#78C679" "#41AB5D" "#238443"
[8] "#006837" "#004529"</code></pre>
</div>
<p>Then we will pass those color codes to the
<code>colorRampPalette</code> function, which will interpolate from
those colors a more nuanced color range.</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">green_colors</span> <span class="op">&lt;-</span> <span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">9</span>, <span class="st">"YlGn"</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">colorRampPalette</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<p>We can tell the <code>colorRampPalette()</code> function how many
discrete colors within this color range to create. In our case, we will
use 20 colors when we plot our graphic.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NDVI"</span>, colours <span class="op">=</span> <span class="fu">green_colors</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-change-color-ramp-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>The yellow to green color ramp visually represents NDVI well given
it’s a measure of greenness. Someone looking at the plot can quickly
understand that pixels that are more green have a higher NDVI value.</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>For all of the <code>brewer.pal</code> ramp names see the <a href="https://www.datavis.ca/sasmac/brewerpal.html" class="external-link">brewerpal
page</a>.</p>
</div>
</div>
</div>
<div id="data-tip-1" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip-1" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>Cynthia Brewer, the creator of ColorBrewer, offers an online tool to
help choose suitable color ramps, or to create your own. <a href="https://colorbrewer2.org/" class="external-link">ColorBrewer 2.0; Color Advise for
Cartography</a></p>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="refine-plot-tile-labels">Refine Plot &amp; Tile Labels<a class="anchor" aria-label="anchor" href="#refine-plot-tile-labels"></a>
</h2>
<hr class="half-width">
<p>Next, let’s label each panel in our plot with the Julian day that the
raster data for that panel was collected. The current names come from
the band “layer names”” stored in the <code>RasterStack</code> and the
first part of each name is the Julian day.</p>
<p>To create a more meaningful label we can remove the “x” and replace
it with “day” using the <code>gsub()</code> function in R. The syntax is
as follows:
<code>gsub("StringToReplace", "TextToReplaceIt", object)</code>.</p>
<p>First let’s remove “_HARV_NDVI_crop” from each label to make the
labels shorter and remove repetition. To illustrate how this works, we
will first look at the names for our <code>NDVI_HARV_stack</code>
object:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "X005_HARV_ndvi_crop" "X037_HARV_ndvi_crop" "X085_HARV_ndvi_crop"
 [4] "X133_HARV_ndvi_crop" "X181_HARV_ndvi_crop" "X197_HARV_ndvi_crop"
 [7] "X213_HARV_ndvi_crop" "X229_HARV_ndvi_crop" "X245_HARV_ndvi_crop"
[10] "X261_HARV_ndvi_crop" "X277_HARV_ndvi_crop" "X293_HARV_ndvi_crop"
[13] "X309_HARV_ndvi_crop"</code></pre>
</div>
<p>Now we will use the <code>gsub()</code> function to find the
character string “_HARV_ndvi_crop” and replace it with a blank string
(““). We will assign this output to a new object
(<code>raster_names</code>) and look at that object to make sure our
code is doing what we want it to.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster_names</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span><span class="op">)</span></span>
<span></span>
<span><span class="va">raster_names</span> <span class="op">&lt;-</span> <span class="fu">gsub</span><span class="op">(</span><span class="st">"_HARV_ndvi_crop"</span>, <span class="st">""</span>, <span class="va">raster_names</span><span class="op">)</span></span>
<span><span class="va">raster_names</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "X005" "X037" "X085" "X133" "X181" "X197" "X213" "X229" "X245" "X261"
[11] "X277" "X293" "X309"</code></pre>
</div>
<p>So far so good. Now we will use <code>gsub()</code> again to replace
the “X” with the word “Day” followed by a space.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster_names</span>  <span class="op">&lt;-</span> <span class="fu">gsub</span><span class="op">(</span><span class="st">"X"</span>, <span class="st">"Day "</span>, <span class="va">raster_names</span><span class="op">)</span></span>
<span><span class="va">raster_names</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "Day 005" "Day 037" "Day 085" "Day 133" "Day 181" "Day 197" "Day 213"
 [8] "Day 229" "Day 245" "Day 261" "Day 277" "Day 293" "Day 309"</code></pre>
</div>
<p>Our labels look good now. Let’s reassign them to our
<code>all_NDVI_HARV</code> object:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">labels_names</span> <span class="op">&lt;-</span> <span class="fu">setNames</span><span class="op">(</span><span class="va">raster_names</span>, <span class="fu">unique</span><span class="op">(</span><span class="va">NDVI_HARV_stack_df</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Once the names for each band have been reassigned, we can render our
plot with the new labels using a<code>labeller</code>.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>, labeller <span class="op">=</span> <span class="fu">labeller</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">labels_names</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NDVI"</span>, colours <span class="op">=</span> <span class="fu">green_colors</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-create-levelplot-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure></section><section><h2 class="section-heading" id="change-layout-of-panels">Change Layout of Panels<a class="anchor" aria-label="anchor" href="#change-layout-of-panels"></a>
</h2>
<hr class="half-width">
<p>We can adjust the columns of our plot by setting the number of
columns <code>ncol</code> and the number of rows <code>nrow</code> in
<code>facet_wrap</code>. Let’s make our plot so that it has a width of
five panels.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>, ncol <span class="op">=</span> <span class="fl">5</span>, </span>
<span>             labeller <span class="op">=</span> <span class="fu">labeller</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">labels_names</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI"</span>, subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>    plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NDVI"</span>, colours <span class="op">=</span> <span class="fu">green_colors</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-adjust-layout-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now we have a beautiful, publication quality plot!</p>
<div id="challenge-divergent-color-ramps" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-divergent-color-ramps" class="callout-inner">
<h3 class="callout-title">Challenge: Divergent Color Ramps</h3>
<div class="callout-content">
<p>When we used the <code>gsub()</code> function to modify the tile
labels we replaced the beginning of each tile title with “Day”. A more
descriptive name could be “Julian Day”. Update the plot above with the
following changes:</p>
<ol style="list-style-type: decimal">
<li>Label each tile “Julian Day” with the julian day value
following.</li>
<li>Change the color ramp to a divergent brown to green color ramp.</li>
</ol>
<p><strong>Questions:</strong> Does having a divergent color ramp
represent the data better than a sequential color ramp (like “YlGn”)?
Can you think of other data sets where a divergent color ramp may be
best?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" aria-labelledby="headingSolution2" data-bs-parent="#accordionSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">raster_names</span>  <span class="op">&lt;-</span> <span class="fu">gsub</span><span class="op">(</span><span class="st">"Day"</span>,<span class="st">"Julian Day "</span>, <span class="va">raster_names</span><span class="op">)</span></span>
<span><span class="va">labels_names</span> <span class="op">&lt;-</span> <span class="fu">setNames</span><span class="op">(</span><span class="va">raster_names</span>, <span class="fu">unique</span><span class="op">(</span><span class="va">NDVI_HARV_stack_df</span><span class="op">$</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">brown_green_colors</span> <span class="op">&lt;-</span> <span class="fu">colorRampPalette</span><span class="op">(</span><span class="fu">brewer.pal</span><span class="op">(</span><span class="fl">9</span>, <span class="st">"BrBG"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_raster</span><span class="op">(</span>data <span class="op">=</span> <span class="va">NDVI_HARV_stack_df</span> , <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>, ncol <span class="op">=</span> <span class="fl">5</span>, labeller <span class="op">=</span> <span class="fu">labeller</span><span class="op">(</span>variable <span class="op">=</span> <span class="va">labels_names</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat NDVI - Julian Days"</span>, subtitle <span class="op">=</span> <span class="st">"Harvard Forest 2011"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_void</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme</span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, </span>
<span>  plot.subtitle <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">scale_fill_gradientn</span><span class="op">(</span>name <span class="op">=</span> <span class="st">"NDVI"</span>, colours <span class="op">=</span> <span class="fu">brown_green_colors</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/13-plot-time-series-rasters-in-r-rendered-final-figure-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>For NDVI data, the sequential color ramp is better than the divergent
as it is more akin to the process of greening up, which starts off at
one end and just keeps increasing.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>theme_void()</code> function for a clean background to
your plot.</li>
<li>Use the <code>element_text()</code> function to adjust text size,
font, and position.</li>
<li>Use the <code>brewer.pal()</code> function to create a custom color
palette.</li>
<li>Use the <code>gsub()</code> function to do pattern matching and
replacement in text.</li>
</ul>
</div>
</div>
</div>
</section></section><section id="aio-14-extract-ndvi-from-rasters-in-r"><p>Content from <a href="14-extract-ndvi-from-rasters-in-r.html">Derive Values from Raster Time Series</a></p>
<hr>
<p>Last updated on 2025-06-03 |

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/episodes/14-extract-ndvi-from-rasters-in-r.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right" data-expand="Expand All Solutions " data-collapse="Collapse All Solutions "> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can I calculate, extract, and export summarized raster pixel
data?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Extract summary pixel values from a raster.</li>
<li>Save summary values to a .csv file.</li>
<li>Plot summary pixel values using <code>ggplot()</code>.</li>
<li>Compare NDVI values between two different sites.</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="things-youll-need-to-complete-this-episode" class="callout-inner">
<h3 class="callout-title">Things You’ll Need To Complete This Episode</h3>
<div class="callout-content">
<p>See the <a href=".">lesson homepage</a> for detailed information
about the software, data, and other prerequisites you will need to work
through the examples in this episode.</p>
</div>
</div>
</div>
<p>In this episode, we will extract NDVI values from a raster time
series dataset and plot them using the <code>ggplot2</code> package.</p>
<section><h2 class="section-heading" id="extract-summary-statistics-from-raster-data">Extract Summary Statistics From Raster Data<a class="anchor" aria-label="anchor" href="#extract-summary-statistics-from-raster-data"></a>
</h2>
<hr class="half-width">
<p>We often want to extract summary values from raster data. For
example, we might want to understand overall greeness across a field
site or at each plot within a field site. These values can then be
compared between different field sites and combined with other related
metrics to support modeling and further analysis.</p>
</section><section><h2 class="section-heading" id="calculate-average-ndvi">Calculate Average NDVI<a class="anchor" aria-label="anchor" href="#calculate-average-ndvi"></a>
</h2>
<hr class="half-width">
<p>Our goal in this episode is to create a dataframe that contains a
single, mean NDVI value for each raster in our time series. This value
represents the mean NDVI value for this area on a given day.</p>
<p>We can calculate the mean for each raster using the
<code>global()</code> function. The <code>global()</code> function
produces a named numeric vector, where each value is associated with the
name of raster stack it was derived from.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span> <span class="op">&lt;-</span> <span class="fu">global</span><span class="op">(</span><span class="va">NDVI_HARV_stack</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">avg_NDVI_HARV</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                        mean
X005_HARV_ndvi_crop 0.365150
X037_HARV_ndvi_crop 0.242645
X085_HARV_ndvi_crop 0.251390
X133_HARV_ndvi_crop 0.599300
X181_HARV_ndvi_crop 0.878725
X197_HARV_ndvi_crop 0.893250
X213_HARV_ndvi_crop 0.878395
X229_HARV_ndvi_crop 0.881505
X245_HARV_ndvi_crop 0.850120
X261_HARV_ndvi_crop 0.796360
X277_HARV_ndvi_crop 0.033050
X293_HARV_ndvi_crop 0.056895
X309_HARV_ndvi_crop 0.541130</code></pre>
</div>
<p>The output is a data frame (othewise, we could use
<code>as.data.frame()</code>). It’s a good idea to view the first few
rows of our data frame with <code>head()</code> to make sure the
structure is what we expect.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                        mean
X005_HARV_ndvi_crop 0.365150
X037_HARV_ndvi_crop 0.242645
X085_HARV_ndvi_crop 0.251390
X133_HARV_ndvi_crop 0.599300
X181_HARV_ndvi_crop 0.878725
X197_HARV_ndvi_crop 0.893250</code></pre>
</div>
<p>We now have a data frame with row names that are based on the
original file name and a mean NDVI value for each file. Next, let’s
clean up the column names in our data frame to make it easier for
colleagues to work with our code.</p>
<p>Let’s change the NDVI column name to <code>meanNDVI</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"meanNDVI"</span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                    meanNDVI
X005_HARV_ndvi_crop 0.365150
X037_HARV_ndvi_crop 0.242645
X085_HARV_ndvi_crop 0.251390
X133_HARV_ndvi_crop 0.599300
X181_HARV_ndvi_crop 0.878725
X197_HARV_ndvi_crop 0.893250</code></pre>
</div>
<p>The new column name doesn’t reminds us what site our data are from.
While we are only working with one site now, we might want to compare
several sites worth of data in the future. Let’s add a column to our
dataframe called “site”.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">site</span> <span class="op">&lt;-</span> <span class="st">"HARV"</span></span></code></pre>
</div>
<p>We can populate this column with the site name - HARV. Let’s also
create a year column and populate it with 2011 - the year our data were
collected.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="st">"2011"</span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                    meanNDVI site year
X005_HARV_ndvi_crop 0.365150 HARV 2011
X037_HARV_ndvi_crop 0.242645 HARV 2011
X085_HARV_ndvi_crop 0.251390 HARV 2011
X133_HARV_ndvi_crop 0.599300 HARV 2011
X181_HARV_ndvi_crop 0.878725 HARV 2011
X197_HARV_ndvi_crop 0.893250 HARV 2011</code></pre>
</div>
<p>We now have a dataframe that contains a row for each raster file
processed, and columns for <code>meanNDVI</code>, <code>site</code>, and
<code>year</code>.</p>
</section><section><h2 class="section-heading" id="extract-julian-day-from-row-names">Extract Julian Day from row names<a class="anchor" aria-label="anchor" href="#extract-julian-day-from-row-names"></a>
</h2>
<hr class="half-width">
<p>We’d like to produce a plot where Julian days (the numeric day of the
year, 0 - 365/366) are on the x-axis and NDVI is on the y-axis. To
create this plot, we’ll need a column that contains the Julian day
value.</p>
<p>One way to create a Julian day column is to use <code>gsub()</code>
on the file name in each row. We can replace both the <code>X</code> and
the <code>_HARV_NDVI_crop</code> to extract the Julian Day value, just
like we did in the <a href="13-plot-time-series-rasters-in-r/">previous
episode</a>.</p>
<p>This time we will use one additional trick to do both of these steps
at the same time. The vertical bar character ( <code>|</code> ) is
equivalent to the word “or”. Using this character in our search pattern
allows us to search for more than one pattern in our text strings.</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">julianDays</span> <span class="op">&lt;-</span> <span class="fu">gsub</span><span class="op">(</span><span class="st">"X|_HARV_ndvi_crop"</span>, <span class="st">""</span>, <span class="fu">row.names</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">julianDays</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] "005" "037" "085" "133" "181" "197" "213" "229" "245" "261" "277" "293"
[13] "309"</code></pre>
</div>
<p>Now that we’ve extracted the Julian days from our row names, we can
add that data to the data frame as a column called “julianDay”.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">julianDay</span> <span class="op">&lt;-</span> <span class="va">julianDays</span></span></code></pre>
</div>
<p>Let’s check the class of this new column:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">julianDay</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "character"</code></pre>
</div>
</section><section><h2 class="section-heading" id="convert-julian-day-to-date-class">Convert Julian Day to Date Class<a class="anchor" aria-label="anchor" href="#convert-julian-day-to-date-class"></a>
</h2>
<hr class="half-width">
<p>Currently, the values in the Julian day column are stored as class
<code>character</code>. Storing this data as a date object is better -
for plotting, data subsetting and working with our data. Let’s convert.
We worked with data conversions <a href="12-time-series-raster/">in an
earlier episode</a>. For an introduction to date-time classes, see the
NEON Data Skills tutorial <a href="https://www.neonscience.org/dc-convert-date-time-POSIX-r" class="external-link">Convert
Date &amp; Time Data from Character Class to Date-Time Class (POSIX) in
R</a>.</p>
<p>To convert a Julian day number to a date class, we need to set the
origin, which is the day that our Julian days start counting from. Our
data is from 2011 and we know that the USGS Landsat Team created Julian
day values for this year. Therefore, the first day or “origin” for our
Julian day count is 01 January 2011.</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">origin</span> <span class="op">&lt;-</span> <span class="fu">as.Date</span><span class="op">(</span><span class="st">"2011-01-01"</span><span class="op">)</span></span></code></pre>
</div>
<p>Next we convert the <code>julianDay</code> column from character to
integer.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">julianDay</span> <span class="op">&lt;-</span> <span class="fu">as.integer</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">julianDay</span><span class="op">)</span></span></code></pre>
</div>
<p>Once we set the Julian day origin, we can add the Julian day value
(as an integer) to the origin date.</p>
<p>Note that when we convert our integer class <code>julianDay</code>
values to dates, we subtracted 1. This is because the origin day is 01
January 2011, so the extracted day is 01. The Julian Day (or year day)
for this is also 01. When we convert from the integer 05
<code>julianDay</code> value (indicating 5th of January), we cannot
simply add <code>origin + julianDay</code> because
<code>01 + 05 = 06</code> or 06 January 2011. To correct, this error we
then subtract 1 to get the correct day, January 05 2011.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">Date</span><span class="op">&lt;-</span> <span class="va">origin</span> <span class="op">+</span> <span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">julianDay</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "2011-01-05" "2011-02-06" "2011-03-26" "2011-05-13" "2011-06-30"
[6] "2011-07-16"</code></pre>
</div>
<p>Since the origin date was originally set as a Date class object, the
new <code>Date</code> column is also stored as class
<code>Date</code>.</p>
<div class="codewrapper sourceCode" id="cb19">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">class</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "Date"</code></pre>
</div>
<div id="challenge-ndvi-for-the-san-joaquin-experimental-range" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-ndvi-for-the-san-joaquin-experimental-range" class="callout-inner">
<h3 class="callout-title">Challenge: NDVI for the San Joaquin Experimental Range</h3>
<div class="callout-content">
<p>We often want to compare two different sites. The National Ecological
Observatory Network (NEON) also has a field site in Southern California
at the <a href="https://www.neonscience.org/field-sites/field-sites-map/SJER" class="external-link">San
Joaquin Experimental Range (SJER)</a>.</p>
<p>For this challenge, create a dataframe containing the mean NDVI
values and the Julian days the data was collected (in date format) for
the NEON San Joaquin Experimental Range field site. NDVI data for SJER
are located in the <code>NEON-DS-Landsat-NDVI/SJER/2011/NDVI</code>
directory.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Answers
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>First we will read in the NDVI data for the SJER field site.</p>
<div class="codewrapper sourceCode" id="cb21">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_path_SJER</span> <span class="op">&lt;-</span> <span class="st">"data/NEON-DS-Landsat-NDVI/SJER/2011/NDVI"</span></span>
<span></span>
<span><span class="va">all_NDVI_SJER</span> <span class="op">&lt;-</span> <span class="fu">list.files</span><span class="op">(</span><span class="va">NDVI_path_SJER</span>,</span>
<span>                            full.names <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            pattern <span class="op">=</span> <span class="st">".tif$"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">NDVI_stack_SJER</span> <span class="op">&lt;-</span> <span class="fu">rast</span><span class="op">(</span><span class="va">all_NDVI_SJER</span><span class="op">)</span></span>
<span><span class="fu">names</span><span class="op">(</span><span class="va">NDVI_stack_SJER</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">paste0</span><span class="op">(</span><span class="st">"X"</span>, <span class="fu">names</span><span class="op">(</span><span class="va">NDVI_stack_SJER</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">NDVI_stack_SJER</span> <span class="op">&lt;-</span> <span class="va">NDVI_stack_SJER</span><span class="op">/</span><span class="fl">10000</span></span></code></pre>
</div>
<p>Then we can calculate the mean values for each day and put that in a
dataframe.</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_SJER</span> <span class="op">&lt;-</span> <span class="fu">as.data.frame</span><span class="op">(</span><span class="fu">global</span><span class="op">(</span><span class="va">NDVI_stack_SJER</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span></code></pre>
</div>
<p>Next we rename the NDVI column, and add site and year columns to our
data.</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">names</span><span class="op">(</span><span class="va">avg_NDVI_SJER</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"meanNDVI"</span></span>
<span><span class="va">avg_NDVI_SJER</span><span class="op">$</span><span class="va">site</span> <span class="op">&lt;-</span> <span class="st">"SJER"</span></span>
<span><span class="va">avg_NDVI_SJER</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="st">"2011"</span></span></code></pre>
</div>
<p>Now we will create our Julian day column</p>
<div class="codewrapper sourceCode" id="cb24">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">julianDays_SJER</span> <span class="op">&lt;-</span> <span class="fu">gsub</span><span class="op">(</span><span class="st">"X|_SJER_ndvi_crop"</span>, <span class="st">""</span>, <span class="fu">row.names</span><span class="op">(</span><span class="va">avg_NDVI_SJER</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">origin</span> <span class="op">&lt;-</span> <span class="fu">as.Date</span><span class="op">(</span><span class="st">"2011-01-01"</span><span class="op">)</span></span>
<span><span class="va">avg_NDVI_SJER</span><span class="op">$</span><span class="va">julianDay</span> <span class="op">&lt;-</span> <span class="fu">as.integer</span><span class="op">(</span><span class="va">julianDays_SJER</span><span class="op">)</span></span>
<span></span>
<span><span class="va">avg_NDVI_SJER</span><span class="op">$</span><span class="va">Date</span> <span class="op">&lt;-</span> <span class="va">origin</span> <span class="op">+</span> <span class="op">(</span><span class="va">avg_NDVI_SJER</span><span class="op">$</span><span class="va">julianDay</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_SJER</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                    meanNDVI site year julianDay       Date
X014_SJER_ndvi_crop 0.048216 SJER 2011        14 2011-01-14
X046_SJER_ndvi_crop 0.529780 SJER 2011        46 2011-02-15
X062_SJER_ndvi_crop 0.554368 SJER 2011        62 2011-03-03
X094_SJER_ndvi_crop 0.601096 SJER 2011        94 2011-04-04
X110_SJER_ndvi_crop 0.555836 SJER 2011       110 2011-04-20
X126_SJER_ndvi_crop 0.538336 SJER 2011       126 2011-05-06</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="plot-ndvi-using-ggplot">Plot NDVI Using ggplot<a class="anchor" aria-label="anchor" href="#plot-ndvi-using-ggplot"></a>
</h2>
<hr class="half-width">
<p>We now have a clean dataframe with properly scaled NDVI and Julian
days. Let’s plot our data.</p>
<div class="codewrapper sourceCode" id="cb26">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">julianDay</span>, <span class="va">meanNDVI</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat Derived NDVI - 2011"</span>, </span>
<span>          subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Julian Days"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean NDVI"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-ggplot-data-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-plot-san-joaquin-experimental-range-data" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-san-joaquin-experimental-range-data" class="callout-inner">
<h3 class="callout-title">Challenge: Plot San Joaquin Experimental Range Data</h3>
<div class="callout-content">
<p>Create a complementary plot for the SJER data. Plot the data points
in a different color.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Answers
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb27">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">avg_NDVI_SJER</span>, <span class="fu">aes</span><span class="op">(</span><span class="va">julianDay</span>, <span class="va">meanNDVI</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"SpringGreen4"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat Derived NDVI - 2011"</span>, subtitle <span class="op">=</span> <span class="st">"NEON SJER Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Julian Day"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean NDVI"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-avg-ndvi-sjer-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="compare-ndvi-from-two-different-sites-in-one-plot">Compare NDVI from Two Different Sites in One Plot<a class="anchor" aria-label="anchor" href="#compare-ndvi-from-two-different-sites-in-one-plot"></a>
</h2>
<hr class="half-width">
<p>Comparison of plots is often easiest when both plots are side by
side. Or, even better, if both sets of data are plotted in the same
plot. We can do this by merging the two data sets together. The date
frames must have the same number of columns and exact same column names
to be merged.</p>
<div class="codewrapper sourceCode" id="cb28">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NDVI_HARV_SJER</span> <span class="op">&lt;-</span> <span class="fu">rbind</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span>, <span class="va">avg_NDVI_SJER</span><span class="op">)</span></span></code></pre>
</div>
<p>Now we can plot both datasets on the same plot.</p>
<div class="codewrapper sourceCode" id="cb29">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">NDVI_HARV_SJER</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">julianDay</span>, y <span class="op">=</span> <span class="va">meanNDVI</span>, colour <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat Derived NDVI - 2011"</span>, </span>
<span>          subtitle <span class="op">=</span> <span class="st">"Harvard Forest vs San Joaquin"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Julian Day"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean NDVI"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-ndvi-harv-sjer-comp-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><div id="challenge-plot-ndvi-with-date" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-plot-ndvi-with-date" class="callout-inner">
<h3 class="callout-title">Challenge: Plot NDVI with date</h3>
<div class="callout-content">
<p>Plot the SJER and HARV data in one plot but use date, rather than
Julian day, on the x-axis.</p>
</div>
</div>
</div>
<div id="accordionSolution3" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution3" aria-expanded="false" aria-controls="collapseSolution3">
  <h4 class="accordion-header" id="headingSolution3">
  Answers
  </h4>
</button>
<div id="collapseSolution3" class="accordion-collapse collapse" data-bs-parent="#accordionSolution3" aria-labelledby="headingSolution3">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb30">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">NDVI_HARV_SJER</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">meanNDVI</span>, colour <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>group <span class="op">=</span> <span class="va">site</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat Derived NDVI - 2011"</span>, </span>
<span>          subtitle <span class="op">=</span> <span class="st">"Harvard Forest vs San Joaquin"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Date"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean NDVI"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-ndvi-harv-sjer-date-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure>
</div>
</div>
</div>
</div>
</section><section><h2 class="section-heading" id="remove-outlier-data">Remove Outlier Data<a class="anchor" aria-label="anchor" href="#remove-outlier-data"></a>
</h2>
<hr class="half-width">
<p>As we look at these plots we see variation in greenness across the
year. However, the pattern is interrupted by a few points where NDVI
quickly drops towards 0 during a time period when we might expect the
vegetation to have a higher greenness value. Is the vegetation truly
senescent or gone or are these outlier values that should be removed
from the data?</p>
<p>We’ve seen in <a href="12-time-series-raster/">an earlier episode</a>
that data points with very low NDVI values can be associated with images
that are filled with clouds. Thus, we can attribute the low NDVI values
to high levels of cloud cover. Is the same thing happening at SJER?</p>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-view-all-rgb-SJER-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Without significant additional processing, we will not be able to
retrieve a strong reflection from vegetation, from a remotely sensed
image that is predominantly cloud covered. Thus, these points are likely
bad data points. Let’s remove them.</p>
<p>First, we will identify the good data points that should be retained.
One way to do this is by identifying a threshold value. All values below
that threshold will be removed from our analysis. We will use 0.1 as an
example for this episode. We can then use the subset function to remove
outlier datapoints (below our identified threshold).</p>
<div id="data-tip" class="callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="data-tip" class="callout-inner">
<h3 class="callout-title">Data Tip</h3>
<div class="callout-content">
<p>Thresholding, or removing outlier data, can be tricky business. In
this case, we can be confident that some of our NDVI values are not
valid due to cloud cover. However, a threshold value may not always be
sufficient given that 0.1 could be a valid NDVI value in some areas.
This is where decision-making should be fueled by practical scientific
knowledge of the data and the desired outcomes!</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb31">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_HARV_clean</span> <span class="op">&lt;-</span> <span class="fu">subset</span><span class="op">(</span><span class="va">avg_NDVI_HARV</span>, <span class="va">meanNDVI</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">avg_NDVI_HARV_clean</span><span class="op">$</span><span class="va">meanNDVI</span> <span class="op">&lt;</span> <span class="fl">0.1</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code> [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE</code></pre>
</div>
<p>Now we can create another plot without the suspect data.</p>
<div class="codewrapper sourceCode" id="cb33">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">avg_NDVI_HARV_clean</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">julianDay</span>, y <span class="op">=</span> <span class="va">meanNDVI</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Landsat Derived NDVI - 2011"</span>, </span>
<span>          subtitle <span class="op">=</span> <span class="st">"NEON Harvard Forest Field Site"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">"Julian Days"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ylab</span><span class="op">(</span><span class="st">"Mean NDVI"</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="fig/14-extract-ndvi-from-rasters-in-r-rendered-plot-clean-HARV-1.png" style="display: block; margin: auto;" class="figure mx-auto d-block"></figure><p>Now our outlier data points are removed and the pattern of “green-up”
and “brown-down” makes more sense.</p>
</section><section><h2 class="section-heading" id="write-ndvi-data-to-a--csv-file">Write NDVI data to a .csv File<a class="anchor" aria-label="anchor" href="#write-ndvi-data-to-a--csv-file"></a>
</h2>
<hr class="half-width">
<p>We can write our final NDVI dataframe out to a text format, to
quickly share with a colleague or to reuse for analysis or visualization
purposes. We will export in Comma Seperated Value (.csv) file format
because it is usable in many different tools and across platforms (MAC,
PC, etc).</p>
<p>We will use <code>write.csv()</code> to write a specified dataframe
to a <code>.csv</code> file. Unless you designate a different directory,
the output file will be saved in your working directory.</p>
<p>Before saving our file, let’s view the format to make sure it is what
we want as an output format.</p>
<div class="codewrapper sourceCode" id="cb34">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV_clean</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>                    meanNDVI site year julianDay       Date
X005_HARV_ndvi_crop 0.365150 HARV 2011         5 2011-01-05
X037_HARV_ndvi_crop 0.242645 HARV 2011        37 2011-02-06
X085_HARV_ndvi_crop 0.251390 HARV 2011        85 2011-03-26
X133_HARV_ndvi_crop 0.599300 HARV 2011       133 2011-05-13
X181_HARV_ndvi_crop 0.878725 HARV 2011       181 2011-06-30
X197_HARV_ndvi_crop 0.893250 HARV 2011       197 2011-07-16</code></pre>
</div>
<p>It looks like we have a series of <code>row.names</code> that we do
not need because we have this information stored in individual columns
in our data frame. Let’s remove the row names.</p>
<div class="codewrapper sourceCode" id="cb36">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">row.names</span><span class="op">(</span><span class="va">avg_NDVI_HARV_clean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_HARV_clean</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  meanNDVI site year julianDay       Date
1 0.365150 HARV 2011         5 2011-01-05
2 0.242645 HARV 2011        37 2011-02-06
3 0.251390 HARV 2011        85 2011-03-26
4 0.599300 HARV 2011       133 2011-05-13
5 0.878725 HARV 2011       181 2011-06-30
6 0.893250 HARV 2011       197 2011-07-16</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb38">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write.csv</span><span class="op">(</span><span class="va">avg_NDVI_HARV_clean</span>, file<span class="op">=</span><span class="st">"meanNDVI_HARV_2011.csv"</span><span class="op">)</span></span></code></pre>
</div>
<div id="challenge-write-to-.csv" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-write-to-.csv" class="callout-inner">
<h3 class="callout-title">Challenge: Write to .csv</h3>
<div class="callout-content">
<ol style="list-style-type: decimal">
<li>Create a NDVI .csv file for the NEON SJER field site that is
comparable with the one we just created for the Harvard Forest. Be sure
to inspect for questionable values before writing any data to a .csv
file.</li>
<li>Create a NDVI .csv file that includes data from both field
sites.</li>
</ol>
</div>
</div>
</div>
<div id="accordionSolution4" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution4" aria-expanded="false" aria-controls="collapseSolution4">
  <h4 class="accordion-header" id="headingSolution4">
  Answers
  </h4>
</button>
<div id="collapseSolution4" class="accordion-collapse collapse" data-bs-parent="#accordionSolution4" aria-labelledby="headingSolution4">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb39">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avg_NDVI_SJER_clean</span> <span class="op">&lt;-</span> <span class="fu">subset</span><span class="op">(</span><span class="va">avg_NDVI_SJER</span>, <span class="va">meanNDVI</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu">row.names</span><span class="op">(</span><span class="va">avg_NDVI_SJER_clean</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="fu">head</span><span class="op">(</span><span class="va">avg_NDVI_SJER_clean</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>  meanNDVI site year julianDay       Date
1 0.529780 SJER 2011        46 2011-02-15
2 0.554368 SJER 2011        62 2011-03-03
3 0.601096 SJER 2011        94 2011-04-04
4 0.555836 SJER 2011       110 2011-04-20
5 0.538336 SJER 2011       126 2011-05-06
6 0.400868 SJER 2011       142 2011-05-22</code></pre>
</div>
<div class="codewrapper sourceCode" id="cb41">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">write.csv</span><span class="op">(</span><span class="va">avg_NDVI_SJER_clean</span>, file <span class="op">=</span> <span class="st">"meanNDVI_SJER_2011.csv"</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Key Points</h3>
<div class="callout-content">
<ul>
<li>Use the <code>global()</code> function to calculate summary
statistics for cells in a raster object.</li>
<li>The pipe (<code>|</code>) operator means <code>or</code>.</li>
<li>Use the <code>rbind()</code> function to combine data frames that
have the same column names.</li>
</ul>
</div>
</div>
</div>
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
        <p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>

        <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/edit/main/README.md" class="external-link">Edit on GitHub</a>

	
        | <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a>
        | <a href="https://github.com/datacarpentry/r-raster-vector-geospatial/" class="external-link">Source</a></p>
				<p><a href="https://github.com/datacarpentry/r-raster-vector-geospatial/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:team@carpentries.org">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">

        <p>Materials licensed under <a href="LICENSE.html">CC-BY 4.0</a> by the authors</p>

        <p>Template licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">CC-BY 4.0</a> by <a href="https://carpentries.org/" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.16.12" class="external-link">sandpaper (0.16.12)</a>, <a href="https://github.com/carpentries/pegboard/tree/0.7.9" class="external-link">pegboard (0.7.9)</a>, and <a href="https://github.com/carpentries/varnish/tree/1.0.6" class="external-link">varnish (1.0.6)</a></p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
      <i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back To Top"></i><br><!-- <span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top --><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "LearningResource",
  "@id": "https://datacarpentry.org/r-raster-vector-geospatial/aio.html",
  "inLanguage": "en",
  "dct:conformsTo": "https://bioschemas.org/profiles/LearningResource/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "software, data, lesson, The Carpentries",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://datacarpentry.org/r-raster-vector-geospatial/aio.html",
  "identifier": "https://datacarpentry.org/r-raster-vector-geospatial/aio.html",
  "dateCreated": "2015-10-22",
  "dateModified": "2025-06-17",
  "datePublished": "2025-06-17"
}

  </script><script>
		feather.replace();
	</script>
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

