---
title: "Handling Spatial Projection & CRS in R"
teaching: 20
exercises: 10
questions:
- "What to do when vector data don't line up."
objectives:
- "Know how to identify the `CRS` of a spatial dataset."
- "Be familiar with geographic vs. projected coordinate reference systems."
- "Be familiar with the `proj4` string format which is one format used used to store / reference the `CRS` of a spatial object."
keypoints:
- ""
---

```{r setup, echo=FALSE}
source("../bin/chunk-options.R")
source("../setup.R")
knitr_fig_path("09-")
```

```{r load-libraries, echo = FALSE, results='hide'}
library(raster)
library(rgdal)
library(sf)
library(ggplot2)
library(dplyr)
```

> ## Things Youâ€™ll Need To Complete This Episode
> See the [lesson homepage]({{ site.baseurl }}) for detailed information about the software,
> data, and other prerequisites you will need to work through the examples in this episode.
{: .prereq}

In [an earlier episode]({{ site.baseurl }}/03-raster-reproject-in-r/)
we learned how to handle a situation where you have two different
files with raster data in different projections.

Now we will apply those same principles to working with vector data.
We will create a base map of our study site using United States
state and country boundary information accessed from the
<a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html" target="_blank"> United States Census Bureau</a>.
We will learn how to map vector data that are in different `CRS`s and thus
don't line up on a map.

We will continue to work with the three shapefiles that we loaded in the
[Open and Plot Shapefiles in R]({{site.baseurl}}/06-vector-open-shapefile-in-r/) episode.

```{r load-data, echo = FALSE, results='hide', warning=FALSE}
aoi_boundary_HARV <- st_read("data/NEON-DS-Site-Layout-Files/HARV/HarClip_UTMZ18.shp")

lines_HARV <- st_read("data/NEON-DS-Site-Layout-Files/HARV/HARV_roads.shp")

point_HARV <- st_read("data/NEON-DS-Site-Layout-Files/HARV/HARVtower_UTM18N.shp")

chm_HARV <-
raster("data/NEON-DS-Airborne-Remote-Sensing/HARV/CHM/HARV_chmCrop.tif")
```

## Working With Spatial Data From Different Sources

To support a project, we often need to gather spatial datasets from
different sources and/or data that cover different spatial `extents`. These data are often in
different Coordinate Reference Systems (CRS).

Some reasons for data being in different CRS include:

1. The data are stored in a particular CRS convention used by the data
provider (for example, a government agency).
2. The data are stored in a particular CRS that is customized to a region.
For instance, many states in the US prefer to use a State Plane projection customized
for that state.

<figure>
    <a href="https://media.opennews.org/cache/06/37/0637aa2541b31f526ad44f7cb2db7b6c.jpg">
    <img src="https://media.opennews.org/cache/06/37/0637aa2541b31f526ad44f7cb2db7b6c.jpg">
    </a>

    <figcaption>Maps of the United States using data in different projections.
    Notice the differences in shape associated with each different projection.
    These differences are a direct result of the calculations used to "flatten"
    the data onto a 2-dimensional map. Often data are stored purposefully in a
    particular projection that optimizes the relative shape and size of
    surrounding geographic boundaries (states, counties, countries, etc).
    Source: opennews.org</figcaption>
</figure>

In this episode we will learn how to identify and manage spatial data
in different projections. We will learn how to `reproject` the data so that they
are in the same projection to support plotting / mapping. Note that these skills
are also required for any geoprocessing / spatial analysis. Data need to be in
the same CRS to ensure accurate results.

We will continue to use the `sf` and `raster` packages in this episode.

## Import US Boundaries - Census Data

There are many good sources of boundary base layers that we can use to create a
basemap. Some `R` packages even have these base layers built in to support quick
and efficient mapping. In this episode, we will use boundary layers for the
United States, provided by the
<a href="https://www.census.gov/geo/maps-data/data/cbf/cbf_state.html" target="_blank"> United States Census Bureau.</a>

It is useful to have shapefiles to work with because we can add additional
attributes to them if need be - for project specific mapping.

## Read US Boundary File

We will use the `st_read()` function to import the
`/US-Boundary-Layers/US-State-Boundaries-Census-2014` layer into `R`. This layer
contains the boundaries of all contiguous states in the U.S. Please note that
these data have been modified and reprojected from the original data downloaded
from the Census website to support the learning goals of this episode.

```{r read-shp }
state_boundary_US <- st_read("data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-State-Boundaries-Census-2014.shp")
```

Next, let's plot the U.S. states data.

```{r find-coordinates }
ggplot() +
    geom_sf(data=state_boundary_US) +
    ggtitle("Map of Continental US State Boundaries\n US Census Bureau Data")
```

## U.S. Boundary Layer


We can add a boundary layer of the United States to our map - to make it look
nicer. We will import
`NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States`.
If we specify a thicker line width using `lwd = 4` for the border layer, it will
make our map pop!

```{r check-out-coordinates }
# Read the .csv file
country_boundary_US <- st_read("data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/US-Boundary-Dissolved-States.shp")

ggplot() + 
    geom_sf(data=country_boundary_US, color="gray18", size=2) +
    geom_sf(data=state_boundary_US, color="gray40") +
    ggtitle("Map of Continental US State Boundaries\n US Census Bureau Data")

```

Next, let's add the location of a flux tower where our study area is.
As we are adding these layers, take note of the class of each object.

```{r explore-units}
# plot point - looks ok?
ggplot() +
    geom_sf(data=point_HARV, shape=19, color="purple") +
    ggtitle("Harvard Fisher Tower Location")
```

The plot above demonstrates that the tower point location data is readable and
will plot! Let's next add it as a layer on top of the U.S. states and boundary
layers in our basemap plot.

``` {r layer-point-on-states }
ggplot() +
    # plot state boundaries
    geom_sf(data=country_boundary_US, size=2, color="gray18") +
    # add US border outline
    geom_sf(data=state_boundary_US, color="gray40") +
    # add point tower location
    geom_sf(data=point_HARV, shape=19, color="purple") +
    ggtitle("Map of Continental US State Boundaries\n with Tower Location")
```

What do you notice about the resultant plot? Do you see the tower location in
purple in the Massachusetts area? No! What went wrong?

Let's check out the CRS (`st_crs()`) of both datasets to see if we can identify any
issues that might cause the point location to not plot properly on top of our
U.S. boundary layers.

First we'll look at the CRS of our study site.

```{r crs-sleuthing-1}
st_crs(point_HARV)
```

Then we'll look at the CRS of the US map data.

```{r crs-sleuthing-2}
st_crs(state_boundary_US)
st_crs(country_boundary_US)
```

It looks like our data are in different CRS. We can tell this by looking at
the CRS strings in `proj4` format. We discussed the `proj4` format
in [an earlier episode]({{site.baseurl}}/01-raster-structure/).

### UTM Proj4 String
Our project string for `DSM_HARV` specifies the UTM projection as follows:

`+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0`

* **proj=utm:** the projection is UTM, UTM has several zones.
* **zone=18:** the zone is 18
* **datum=WGS84:** the datum WGS84 (the datum refers to the  0,0 reference for
the coordinate system used in the projection)
* **units=m:** the units for the coordinates are in METERS.
* **ellps=WGS84:** the ellipsoid (how the earth's  roundness is calculated) for
the data is WGS84

Note that the `zone` is unique to the UTM projection. Not all CRS will have a
zone.

### Geographic (lat / long) Proj4 String

Our project string for `state_boundary_US` and `country_boundary_US` specifies
the lat/long projection as follows:

`+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0`

* **proj=longlat:** the data are in a geographic (latitude and longitude)
coordinate system
* **datum=WGS84:** the datum WGS84 (the datum refers to the  0,0 reference for
the coordinate system used in the projection)
* **ellps=WGS84:** the ellipsoid (how the earth's roundness is calculated)
is WGS84

Note that there are no specified units above. This is because this geographic
coordinate reference system is in latitude and longitude which is most
often recorded in decimal degrees.

> ## Data Tip
> the last portion of each `proj4` string
> is `+towgs84=0,0,0 `. This is a conversion factor that is used if a datum
> conversion is required. We will not deal with datums in this episode series.
{: .callout}

## CRS Units - View Object Extent

Next, let's view the extent or spatial coverage for the `point_HARV` spatial
object compared to the `state_boundary_US` object.

First we'll look at the extent for our study site:

```{r view-extent-1}
st_bbox(point_HARV)
```

And then the extent for the state boundary data.

```{r view-extent-2}
st_bbox(state_boundary_US)
```

Note the difference in the units for each object. The extent for
`state_boundary_US` is in latitude and longitude which yields smaller numbers
representing decimal degree units. Our tower location point is in UTM, is
represented in meters.

> ## Proj4 & CRS Resources
> * <a href="http://proj.maptools.org/faq.html" target="_blank">More information on the proj4 format.</a>
> * <a href="http://spatialreference.org" target="_blank">A fairly comprehensive list of CRS by format.</a>
> * To view a list of datum conversion factors type: `projInfo(type = "datum")`
into the `R` console.
{: .callout}

## Reproject Vector Data

Now we know our data are in different CRSs. To address this, we have to modify
or reproject the data so they are all in the same CRS. We can use
`st_transform()` function to reproject our data. When we reproject the data, we
specify the CRS that we wish to transform our data to. This CRS contains
the datum, units and other information that `R` needs to reproject our data.

The `st_transform()` function requires two inputs:

1. the name of the object that you wish to transform
2. the CRS that you wish to transform that object too. In this case we can
use the `st_crs()` of the `state_boundary_US` object as follows:
`st_crs(state_boundary_US)`

> ## Data Tip
> `st_transform()` will only work if your
> original spatial object has a CRS assigned to it AND if that CRS is the
> correct CRS!
{: .callout}

Next, let's reproject our point layer into the geographic - latitude and
longitude `WGS84` coordinate reference system (CRS).

First we will reproject the data and check the CRS of the new object.

```{r crs-st_tranform }

point_HARV_WGS84 <- st_transform(point_HARV,
                                st_crs(state_boundary_US))

st_crs(point_HARV_WGS84)
```

We can also double check the extent of the new object to make sure
it looks like decimal degrees.

```{r}
st_bbox(point_HARV_WGS84)
```

Once our data are reprojected, we can try to plot again.

```{r plot-again }
ggplot() +
    # plot state boundaries
    geom_sf(data=country_boundary_US, size=2, color="gray18") +
    # add US border outline
    geom_sf(data=state_boundary_US, color="gray40") +
    # add point tower location
    geom_sf(data=point_HARV_WGS84, shape=19, color="purple") +
    ggtitle("Map of Continental US State Boundaries\n with Tower Location")
```

Reprojecting our data ensured that things line up on our map! It will also
allow us to perform any required geoprocessing (spatial calculations /
transformations) on our data.

> ## Challenge - Reproject Spatial Data
> 
> Create a map of the North Eastern United States as follows:
> 
> 1. Import and plot `Boundary-US-State-NEast.shp`. Adjust line width as necessary.
> 2. **Reproject** the layer into UTM zone 18 north.
> 3. Layer the Fisher Tower point location `point_HARV` on top of the above plot.
> 4. Add a **title** to your plot.
> 5. Add a **legend** to your plot that shows both the state boundary (line) and
> the Tower location point.
> 
> > ## Answers
> > 
> > ```{r challenge-code-MASS-Map,  include=TRUE, results="hide", echo=TRUE, warning=FALSE}
> > # import mass boundary layer
> > # read the .csv file
> > NE.States.Boundary.US <- st_read("data/NEON-DS-Site-Layout-Files/US-Boundary-Layers/Boundary-US-State-NEast.shp")
> > # view crs
> > st_crs(NE.States.Boundary.US)
> > 
> > # create CRS object
> > UTM_CRS <- st_crs(point_HARV)
> > UTM_CRS
> > 
> > # reproject line and point data
> > NE.States.Boundary.US.UTM  <- st_transform(NE.States.Boundary.US,
> >                                 UTM_CRS)
> > NE.States.Boundary.US.UTM
> > 
> > # to create a custom legend, we need to fake it
> > ggplot() +
> >     # plot state boundaries
> >     # note the use of an aesthetic, `aes`, which will allow you to customize your legend
> >     geom_sf(data=NE.States.Boundary.US.UTM, size=1, aes(color="color"), show.legend="line") +
> >     # `scale_xx_manual` allows you to customize your legend
> >     # note how the values correspond to the aesthetic
> >     scale_color_manual(name="", labels="State Boundary", values=c("color"="gray18")) +
> >     # add point tower location, and customize legend as before
> >     geom_sf(data=point_HARV, aes(shape="shape"), color="purple") +
> >     scale_shape_manual(name="", labels="Fisher Tower", values=c("shape"=19)) +
> >     ggtitle("Map of Northeastern US\n With Fisher Tower Location - UTM Zone 18N") +
> >     # you can customize the legend's appearance with `theme`
> >     theme(legend.position="bottom",
> >           legend.background = element_rect(color = NA)) 
> > 
> > 
> > ```
> {: .solution}
{: .challenge}
